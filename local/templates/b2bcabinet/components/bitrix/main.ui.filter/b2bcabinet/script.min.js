this.BX=this.BX||{},function(t,e){"use strict";function i(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="main-ui-filter-additional-fields-container"></div>\n\t\t\t']);return i=function(){return t},t}BX.namespace("BX.Main.ui.block"),BX.Main.ui.block["date-group"]=function(t){var e,i,s,n,a;return e={block:"main-ui-control-field-group",name:t.name+"_datesel",mix:"mix"in t?t.mix:null,attrs:{"data-type":"type"in t?t.type:"","data-name":"name"in t?t.name:"","data-time":t.enableTime},content:[]},"label"in t&&BX.type.isNotEmptyString(t.label)&&(n={block:"main-ui-control-field-label",tag:"span",attrs:{title:t.label},content:t.label},e.content.push(n)),i={block:"main-ui-control-field",dragButton:!1,content:{block:"main-ui-select",tabindex:"tabindex"in t?t.tabindex:"",value:"value"in t?t.value:"",items:"items"in t?t.items:"",name:"name"in t?t.name+"_datesel":"",params:"params"in t?t.params:"",valueDelete:!1}},e.content.push(i),"content"in t&&BX.type.isArray(t.content)&&t.content.forEach(function(t){e.content.push(t)}),"content"in t&&(BX.type.isPlainObject(t.content)||BX.type.isNotEmptyString(t.content))&&e.content.push(t.content),s={block:"main-ui-item-icon-container",content:{block:"main-ui-item-icon",mix:["main-ui-delete","main-ui-filter-field-delete"],tag:"span",attrs:{title:"deleteTitle"in t&&t.deleteTitle?t.deleteTitle:""}}},e.content.push(s),"dragButton"in t&&!1===t.dragButton||(a={block:"main-ui-filter-icon-grab",mix:["main-ui-item-icon"],tag:"span",attrs:{title:"dragTitle"in t&&t.dragTitle?t.dragTitle:""}},e.content.push(a)),e},BX.namespace("BX.Main.ui.block"),BX.Main.ui.block["main-ui-control-field"]=function(t){var e,i,s,n,a;return e={block:"main-ui-control-field",mix:"mix"in t?t.mix:null,attrs:{"data-type":"type"in t?t.type:"","data-name":"name"in t?t.name:""},content:[]},"label"in t&&BX.type.isNotEmptyString(t.label)&&(n={block:"main-ui-control-field-label",tag:"span",attrs:{title:t.label},content:t.label},e.content.push(n)),BX.type.isArray(t.content)?t.content.forEach(function(t){e.content.push(t)}):(BX.type.isPlainObject(t.content)||BX.type.isNotEmptyString(t.content))&&e.content.push(t.content),"valueDelete"in t&&!0===t.valueDelete&&(s={block:"main-ui-control-value-delete",content:{block:"main-ui-control-value-delete-item",tag:"span"}},e.content.push(s)),"deleteButton"in t&&!0===t.deleteButton&&(i={block:"main-ui-item-icon-container",content:{block:"main-ui-item-icon",mix:["main-ui-delete","main-ui-filter-field-delete"],tag:"span",attrs:{title:"deleteTitle"in t&&t.deleteTitle?t.deleteTitle:""}}},e.content.push(i)),"dragButton"in t&&!1===t.dragButton||(a={block:"main-ui-filter-icon-grab",mix:["main-ui-item-icon"],tag:"span",attrs:{title:"dragTitle"in t&&t.dragTitle?t.dragTitle:""}},e.content.push(a)),e},BX.namespace("BX.Main.ui.block"),BX.Main.ui.block["main-ui-control-field-group"]=function(t){var e,i,s,n;return e={block:"main-ui-control-field-group",mix:"mix"in t?t.mix:null,attrs:{"data-type":"type"in t?t.type:"","data-name":"name"in t?t.name:""},content:[]},"label"in t&&BX.type.isNotEmptyString(t.label)&&(s={block:"main-ui-control-field-label",tag:"span",attrs:{title:t.label},content:t.label},e.content.push(s)),BX.type.isArray(t.content)?t.content.forEach(function(t){e.content.push(t)}):(BX.type.isPlainObject(t.content)||BX.type.isNotEmptyString(t.content))&&e.content.push(t.content),"deleteButton"in t&&!0===t.deleteButton&&(i={block:"main-ui-item-icon-container",content:{block:"main-ui-item-icon",mix:["main-ui-delete","main-ui-filter-field-delete"],tag:"span",attrs:{title:"deleteTitle"in t&&t.deleteTitle?t.deleteTitle:""}}},e.content.push(i)),"dragButton"in t&&!1===t.dragButton||(n={block:"main-ui-filter-icon-grab",mix:["main-ui-item-icon"],tag:"span",attrs:{title:"dragTitle"in t&&t.dragTitle?t.dragTitle:""}},e.content.push(n)),e},BX.namespace("BX.Main.ui.block"),BX.Main.ui.block["main-ui-control-string"]=function(t){return{block:"main-ui-control-string",mix:["main-ui-control"],tag:"input",attrs:{type:"type"in t?t.type:"text",name:"name"in t?t.name:"",placeholder:"placeholder"in t?t.placeholder:"",tabindex:"tabindex"in t?t.tabindex:"",value:"value"in t?t.value:""}}},BX.namespace("BX.Main.ui.block"),BX.Main.ui.block["main-ui-control-textarea"]=function(t){return{block:"main-ui-control-string",mix:["main-ui-control main-ui-control-textarea"],tag:"textarea",attrs:{name:"name"in t?t.name:"",placeholder:"placeholder"in t?t.placeholder:"",tabindex:"tabindex"in t?t.tabindex:""},content:"value"in t?t.value:""}},BX.namespace("BX.Main.ui.block"),BX.Main.ui.block["main-ui-filter-field-list-item"]=function(t){var e={block:"main-ui-select-inner-label",content:"label"in t?t.label:""};return{block:"main-ui-filter-field-list-item",mix:"main-ui-select-inner-item",attrs:{"data-id":t.id,"data-name":t.name,"data-item":"item"in t?JSON.stringify(t.item):{}},events:{click:"onClick"in t?t.onClick:""},content:e}},BX.namespace("BX.Main.ui.block"),BX.Main.ui.block["main-ui-filter-info"]=function(t){return{block:"main-ui-filter-info",tag:"span",content:t.content,attrs:{title:t.title}}},BX.namespace("BX.Main.ui.block"),BX.Main.ui.block["main-ui-number"]=function(t){var e,i,s;return e={block:"main-ui-number",mix:["main-ui-control"],content:[]},"mix"in t&&BX.type.isArray(t.mix)&&t.mix.forEach(function(t){e.mix.push(t)}),i={block:"main-ui-number-input",mix:["main-ui-control-input"],tag:"input",attrs:{type:"number",name:"name"in t?t.name:"",tabindex:"tabindex"in t?t.tabindex:"",value:"value"in t?t.value:"",placeholder:"placeholder"in t?t.placeholder:"",autocomplete:"off"}},e.content.push(i),"valueDelete"in t&&!0===t.valueDelete&&(s={block:"main-ui-control-value-delete",content:{block:"main-ui-control-value-delete-item",tag:"span"}},e.content.push(s)),e},BX.namespace("BX.Main.ui.block"),BX.Main.ui.block["main-ui-search-square"]=function(t){var e=["main-ui-filter-search-square"];return"isPreset"in t&&t.isPreset&&e.push("main-ui-filter-search-square-preset"),{block:"main-ui-square",mix:e,attrs:{"data-item":"item"in t?JSON.stringify(t.item):"",title:"title"in t?t.title:""},content:[{block:"main-ui-square-item",content:"name"in t?BX.util.htmlspecialcharsback(t.name):""},{block:"main-ui-square-delete",mix:["main-ui-item-icon"]}]}},BX.namespace("BX.Main.ui.block"),BX.Main.ui.block["number-group"]=function(t){var e,i,s,n,a;return e={block:"main-ui-control-field-group",name:"name"in t?t.name+"_numsel":"",mix:"mix"in t?t.mix:null,attrs:{"data-type":"type"in t?t.type:"","data-name":"name"in t?t.name:""},content:[]},"label"in t&&BX.type.isNotEmptyString(t.label)&&(n={block:"main-ui-control-field-label",tag:"span",attrs:{title:t.label},content:t.label},e.content.push(n)),i={block:"main-ui-control-field",dragButton:!1,content:{block:"main-ui-select",tabindex:"tabindex"in t?t.tabindex:"",value:"value"in t?t.value:"",items:"items"in t?t.items:"",name:"name"in t?t.name+"_numsel":"",params:"params"in t?t.params:"",valueDelete:!1}},e.content.push(i),"content"in t&&BX.type.isArray(t.content)&&t.content.forEach(function(t){e.content.push(t)}),"content"in t&&(BX.type.isPlainObject(t.content)||BX.type.isNotEmptyString(t.content))&&e.content.push(t.content),s={block:"main-ui-item-icon-container",content:{block:"main-ui-item-icon",mix:["main-ui-delete","main-ui-filter-field-delete"],tag:"span",attrs:{title:"deleteTitle"in t&&t.deleteTitle?t.deleteTitle:""}}},e.content.push(s),"dragButton"in t&&!1===t.dragButton||(a={block:"main-ui-filter-icon-grab",mix:["main-ui-item-icon"],tag:"span",attrs:{title:"dragTitle"in t&&t.dragTitle?t.dragTitle:""}},e.content.push(a)),e},BX.namespace("BX.Main.ui.block"),BX.Main.ui.block["sidebar-item"]=function(t){return{block:"main-ui-filter-sidebar-item"+("pinned"in t&&t.pinned?" main-ui-item-pin":""),attrs:{"data-id":"id"in t?t.id:""},content:[{block:"main-ui-filter-icon-grab",tag:"span",mix:["main-ui-item-icon"],attrs:{title:"dragTitle"in t&&t.dragTitle?t.dragTitle:""}},{block:"main-ui-filter-sidebar-item-text-container",tag:"span",content:[{block:"main-ui-filter-sidebar-item-input",tag:"input",attrs:{type:"text",placeholder:"placeholder"in t?t.placeholder:"",value:"text"in t?BX.util.htmlspecialchars(BX.util.htmlspecialcharsback(t.text)):""}},{block:"main-ui-filter-sidebar-item-text",tag:"span",content:"text"in t?t.text:""},{block:"main-ui-filter-icon-pin",tag:"span",mix:["main-ui-item-icon"],attrs:{title:"noEditPinTitle"in t&&t.noEditPinTitle?t.noEditPinTitle:""}}]},{block:"main-ui-filter-icon-edit",tag:"span",mix:["main-ui-item-icon"],attrs:{title:"editNameTitle"in t&&t.editNameTitle?t.editNameTitle:""}},{block:"main-ui-delete",tag:"span",mix:["main-ui-item-icon"],attrs:{title:"removeTitle"in t&&t.removeTitle?t.removeTitle:""}},{block:"main-ui-filter-icon-pin",tag:"span",mix:["main-ui-item-icon"],attrs:{title:"editPinTitle"in t&&t.editPinTitle?t.editPinTitle:""}},{block:"main-ui-filter-edit-mask"}]}},BX.namespace("BX.Filter"),BX.Filter.Utils={cache:{},styleForEach:function(t,e){var i;e=BX.type.isPlainObject(e)?e:null,i=Object.keys(e),[].forEach.call(t||[],function(t){i.forEach(function(i){BX.style(t,i,e[i])})})},closestParent:function(t,e){if(t)return e?BX.findParent(t,{className:e}):t.parentNode||null},closestChilds:function(t){return t?t.children:null},getNext:function(t){return t?t.nextElementSibling:null},getPrev:function(t){return t?t.previousElementSibling:null},collectionSort:function(t,e){var i,s,n,a,r;t&&e&&t!==e&&t.parentNode===e.parentNode&&(i=this.closestParent(e),n=(s=this.closestChilds(i)).length,a=this.getIndex(s,t),n===(r=this.getIndex(s,e))&&i.appendChild(e),a>r&&i.insertBefore(t,e),a<r&&n!==r&&i.insertBefore(t,this.getNext(e)))},getIndex:function(t,e){return[].indexOf.call(t||[],e)},getByClass:function(t,e,i){var s=[];return e&&(s=(t||document.body).getElementsByClassName(e),s=i?[].slice.call(s):s.length?s[0]:null),s},getByTag:function(t,e,i){var s=[];return e&&(s=(t||document.body).getElementsByTagName(e),s=i?[].slice.call(s):s.length?s[0]:null),s},getBySelector:function(t,e,i){var s=[];return e&&(i?(s=(t||document.body).querySelectorAll(e),s=[].slice.call(s)):s=(t||document.body).querySelector(e)),s},requestAnimationFrame:function(){(window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||window.oRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)}).apply(window,arguments)},sortObject:function(t){var e={};return Object.keys(t).sort().forEach(function(i){e[i]=t[i]}),e},objectsIsEquals:function(t,e){return JSON.stringify(t)===JSON.stringify(e)},isKey:function(t,e){var i={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",27:"escape",32:"space",37:"leftArrow",38:"upArrow",39:"rightArrow",40:"downArrow",46:"delete",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",65:"a"},s=t?"keyCode"in t?t.keyCode:"which"in t?t.which:0:0;return s in i&&i[s]===e}},BX.namespace("BX.Filter"),BX.Filter.DestinationSelectorManager={fields:[],controls:{},onSelect:function(t,e,i){if(BX.type.isNotEmptyObject(i)&&BX.type.isNotEmptyObject(i.item)&&BX.type.isNotEmptyString(i.selectorId)){var s=i.selectorId,n=i.item,a=BX.Filter.DestinationSelectorManager.controls[s];if(a){var r=n.id;if(BX.type.isNotEmptyString(t)&&"Y"==t&&BX.type.isNotEmptyString(e)){var l=new RegExp("^"+e+"(\\d+)$"),o=r.match(l);BX.type.isArray(o)&&(r=o[1])}else{var u={};BX.onCustomEvent(window,"BX.Filter.DestinationSelector:convert",[{selectorId:s,value:r},u]),BX.type.isNotEmptyString(u.value)&&(r=u.value)}a.setData(BX.util.htmlspecialcharsback(n.name),r),a.getLabelNode().value="",a.getLabelNode().blur()}}},onDialogOpen:function(t){if(void 0!==t&&BX.type.isNotEmptyString(t.selectorId)){var e=t.selectorId,i=BX.Filter.DestinationSelector.items[e];i&&i.onDialogOpen()}},onDialogClose:function(t){if(void 0!==t&&BX.type.isNotEmptyString(t.selectorId)){var e=t.selectorId,i=BX.Filter.DestinationSelector.items[e];i&&i.onDialogClose()}}},BX.Filter.DestinationSelector=function(){this.id="",this.filterId="",this.settings={},this.fieldId="",this.control=null,this.inited=null},BX.Filter.DestinationSelector.items={},BX.Filter.DestinationSelector.create=function(t,e){if(void 0!==this.items[t])return this.items[t];var i=new BX.Filter.DestinationSelector(t,e);return i.initialize(t,e),this.items[t]=i,BX.onCustomEvent(window,"BX.Filter.DestinationSelector:create",[t]),i},BX.Filter.DestinationSelector.prototype.getSetting=function(t,e){return this.settings.hasOwnProperty(t)?this.settings[t]:e},BX.Filter.DestinationSelector.prototype.getSearchInput=function(){return this.control?this.control.getLabelNode():null},BX.Filter.DestinationSelector.prototype.initialize=function(t,e){this.id=t,this.settings=e||{},this.fieldId=this.getSetting("fieldId",""),this.filterId=this.getSetting("filterId",""),this.inited=!1,this.opened=null;var i=this.getSetting("initialValue",!1);if(i){var s={};s[this.fieldId]=i.itemId,s[this.fieldId+"_label"]=i.itemName,BX.Main.filterManager.getById(this.filterId).getApi().setFields(s)}BX.addCustomEvent(window,"BX.Main.Filter:customEntityFocus",BX.delegate(this.onCustomEntitySelectorOpen,this)),BX.addCustomEvent(window,"BX.Main.Filter:customEntityBlur",BX.delegate(this.onCustomEntitySelectorClose,this)),BX.addCustomEvent(window,"BX.Main.Filter:onGetStopBlur",BX.delegate(this.onGetStopBlur,this)),BX.addCustomEvent(window,"BX.Main.SelectorV2:beforeInitDialog",BX.delegate(this.onBeforeInitDialog,this)),BX.addCustomEvent(window,"BX.Main.Filter:customEntityRemove",BX.delegate(this.onCustomEntityRemove,this))},BX.Filter.DestinationSelector.prototype.open=function(){if(this.id,this.inited){var t={};t[this.currentUser.entityId]="users",BX.onCustomEvent(window,"BX.Filter.DestinationSelector:open",[{id:this.id,bindNode:this.control.getField(),value:t}]),this.opened=!0}else{var e=this.getSearchInput();e.id=e.name,BX.addCustomEvent(window,"BX.Main.SelectorV2:afterInitDialog",BX.delegate(function(t){void 0===t.id&&t.id==this.id&&(this.opened=!0)},this)),BX.addCustomEvent(window,"BX.UI.SelectorManager:onCreate",BX.delegate(function(t){BX.type.isNotEmptyString(t)&&t==this.id&&BX.onCustomEvent(window,"BX.Filter.DestinationSelector:setSelected",[{selectorId:t,current:this.control.getCurrentValues()}])},this)),BX.onCustomEvent(window,"BX.Filter.DestinationSelector:openInit",[{id:this.id,inputId:e.id,containerId:e.id}])}},BX.Filter.DestinationSelector.prototype.close=function(){void 0!==BX.Main.selectorManagerV2.controls[this.id]&&BX.Main.selectorManagerV2.controls[this.id].closeDialog()},BX.Filter.DestinationSelector.prototype.onCustomEntitySelectorOpen=function(t){var e=t.getId();if(this.fieldId!==e)this.control=null;else{if(this.control=t,this.control){var i=this.control.getCurrentValues();this.currentUser={entityId:i.value}}BX.Filter.DestinationSelectorManager.controls[this.id]=this.control,this.opened?this.close():this.open()}},BX.Filter.DestinationSelector.prototype.onCustomEntitySelectorClose=function(t){this.fieldId===t.getId()&&!0===this.inited&&!0===this.opened&&(this.control=null,window.setTimeout(BX.delegate(this.close,this),0))},BX.Filter.DestinationSelector.prototype.onGetStopBlur=function(t,e){BX.findParent(t.target,{className:"bx-lm-box"})&&(e.stopBlur=!0)},BX.Filter.DestinationSelector.prototype.onCustomEntityRemove=function(t){if(this.fieldId===t.getId()){var e=BX.UI.SelectorManager.instances[t.getId()];e&&void 0!==t.hiddenInput&&void 0!==t.hiddenInput.value&&BX.type.isNotEmptyObject(e.itemsSelected)&&void 0!==e.itemsSelected[t.hiddenInput.value]&&delete e.itemsSelected[t.hiddenInput.value]}},BX.Filter.DestinationSelector.prototype.onBeforeInitDialog=function(t){void 0!==t.id&&t.id==this.id&&(this.inited=!0,this.control||(t.blockInit=!0))},BX.Filter.DestinationSelector.prototype.onDialogOpen=function(){this.opened=!0},BX.Filter.DestinationSelector.prototype.onDialogClose=function(){this.opened=!1},BX.namespace("BX.Filter"),BX.Filter.FieldController=function(t,e){this.field=null,this.parent=null,this.type=null,this.input=null,this.deleteButton=null,this.init(t,e)},BX.Filter.FieldController.prototype={init:function(t,e){if(!BX.type.isDomNode(t))throw"BX.Filter.FieldController.init: field isn't dom node";if(!(e instanceof BX.Main.Filter))throw"BX.Filter.FieldController.init: parent not instance of BX.Main.ui.Filter";this.field=t,this.parent=e,this.bind(),this.isShowDelete()?this.showDelete():this.hideDelete()},isShowDelete:function(){var t=this.getSquares();return this.getInputValue()||BX.type.isArray(t)&&t.length},getField:function(){return this.field},getInput:function(){var t,e;return BX.type.isDomNode(this.input)||((t=this.getType())===(e=this.parent.types).DATE&&(this.input=BX.Filter.Utils.getByClass(this.getField(),this.parent.settings.classDateInput)),t!==e.NUMBER&&"number"!==t||(this.input=BX.Filter.Utils.getByClass(this.getField(),this.parent.settings.classNumberInput)),t===e.STRING&&(this.input=BX.Filter.Utils.getByClass(this.getField(),this.parent.settings.classStringInput)),t===e.CUSTOM_ENTITY&&(this.input=BX.Filter.Utils.getBySelector(this.getField(),'input[type="hidden"]'))),this.input},getDeleteButton:function(){return BX.type.isDomNode(this.deleteButton)||(this.deleteButton=BX.Filter.Utils.getByClass(this.getField(),this.parent.settings.classValueDelete)),this.deleteButton},getSquares:function(){return BX.Filter.Utils.getByClass(this.getField(),this.parent.settings.classSquare)},bind:function(){this.getType()!==this.parent.types.MULTI_SELECT&&this.getType()!==this.parent.types.SELECT&&(BX.bind(this.getDeleteButton(),"click",BX.delegate(this._onDeleteClick,this)),BX.bind(this.getInput(),"input",BX.delegate(this._onInput,this)))},clearInput:function(){var t=this.getInput();BX.type.isDomNode(t)&&(t.value="")},hideDelete:function(){var t=this.getDeleteButton();BX.type.isDomNode(t)&&BX.addClass(t,this.parent.settings.classHide)},showDelete:function(){var t=this.getDeleteButton();BX.type.isDomNode(t)&&BX.removeClass(t,this.parent.settings.classHide)},removeSquares:function(){var t=this.getSquares();BX.type.isArray(t)&&t.length&&t.forEach(function(t){BX.remove(t)})},_onDeleteClick:function(){this.removeSquares(),this.clearInput(),this.hideDelete()},_onInput:function(){this.getInputValue()?this.showDelete():this.hideDelete()},getInputValue:function(){var t="",e=this.getInput();return BX.type.isDomNode(e)&&(t=e.value),t},getType:function(){return BX.type.isNotEmptyString(this.type)||(this.type=BX.data(this.getField(),"type")),this.type}},BX.namespace("BX.Main.ui"),BX.Main.ui.CustomEntity=function(){this.field=null,this.labelInput=null,this.hiddenInput=null,this.popupContainer=null,this.inputClass="main-ui-control-string",this.squareClass="main-ui-square",this.multiple=null},BX.Main.ui.CustomEntity.isMultiple=function(t){return t&&!BX.hasClass(t,"main-ui-control-entity")&&(t=BX.Filter.Utils.getByClass(t,"main-ui-control-entity")),!!t&&JSON.parse(BX.data(t,"multiple"))},BX.Main.ui.CustomEntity.prototype={setField:function(t){this.field!==t&&(this.field=t,this.reset())},isMultiple:function(){return BX.Main.ui.CustomEntity.isMultiple(this.getField())},reset:function(){this.labelInput=null,this.hiddenInput=null},getField:function(){return this.field},getId:function(){var t=this.getHiddenNode(),e=null;return BX.type.isDomNode(t)&&(e=t.name),e},getLabelNode:function(){return BX.type.isDomNode(this.labelInput)||(this.labelInput=BX.Filter.Utils.getBySelector(this.getField(),"."+this.inputClass+'[type="text"]')),this.labelInput},getHiddenNode:function(){return BX.type.isDomNode(this.hiddenInput)||(this.hiddenInput=BX.Filter.Utils.getBySelector(this.getField(),"."+this.inputClass+'[type="hidden"]')),this.hiddenInput},getSquareByValue:function(t){return BX.Filter.Utils.getBySelector(this.getField(),['[data-item*=":'+BX.util.jsencode(t)+'}"]','[data-item*=":\\"'+BX.util.jsencode(t)+'\\"}"]'].join(", "))},getSquares:function(){return BX.Filter.Utils.getByClass(this.getField(),this.squareClass,!0)},removeSquares:function(){this.getSquares().forEach(BX.remove)},setSquare:function(t,e){var i=this.getField(),s={block:"main-ui-square",name:t,item:{_label:t,_value:e}},n=BX.decl(s),a=this.getSquares();a.length?BX.insertAfter(n,a[a.length-1]):BX.prepend(n,i)},getCurrentValues:function(){var t,e,i=this.getSquares();if(this.isMultiple()){e=[];for(var s=0,n=i.length;s<n;s++)try{t=JSON.parse(BX.data(i[s],"item")),e.push({label:t._label,value:t._value})}catch(t){}}else if(0===i.length)e={label:"",value:""};else try{e={label:(t=JSON.parse(BX.data(i[0],"item")))._label,value:t._value}}catch(t){e={label:"",value:""}}return e},setData:function(t,e){return this.isMultiple()?this.setMultipleData(t,e):this.setSingleData(t,e)},setSingleData:function(t,e){var i=this.getHiddenNode();this.removeSquares(),this.setSquare(t,e),BX.type.isDomNode(i)&&(i.value=e,BX.fireEvent(i,"input"))},setMultipleData:function(t,e){var i=[],s=this.getHiddenNode();BX.type.isArray(t)&&(this.removeSquares(),BX.type.isArray(t)&&(t.forEach(function(t){i.push(t.value),this.setSquare(t.label,t.value)},this),BX.type.isDomNode(s)&&(s.value=JSON.stringify(i),BX.fireEvent(s,"input")))),BX.type.isArray(t)||null===e||this.getSquareByValue(e)||(this.setSquare(t,e),this.getSquares().forEach(function(t){var e=JSON.parse(BX.data(t,"item"));BX.type.isPlainObject(e)&&i.push(e._value)}),s.value=JSON.stringify(i),BX.fireEvent(s,"input"))},setPopupContainer:function(t){BX.type.isDomNode(t)&&(this.popupContainer=t)},getPopupContainer:function(){return this.popupContainer}},BX.namespace("BX.Filter"),BX.Filter.Search=function(t){this.parent=null,this.container=null,this.input=null,this.preset=null,this.buttonsContainer=null,this.delay=800,this.timeout=null,this.init(t)},BX.Filter.Search.prototype={init:function(t){this.parent=t,BX.bind(this.getInput(),"input",BX.delegate(this._onInputWithoutDebounce,this)),this.parent.getParam("ENABLE_LIVE_SEARCH")&&BX.bind(this.getInput(),"input",BX.debounce(this._onInput,this.delay,this)),BX.bind(this.getInput(),"keydown",BX.delegate(this._onKeyDown,this)),BX.bind(this.getFindButton(),"click",BX.delegate(this._onSearchClick,this)),BX.bind(this.getContainer(),"click",BX.delegate(this._onSearchContainerClick,this)),this.removeAutofocus(),this.firstInit=!0},removeAutofocus:function(){var t=this.getInput();t&&(t.blur(),t.autofocus=null)},getFindButton:function(){return BX.type.isDomNode(this.findButton)||(this.findButton=BX.Filter.Utils.getByClass(this.getContainer(),this.parent.settings.classSearchButton)),this.findButton},_onSearchClick:function(){this.apply()},selectSquare:function(t){t&&BX.addClass(t,this.parent.settings.classSquareSelected)},selectSquares:function(){this.getSquares().forEach(this.selectSquare,this)},unselectSquare:function(t){t&&BX.removeClass(t,this.parent.settings.classSquareSelected)},unselectSquares:function(){this.getSquares().forEach(this.unselectSquare,this)},removeSquares:function(){this.getSquares().forEach(this.removeSquare,this)},isSquaresSelected:function(){var t=this.getSquares();return t.length&&t.every(this.isSquareSelected,this)},isSquareSelected:function(t){return!!t&&BX.hasClass(t,this.parent.settings.classSquareSelected)},getLastSquare:function(){var t=this.getSquares();return t?t[t.length-1]:null},isTextSelected:function(){var t=this.getSearchString().length,e=this.getInput(),i=e.selectionStart,s=e.selectionEnd;return 0===i&&0!==s&&s===t},isSelectionStart:function(){var t=this.getInput(),e=t.selectionStart,i=t.selectionEnd;return 0===e&&0===i},isSquareRemoveButton:function(t){return!!t&&BX.hasClass(t,this.parent.settings.classSquareDelete)},isClearButton:function(t){return!!t&&BX.hasClass(t,this.parent.settings.classClearSearchValueButton)},getClearButton:function(){return this.getContainer().querySelector("."+this.parent.settings.classClearSearchValueButton)},isSearchButton:function(t){return!!t&&BX.hasClass(t,this.parent.settings.classSearchButton)},adjustFocus:function(){if(!BX.browser.IsMobile()){var t=this.getInput();document.activeElement!==t&&window.scrollY<BX.pos(t).top&&(t.value=t.value,t.blur())}},findSquareByChild:function(t){return BX.findParent(t,{className:this.parent.settings.classSquare},!0,!1)},getSquareData:function(t){var e=BX.data(t,"item");return t&&e?JSON.parse(e):null},isSquareControl:function(t){var e=this.getSquareData(t);return!!e&&("control"===e.type||BX.type.isArray(e))},onPresetSquareRemove:function(){var t=this.parent,e=t.getPreset(),i=e.getCurrentPresetId(),s=t.getParam("RESET_TO_DEFAULT_MODE"),n=t.getParam("VALUE_REQUIRED"),a=e.isPinned(i),r=this.getSquares();if(1===r.length&&(n&&a?(this.parent.showPopup(),this.adjustPlaceholder(),this.parent.getPreset().deactivateAllPresets()):(s&&a||!s)&&(this.lastPromise=t.resetFilter(!0),t.closePopup()),s&&!a&&(this.lastPromise=t.getPreset().applyPinnedPreset())),r.length>1){var l=e.getPreset(e.getCurrentPresetId());e.getPreset("tmp_filter").FIELDS=BX.clone(l.ADDITIONAL),l.ADDITIONAL=[],e.deactivateAllPresets(),e.applyPreset("tmp_filter"),t.applyFilter()}},onControlSquareRemove:function(t){var e,i=this.parent,s=i.getPreset(),n=i.getParam("RESET_TO_DEFAULT_MODE"),a=i.getParam("VALUE_REQUIRED");n&&1===this.getSquares().length?a?(e=this.getSquareData(t),i.clearControls(e),this.parent.showPopup(),this.adjustPlaceholder(),this.parent.getPreset().deactivateAllPresets()):this.lastPromise=i.getPreset().applyPinnedPreset():(e=this.getSquareData(t),i.clearControls(e),i.closePopup(),BX.type.isArray(e)&&e.forEach(function(t){s.removeAdditionalField(t.name)}),BX.type.isPlainObject(e)&&s.removeAdditionalField(e.name),this.apply())},onValueRequiredSquareRemove:function(){var t=this.parent;t.getPreset().deactivateAllPresets(),t.showPopup(),this.adjustPlaceholder()},complexSquareRemove:function(t){var e=this.parent.getParam("VALUE_REQUIRED_MODE"),i=!this.isSquareControl(t);e?this.onValueRequiredSquareRemove():i?this.onPresetSquareRemove():this.onControlSquareRemove(t),this.removeSquare(t),this.adjustClearButton()},adjustClearButton:function(){this.getLastSquare()?this.showClearButton():this.hideClearButton()},removeSquare:function(t){t&&BX.remove(t)},_onSearchContainerClick:function(t){var e=this.parent;if(this.isClearButton(t.target))if(e.getParam("VALUE_REQUIRED")){if(e.getPreset().isPinned(e.getPreset().getCurrentPresetId())||"tmp_filter"===e.getPreset().getCurrentPresetId()){var i=e.getPreset().getPreset(e.getPreset().getCurrentPresetId());i.ADDITIONAL.length?(i.ADDITIONAL=[],this.lastPromise=e.getPreset().applyPreset(e.getPreset().getCurrentPresetId()),this.apply()):(this.removeSquares(),e.showPopup(),this.adjustPlaceholder(),this.hideClearButton(),e.getPreset().deactivateAllPresets())}else e.getParam("RESET_TO_DEFAULT_MODE")?this.lastPromise=e.getPreset().applyPinnedPreset():e.resetFilter(),e.closePopup(),this.adjustFocus();this.clearInput()}else e.getParam("VALUE_REQUIRED_MODE")?(this.removeSquares(),e.showPopup(),this.adjustPlaceholder(),this.hideClearButton(),e.getPreset().deactivateAllPresets()):(e.getParam("RESET_TO_DEFAULT_MODE")?(this.clearInput(),this.lastPromise=e.getPreset().applyPinnedPreset()):e.resetFilter(),e.closePopup(),this.adjustFocus());else if(this.isSearchButton(t.target))this.apply(),this.adjustFocus();else if(this.isSquareRemoveButton(t.target)){var s=this.findSquareByChild(t.target);this.complexSquareRemove(s),this.adjustFocus()}else if(e.getPopup().isShown()){var n=this.getInput(),a=n.selectionStart,r=n.selectionEnd,l=this.getSearchString().length;l&&0===a&&r===l||(e.getParam("VALUE_REQUIRED")?this.getSquares().length?e.closePopup():this.lastPromise=e.getPreset().applyPinnedPreset():(e.closePopup(),e.getParam("VALUE_REQUIRED_MODE")&&e.restoreRemovedPreset()))}else e.showPopup()},_onKeyDown:function(t){var e=BX.Filter.Utils,i=this.parent;if(e.isKey(t,"enter")&&(i.getParam("VALUE_REQUIRED")?this.getSquares().length?(this.apply(),this.firstInit=!1,this.lastSearchString=this.getSearchString()):this.parent.getPreset().applyPinnedPreset():(this.apply(),this.firstInit=!1,this.lastSearchString=this.getSearchString()),i.closePopup()),(e.isKey(t,"tab")||e.isKey(t,"downArrow"))&&(i.showPopup(),i.adjustFocus(),this.unselectSquares()),e.isKey(t,"upArrow")&&(i.closePopup(),i.getParam("VALUE_REQUIRED_MODE")&&this.parent.restoreRemovedPreset(),i.getParam("VALUE_REQUIRED")&&(this.getSquares().length||this.parent.getPreset().applyPinnedPreset())),(e.isKey(t,"a")&&t.metaKey||e.isKey(t,"a")&&t.ctrlKey)&&this.selectSquares(),e.isKey(t,"backspace")&&this.isTextSelected()&&this.isSquaresSelected()&&(clearTimeout(this.timeout),this.parent.getParam("VALUE_REQUIRED")?(this.parent.getPreset().isPinned(this.parent.getPreset().getCurrentPresetId())?(this.removeSquares(),this.parent.showPopup(),this.adjustPlaceholder(),this.hideClearButton(),this.parent.getPreset().deactivateAllPresets()):(this.parent.getParam("RESET_TO_DEFAULT_MODE")?this.lastPromise=this.parent.getPreset().applyPinnedPreset():this.parent.resetFilter(),this.parent.closePopup(),this.adjustFocus()),this.clearInput()):(this.parent.getParam("RESET_TO_DEFAULT_MODE")?this.lastPromise=this.parent.getPreset().applyPinnedPreset():this.lastPromise=this.parent.resetFilter(),this.parent.closePopup())),e.isKey(t,"backspace")&&this.isSelectionStart()){clearTimeout(this.timeout);var s=this.getLastSquare();this.isSquareSelected(s)?this.complexSquareRemove(s):this.selectSquare(s)}e.isKey(t,"backspace")||t.metaKey||!this.isSquaresSelected()||this.unselectSquares()},getSearchString:function(){var t=this.getInput();return t?t.value:""},getSquares:function(){return BX.Filter.Utils.getByClass(this.getContainer(),this.parent.settings.classSquare,!0)},adjustPlaceholder:function(){this.parent.getParam("LIMITS_ENABLED")?this.setInputPlaceholder(this.parent.getParam("MAIN_UI_FILTER__PLACEHOLDER_LIMITS_EXCEEDED")):this.parent.getParam("DISABLE_SEARCH")||!this.parent.settings.get("SEARCH")?this.setInputPlaceholder(this.parent.getParam("MAIN_UI_FILTER__PLACEHOLDER")):this.setInputPlaceholder(this.parent.getParam("MAIN_UI_FILTER__PLACEHOLDER_DEFAULT"))},isResolvedRequest:function(){return!this.lastPromise||!!this.lastPromise&&this.lastPromise.state},apply:function(){return this.isResolvedRequest()&&(this.lastPromise=this.parent._onFindButtonClick()),this.lastPromise},reset:function(){return this.isResolvedRequest()&&(this.parent.getSearch().removePreset(),this.parent.getPreset().deactivateAllPresets(),this.parent.getPreset().resetPreset(!0),this.timeout=setTimeout(BX.delegate(function(){this.lastPromise=this.parent.resetFilter()},this),this.delay)),this.lastPromise},_onInputWithoutDebounce:function(){clearTimeout(this.timeout);var t=this.getSearchString();this.lastSearchString=this.lastSearchString?this.lastSearchString:t,t===this.lastSearchString||this.parent.isIe()&&this.firstInit||(this.parent.getParam("ENABLE_LIVE_SEARCH")&&(this.parent.showGridAnimation(),BX.onCustomEvent(window,"BX.Filter.Search:input",[this.parent.params.FILTER_ID,t])),this.parent.getPopup().isShown()&&this.parent.closePopup()),t?this.showClearButton():this.getSquares().length||this.lastSearchString===t||(this.hideClearButton(),this.adjustPlaceholder())},_onInput:function(){var t=this.getSearchString();t===this.lastSearchString||this.parent.isIe()&&this.firstInit||this.apply(),this.firstInit=!1,this.lastSearchString=t},getButtonsContainer:function(){return BX.type.isDomNode(this.buttonsContainer)||(this.buttonsContainer=BX.Filter.Utils.getByClass(this.getContainer(),this.parent.settings.classSearchButtonsContainer)),this.buttonsContainer},showClearButton:function(){BX.addClass(this.getButtonsContainer(),this.parent.settings.classShow)},hideClearButton:function(){BX.removeClass(this.getButtonsContainer(),this.parent.settings.classShow)},getInput:function(){var t;return BX.type.isDomNode(this.input)||(t=[this.parent.getParam("FILTER_ID",""),"_search"].join(""),this.input=BX(t)),this.input},getContainer:function(){var t;return BX.type.isDomNode(this.container)||(t=[this.parent.getParam("FILTER_ID"),"_search_container"].join(""),this.container=BX(t)),this.container},setInputPlaceholder:function(t){this.getInput().placeholder=t},clearInput:function(){var t=this.getInput();BX.type.isDomNode(t)&&(t.value=null)},clearForm:function(){this.clearInput(),this.removePreset()},makeSquares:function(t,e,i){var s,n=null,a=this.getContainer(),r={squares:[],moreSquares:[]};return t.forEach(function(t,l){if(l<e){if(s=BX.decl(t),n=n||s,i){var o=BX.Filter.Utils.getByClass(this.getContainer(),this.parent.settings.classSquare);o?BX.insertAfter(s,o):BX.prepend(s,a)}else 0===l?BX.prepend(s,a):BX.insertAfter(s,n);n=s,r.squares.push(s)}else r.moreSquares.push({type:"control",name:t.value,title:t.title})},this),r},squares:function(t,e,i){var s,n,a,r,l,o=BX.Filter.Utils.getByClass(this.getContainer(),this.parent.settings.classSquare,!0);return i?o.forEach(function(t){BX.data(t,"item")&&BX.remove(t)}):o.forEach(BX.remove),r=0,l={squaresData:s=this.prepareSquaresData(t),width:0},(n=this.makeSquares(s,e,i)).moreSquares.length&&(a={block:"main-ui-search-square",name:this.parent.getParam("MAIN_UI_FILTER__AND")+" "+this.parent.getParam("MAIN_UI_FILTER__MORE")+" "+n.moreSquares.length,item:n.moreSquares,title:n.moreSquares.map(function(t){return t.title}).join(", \n")},a=BX.decl(a),n.squares.push(a),BX.insertAfter(a,n.squares[n.squares.length-2]),r=n.squares.reduce(function(t,e){return t+BX.width(e)+(parseFloat(BX.style(e,"margin-right"))||0)},0)),l.width=r,l},setPreset:function(t){var e,i,s=this.getContainer();BX.type.isPlainObject(t)&&(BX.Filter.Utils.getByClass(s,this.parent.settings.classSquare,!0).forEach(BX.remove),(t=BX.clone(t)).ADDITIONAL=t.ADDITIONAL||[],BX.onCustomEvent(window,"BX.Filter.Search:beforeSquaresUpdate",[t,this]),"default_filter"!==t.ID&&"tmp_filter"!==t.ID?(e=BX.decl({block:"main-ui-search-square",name:t.TITLE,value:t.ID,isPreset:!0}),BX.prepend(e,s),"ADDITIONAL"in t&&BX.type.isArray(t.ADDITIONAL)&&t.ADDITIONAL.length&&(i=this.squares(t.ADDITIONAL,1,!0),BX.width(s)-i.width<100&&(i=this.squares(t.ADDITIONAL,0,!0)))):("ADDITIONAL"in t&&BX.type.isArray(t.ADDITIONAL)&&t.ADDITIONAL.length&&t.ADDITIONAL.forEach(function(e,i){"ID"in e||(e.ID="ADDITIONAL_ID_"+i),"NAME"in e||(e.NAME="ADDITIONAL_NAME_"+i),"TYPE"in e||(e.TYPE="STRING"),"LABEL"in e&&"LABEL"in e&&t.FIELDS.push(e)}),BX.type.isArray(t.FIELDS)&&t.FIELDS.length&&(i=this.squares(t.FIELDS,2),BX.width(s)-i.width<100&&(i=this.squares(t.FIELDS,1)))),i&&BX.type.isArray(i.squaresData)&&i.squaresData.length||"default_filter"!==t.ID&&"tmp_filter"!==t.ID?(this.parent.getParam("LIMITS_ENABLED")?this.setInputPlaceholder(this.parent.getParam("MAIN_UI_FILTER__PLACEHOLDER_LIMITS_EXCEEDED")):this.setInputPlaceholder(this.parent.getParam("MAIN_UI_FILTER__PLACEHOLDER_WITH_FILTER")),this.showClearButton()):this.adjustPlaceholder(),BX.type.isNotEmptyString(this.parent.getSearch().getInput().value)&&this.showClearButton())},prepareSquaresData:function(t){var e,i,s,n=[];return(t=t.filter(function(t){return!!t&&this.parent.params.FIELDS.some(function(e){return t.NAME===e.NAME})},this)).map(function(t){switch(e=null,t.TYPE){case this.parent.types.DATE:if(e=t.LABEL+": "+t.SUB_TYPE.NAME,t.SUB_TYPE.VALUE===this.parent.dateTypes.QUARTER&&BX.type.isNotEmptyString(t.VALUES._quarter)){var a=t.QUARTERS.filter(function(e){return e.VALUE==t.VALUES._quarter}).map(function(t){return t.NAME});a=a.length?a.join(""):"",e=t.LABEL+": "+a+" "+this.parent.getParam("MAIN_UI_FILTER__QUARTER").toLocaleLowerCase()+" "+t.VALUES._year}if(t.SUB_TYPE.VALUE===this.parent.dateTypes.YEAR&&BX.type.isNotEmptyString(t.VALUES._year)&&(e=t.LABEL+": "+t.VALUES._year),t.SUB_TYPE.VALUE===this.parent.dateTypes.MONTH&&BX.type.isNotEmptyString(t.VALUES._month)){var r=t.MONTHS.filter(function(e){return e.VALUE==t.VALUES._month}).map(function(t){return t.NAME});r=r.length?r.join(""):"",e=t.LABEL+": "+r+" "+t.VALUES._year}t.SUB_TYPE.VALUE===this.parent.dateTypes.EXACT&&BX.type.isNotEmptyString(t.VALUES._from)&&(e=t.LABEL+": "+t.VALUES._from),t.SUB_TYPE.VALUE===this.parent.dateTypes.RANGE&&(BX.type.isNotEmptyString(t.VALUES._from)&&BX.type.isNotEmptyString(t.VALUES._to)?e=t.LABEL+": "+t.VALUES._from+"-"+t.VALUES._to:!BX.type.isNotEmptyString(t.VALUES._from)&&BX.type.isNotEmptyString(t.VALUES._to)?e=t.LABEL+": "+this.parent.getParam("MAIN_UI_FILTER__BEFORE")+" "+t.VALUES._to:BX.type.isNotEmptyString(t.VALUES._from)&&!BX.type.isNotEmptyString(t.VALUES._to)&&(e=t.LABEL+": "+this.parent.getParam("MAIN_UI_FILTER__AFTER")+" "+t.VALUES._from)),t.SUB_TYPE.VALUE!==this.parent.dateTypes.NEXT_DAYS&&t.SUB_TYPE.VALUE!==this.parent.dateTypes.PREV_DAYS||BX.type.isNumber(parseInt(t.VALUES._days))||(e=null),t.SUB_TYPE.VALUE===this.parent.dateTypes.NEXT_DAYS&&BX.type.isNumber(parseInt(t.VALUES._days))&&(e=t.LABEL+": "+this.parent.getParam("MAIN_UI_FILTER__DATE_NEXT_DAYS_LABEL").replace("#N#",t.VALUES._days)),t.SUB_TYPE.VALUE===this.parent.dateTypes.PREV_DAYS&&BX.type.isNumber(parseInt(t.VALUES._days))&&(e=t.LABEL+": "+this.parent.getParam("MAIN_UI_FILTER__DATE_PREV_DAYS_LABEL").replace("#N#",t.VALUES._days)),t.SUB_TYPE.VALUE===this.parent.dateTypes.NONE&&(e=null);break;case this.parent.types.CUSTOM_DATE:(BX.type.isArray(t.VALUE.days)&&t.VALUE.days.length||BX.type.isArray(t.VALUE.months)&&t.VALUE.months.length||BX.type.isArray(t.VALUE.years)&&t.VALUE.years.length)&&(e=t.LABEL);break;case this.parent.types.SELECT:(BX.type.isPlainObject(t.VALUE)&&t.VALUE.VALUE||t.STRICT)&&(e=t.LABEL+": "+t.VALUE.NAME);break;case this.parent.types.MULTI_SELECT:BX.type.isArray(t.VALUE)&&t.VALUE.length&&(i=[],e=t.LABEL+": ",t.VALUE.forEach(function(t,e){e<2&&i.push(t.NAME)}),e+=i.join(", "),t.VALUE.length>2&&(s=[],t.VALUE.forEach(function(t){s.push(t.NAME)}),e=s.join(", ")));break;case this.parent.types.NUMBER:"exact"===t.SUB_TYPE.VALUE&&(e=BX.type.isNotEmptyString(t.VALUES._from)?t.LABEL+": "+t.VALUES._from:null),"range"===t.SUB_TYPE.VALUE&&(e=BX.type.isNotEmptyString(t.VALUES._from)&&BX.type.isNotEmptyString(t.VALUES._to)?t.LABEL+": "+t.VALUES._from+"-"+t.VALUES._to:!BX.type.isNotEmptyString(t.VALUES._from)&&BX.type.isNotEmptyString(t.VALUES._to)?t.LABEL+": "+this.parent.getParam("MAIN_UI_FILTER__NUMBER_LESS")+" "+t.VALUES._to:BX.type.isNotEmptyString(t.VALUES._from)&&!BX.type.isNotEmptyString(t.VALUES._to)?t.LABEL+": "+this.parent.getParam("MAIN_UI_FILTER__NUMBER_MORE")+" "+t.VALUES._from:null),"more"===t.SUB_TYPE.VALUE&&BX.type.isNotEmptyString(t.VALUES._from)&&(e=t.LABEL+": > ",e+=t.VALUES._from),"less"===t.SUB_TYPE.VALUE&&BX.type.isNotEmptyString(t.VALUES._to)&&(e=t.LABEL+": < ",e+=t.VALUES._to);break;case this.parent.types.CUSTOM_ENTITY:case this.parent.types.DEST_SELECTOR:if(t.MULTIPLE){var l=t.VALUES._label?t.VALUES._label:[];BX.type.isPlainObject(l)&&(l=Object.keys(l).map(function(t){return l[t]})),BX.type.isArray(l)||(l=[l]),l.length>0&&(e=t.LABEL+": ",e+=l.join(", "))}else BX.type.isNotEmptyString(t.VALUES._value)&&BX.type.isNotEmptyString(t.VALUES._label)&&(e=t.LABEL+": ",e+=t.VALUES._label);break;case this.parent.types.CUSTOM:e="_VALUE"in t&&BX.type.isNotEmptyString(t._VALUE)?t.LABEL:null;break;default:BX.type.isNotEmptyString(t.VALUE)&&(e=t.LABEL+": "+t.VALUE)}null!==e&&n.push({block:"main-ui-search-square",name:e,value:t.NAME,item:{type:"control",name:t.NAME},title:e})},this),n},getPreset:function(){var t=this.getContainer(),e=this.parent.settings.classSquare,i=null;return BX.type.isDomNode(t)&&(i=BX.Filter.Utils.getByClass(t,e)),i},removePreset:function(){var t=this.getPreset();BX.type.isDomNode(t)&&(BX.remove(t),this.adjustPlaceholder()),this.hideClearButton()},updatePreset:function(t){this.removePreset(),this.setPreset(t)}},BX.namespace("BX.Filter"),BX.Filter.Settings=function(t,e){this.classField="main-ui-control-field",this.classFieldGroup="main-ui-control-field-group",this.classFieldLine="main-ui-filter-field-line",this.classFieldDelete="main-ui-filter-field-delete",this.classFieldLabel="main-ui-control-field-label",this.classFieldWithLabel="main-ui-filter-wield-with-label",this.classPresetName="main-ui-filter-sidebar-item-text",this.classControl="main-ui-control",this.classDateInput="main-ui-date-input",this.classHide="main-ui-hide",this.classNumberInput="main-ui-number-input",this.classSelect="main-ui-select",this.classMultiSelect="main-ui-multi-select",this.classValueDelete="main-ui-control-value-delete",this.classStringInput="main-ui-control-string",this.classAddField="main-ui-filter-field-add-item",this.classAddPresetField="main-ui-filter-new-filter",this.classAddPresetFieldInput="main-ui-filter-sidebar-edit-control",this.classAddPresetButton="main-ui-filter-add-item",this.classButtonsContainer="main-ui-filter-field-button-container",this.classSaveButton="main-ui-filter-save",this.classCancelButton="main-ui-filter-cancel",this.classMenuItem="main-ui-select-inner-item",this.classMenuItemText="main-ui-select-inner-item-element",this.classMenuMultiItemText="main-ui-select-inner-label",this.classMenuItemChecked="main-ui-checked",this.classSearchContainer="main-ui-filter-search",this.classDefaultPopup="popup-window",this.classPopupFieldList="main-ui-filter-popup-field-list",this.classPopupFieldList1Column="main-ui-filter-field-list-1-column",this.classPopupFieldList2Column="main-ui-filter-field-list-2-column",this.classPopupFieldList3Column="main-ui-filter-field-list-3-column",this.classFieldListItem="main-ui-filter-field-list-item",this.classEditButton="main-ui-filter-add-edit",this.classPresetEdit="main-ui-filter-edit",this.classPresetNameEdit="main-ui-filter-edit-text",this.classPresetDeleteButton="main-ui-delete",this.classPresetDragButton="main-ui-filter-icon-grab",this.classPresetEditButton="main-ui-filter-icon-edit",this.classPresetEditInput="main-ui-filter-sidebar-item-input",this.classPresetOndrag="main-ui-filter-sidebar-item-ondrag",this.classSquare="main-ui-square",this.classSquareDelete="main-ui-square-delete",this.classSquareSelected="main-ui-square-selected",this.classPresetsContainer="main-ui-filter-sidebar-item-container",this.classPreset="main-ui-filter-sidebar-item",this.classPresetCurrent="main-ui-filter-current-item",this.classFilterContainer="main-ui-filter-wrapper",this.classFileldControlList="main-ui-filter-field-container-list",this.classRestoreFieldsButton="main-ui-filter-field-restore-items",this.classClearSearchValueButton="main-ui-delete",this.classSearchButtonsContainer="main-ui-item-icon-block",this.classSearchButton="main-ui-search",this.classDisabled="main-ui-disable",this.classAnimationShow="main-ui-popup-show-animation",this.classAnimationClose="main-ui-popup-close-animation",this.classLimitsAnimation="main-ui-filter-field-limits-animate",this.classSidebarControlsContainer="main-ui-filter-add-container",this.searchContainerPostfix="_search_container",this.classPresetButtonsContainer="main-ui-filter-field-preset-button-container",this.classFindButton="main-ui-filter-find",this.classResetButton="main-ui-filter-reset",this.classDefaultFilter="main-ui-filter-default-preset",this.classRestoreButton="main-ui-filter-reset-link",this.classPinButton="main-ui-filter-icon-pin",this.classPopupOverlay="popup-window-overlay",this.classPinnedPreset="main-ui-item-pin",this.classWaitButtonClass="ui-btn-clock",this.classForAllCheckbox="main-ui-filter-save-for-all",this.classShow="main-ui-show",this.classFocus="main-ui-focus",this.classPresetField="main-ui-filter-preset-field",this.numberPostfix="_numsel",this.datePostfix="_datesel",this.toPostfix="_to",this.fromPostfix="_from",this.daysPostfix="_days",this.monthPostfix="_month",this.quarterPostfix="_quarter",this.yearPostfix="_year",this.generalTemplateId="",this.init(t,e)},BX.Filter.Settings.prototype={init:function(t,e){this.generalTemplateId=e.getParam("FILTER_ID")+"_GENERAL_template",this.mergeSettings(t)},get:function(t,e){return t&&t in this&&!BX.type.isFunction(this[t])?this[t]:e},mergeSettings:function(t){BX.type.isPlainObject(t)&&Object.keys(t).forEach(function(e){BX.type.isFunction(this[e])||(this[e]=t[e])},this)}},function(){BX.namespace("BX.Main"),BX.Main.Filter=function(t,e,i,s,n,a){this.params=t,this.search=null,this.popup=null,this.presets=null,this.fields=null,this.types=i,this.dateTypes=s,this.additionalDateTypes=a,this.numberTypes=n,this.settings=new BX.Filter.Settings(e,this),this.filter=null,this.api=null,this.isAddPresetModeState=!1,this.firstInit=!0,this.emitter=new BX.Event.EventEmitter,this.emitter.setEventNamespace("BX.Filter.Field"),this.emitter.subscribe=function(t,e){BX.Event.EventEmitter.subscribe(this.emitter,t.replace("BX.Filter.Field:",""),e)}.bind(this),this.init()},BX.Main.Filter.prototype={init:function(){BX.bind(document,"mousedown",BX.delegate(this._onDocumentClick,this)),BX.bind(document,"keydown",BX.delegate(this._onDocumentKeydown,this)),BX.bind(window,"load",BX.delegate(this.onWindowLoad,this)),BX.addCustomEvent("Grid::ready",BX.delegate(this._onGridReady,this)),this.getSearch().updatePreset(this.getParam("CURRENT_PRESET"))},getEmitter:function(){return this.emitter},onWindowLoad:function(){this.settings.get("AUTOFOCUS")&&this.adjustFocus()},clearGet:function(){if("history"in window){var t=window.location.toString(),e=BX.util.remove_url_param(t,"apply_filter");window.history.replaceState(null,"",e)}},adjustFocus:function(){this.getSearch().adjustFocus()},_onAddPresetKeydown:function(t){BX.Filter.Utils.isKey(t,"enter")&&this._onSaveButtonClick()},_onDocumentKeydown:function(t){BX.Filter.Utils.isKey(t,"escape")&&this.getPopup().isShown()&&(BX.onCustomEvent(window,"BX.Main.Filter:blur",[this]),this.closePopup(),this.getParam("VALUE_REQUIRED_MODE")&&this.restoreRemovedPreset(),this.getParam("VALUE_REQUIRED")&&(this.getSearch().getSquares().length||this.getPreset().applyPinnedPreset()))},getApi:function(){return this.api instanceof BX.Filter.Api||(this.api=new BX.Filter.Api(this)),this.api},addSidebarItem:function(t,e,i){var s=this.getPreset(),n=s.getContainer(),a=s.createSidebarItem(t,e,i),r=s.getPresetNodeById(t);BX.type.isDomNode(r)?(BX.remove(r),BX.prepend(a,n)):n&&n.insertBefore(a,s.getAddPresetField()),BX.bind(a,"click",BX.delegate(s._onPresetClick,s))},saveUserSettings:function(t){var e={FILTER_ID:this.getParam("FILTER_ID"),GRID_ID:this.getParam("GRID_ID"),action:"SET_FILTER_ARRAY"},i=this.getPreset(),s=i.getCurrentPresetId(),n={};this.params.PRESETS=BX.clone(this.editablePresets),n.current_preset=s,i.getPresets().forEach(function(e,s){var a=i.getPresetId(e);if(a&&"tmp_filter"!==a){var r=i.getPreset(a);r.TITLE=BX.util.htmlspecialchars(BX.util.htmlspecialcharsback(r.TITLE)),r.SORT=s,i.updatePresetName(e,r.TITLE),n[a]={sort:s,name:r.TITLE,fields:this.preparePresetSettingsFields(r.FIELDS),for_all:t&&!BX.type.isBoolean(r.FOR_ALL)||t&&!0===r.FOR_ALL}}},this),this.saveOptions(n,e,null,t)},isForAll:function(t){var e=this.getForAllCheckbox();return BX.type.isBoolean(t)&&t||!!e&&!!e.checked},getForAllCheckbox:function(){return this.forAllCheckbox||(this.forAllCheckbox=BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classForAllCheckbox)),this.forAllCheckbox},preparePresetSettingsFields:function(t){var e,i={};return(t||[]).forEach(function(t){switch(t.TYPE){case this.types.STRING:case this.types.TEXTAREA:i[t.NAME]=t.VALUE;break;case this.types.SELECT:i[t.NAME]="VALUE"in t.VALUE?t.VALUE.VALUE:"";break;case this.types.MULTI_SELECT:case this.types.CHECKBOX:BX.type.isArray(t.VALUE)&&t.VALUE.length&&t.VALUE.forEach(function(e,s){i[t.NAME]=BX.type.isPlainObject(i[t.NAME])?i[t.NAME]:{},i[t.NAME][s]=e.VALUE},this);break;case this.types.DATE:BX.type.isPlainObject(t.VALUES)&&(e=Object.keys(t.VALUES),i[t.NAME+"_datesel"]=t.SUB_TYPE.VALUE,e.forEach(function(e){i[t.NAME+e]=t.VALUES[e]},this));break;case this.types.NUMBER:BX.type.isPlainObject(t.VALUES)&&(e=Object.keys(t.VALUES),i[t.NAME+"_numsel"]=t.SUB_TYPE.VALUE,e.forEach(function(e){i[t.NAME+e]=t.VALUES[e]},this));break;case this.types.DEST_SELECTOR:case this.types.CUSTOM_ENTITY:BX.type.isPlainObject(t.VALUES)&&(i[t.NAME]=t.VALUES._value,i[t.NAME+"_label"]=t.VALUES._label)}},this),i},savePreset:function(){var t="filter_"+ +new Date,e=BX.util.htmlspecialcharsback(this.getPreset().getAddPresetFieldInput().value);this.updatePreset(t,e,null,!0,null,null,!0),this.addSidebarItem(t,e),this.getPreset().applyPreset(t),this.getPreset().activatePreset(t),this.applyFilter()},updatePreset:function(t,e,i,s,n,a,r){var l,o,u,c,h,d=this.getFilterFieldsValues(),p=this.getPreset().getFields().map(function(t){return BX.data(t,"name")}),m=this.getPreset().getCurrentPresetData(),E={FILTER_ID:this.getParam("FILTER_ID"),GRID_ID:this.getParam("GRID_ID"),action:"SET_FILTER"},g={};(g.additional={},"tmp_filter"===t||"default_filter"===t||r)||(BX.type.isArray(m.ADDITIONAL)?m.ADDITIONAL:[]).forEach(function(t){Object.keys(d).forEach(function(e){-1!==e.indexOf(t.NAME)&&(g.additional[e]=d[e],delete d[e])})});l=Object.keys(d),i?g.clear_filter="Y":g.apply_filter="Y",g.save="Y",g.fields=d,g.rows=p.join(","),g.preset_id=t||m.ID,BX.type.isNotEmptyString(e)?g.name=BX.util.htmlspecialchars(e):(u=this.getPreset().getPresetNodeById(g.preset_id),c=this.getPreset().getPresetInput(u),BX.type.isDomNode(c)&&BX.type.isNotEmptyString(c.value)?g.name=c.value:g.name=m.TITLE),"sort"in g&&BX.type.isNumber(g.sort)||!s||(h=this.getParam("PRESETS"),g.sort=h.length+2),i||l.forEach(function(t){BX.type.isArray(g.fields[t])&&(o=g.fields[t].length?{}:"",g.fields[t].forEach(function(t,e){o[e]=t},this),(o||BX.type.isNumber(o)||BX.type.isBoolean(o))&&(g.fields[t]=o))},this),("tmp_filter"===g.preset_id||this.isAddPresetEnabled()||i)&&this.updateParams(g),BX.type.isFunction(n)&&n();var f=new BX.Promise(null,this);return f.setAutoResolve("fulfill",0),f.then(function(){var t=new BX.Promise(null,this);return this.saveOptions(g,E,BX.proxy(t.fulfill,t)),t}).then(function(){a&&a()}),f},saveFieldsSort:function(){var t={FILTER_ID:this.getParam("FILTER_ID"),GRID_ID:this.getParam("GRID_ID"),action:"SET_FILTER"},e=this.getPreset().getFields(),i={preset_id:"default_filter"};BX.type.isArray(e)&&(i.rows=e.map(function(t){return BX.data(t,"name")}),i.rows=i.rows.join(",")),this.updateParams(i),this.saveOptions(i,t)},updateParams:function(t){var e,i;BX.type.isPlainObject(t)&&"preset_id"in t&&(e=this.getPreset().getPreset(t.preset_id),BX.type.isPlainObject(e)?("name"in t&&BX.type.isNotEmptyString(t.name)&&(e.TITLE=t.name),"rows"in t&&!("fields"in t)&&(t.fields={},t.rows.split(",").forEach(function(e){t.fields[e]=""})),"fields"in t&&(e.FIELDS=this.preparePresetFields(t.fields,t.rows)),"additional"in t&&"tmp_filter"!==e.ID&&(e.ADDITIONAL=this.preparePresetFields(t.additional,t.rows))):(i=this.getParam("PRESETS"),e={ID:t.preset_id,TITLE:t.name,SORT:i.length+2,FIELDS:this.preparePresetFields(t.fields,t.rows)},i.push(e)))},preparePresetFields:function(t,e){var i,s=[];return BX.type.isPlainObject(t)&&((e=BX.type.isNotEmptyString(e)?e.split(","):[]).length?e:Object.keys(t)).forEach(function(e){e=e.replace("_datesel","").replace("_numsel",""),i=BX.clone(this.getFieldByName(e)),BX.type.isPlainObject(i)&&(i.TYPE===this.types.STRING&&(i.VALUE=t[e]),i.TYPE===this.types.TEXTAREA&&(i.VALUE=t[e]),i.TYPE===this.types.MULTI_SELECT&&(i.VALUE=this.prepareMultiSelectValue(t[e],i.ITEMS)),i.TYPE!==this.types.SELECT&&i.TYPE!==this.types.CHECKBOX||(i.VALUE=this.prepareSelectValue(t[e],i.ITEMS)),i.TYPE===this.types.DATE&&(i.SUB_TYPE=this.prepareSelectValue(t[e+"_datesel"],i.SUB_TYPES),i.VALUES={_from:t[e+"_from"],_to:t[e+"_to"],_days:t[e+"_days"],_month:t[e+"_month"],_quarter:t[e+"_quarter"],_year:t[e+"_year"],_allow_year:t[e+"_allow_year"]}),i.TYPE===this.types.CUSTOM_DATE&&(i.VALUE={days:Object.keys(t[e+"_days"]||{}).map(function(i){return t[e+"_days"][i]}),months:Object.keys(t[e+"_months"]||{}).map(function(i){return t[e+"_months"][i]}),years:Object.keys(t[e+"_years"]||{}).map(function(i){return t[e+"_years"][i]})}),i.TYPE===this.types.NUMBER&&(i.SUB_TYPE=this.prepareSelectValue(t[e+"_numsel"],i.SUB_TYPES),i.VALUES={_from:t[e+"_from"],_to:t[e+"_to"]}),i.TYPE===this.types.DEST_SELECTOR&&(void 0!==t[e+"_label"]&&(i.VALUES._label=t[e+"_label"]),void 0!==t[e]&&(i.VALUES._value=t[e])),i.TYPE===this.types.CUSTOM_ENTITY&&(void 0!==t[e+"_label"]&&(i.VALUES._label=t[e+"_label"]),void 0!==t[e]&&(i.VALUES._value=t[e])),i.TYPE===this.types.CUSTOM&&(i._VALUE=t[e]),s.push(i))},this),s},prepareSelectValue:function(t,e){var i;return BX.type.isNotEmptyString(t)&&BX.type.isArray(e)?(i=this.prepareMultiSelectValue({0:t},e)).length>0?i[0]:{}:e[0]},prepareMultiSelectValue:function(t,e){var i=[];if(BX.type.isPlainObject(t)&&BX.type.isArray(e)){var s=Object.keys(t).map(function(e){return t[e]});i=e.filter(function(t){return s.some(function(e){return e===t.VALUE})},this)}return i},getFieldByName:function(t){var e=this.getParam("FIELDS").find(function(e){return e.NAME===t});if(e)return e;var i=this.getFieldListContainer().querySelector('[data-name="'+t+'"]');return(e=BX.Filter.Field.instances.get(i))?e.options:null},confirmSaveForAll:function(){return new Promise(function(t){var e={CONFIRM:!0,CONFIRM_MESSAGE:this.getParam("MAIN_UI_FILTER__CONFIRM_MESSAGE_FOR_ALL"),CONFIRM_APPLY_BUTTON:this.getParam("MAIN_UI_FILTER__CONFIRM_APPLY_FOR_ALL"),CONFIRM_CANCEL_BUTTON:this.getParam("CONFIRM_CANCEL")};this.confirmDialog(e,t)}.bind(this))},saveOptions:function(t,e,i,s){var n;e.action=(n=e.action,BX.type.isString(n)?(n=(n=n.toLowerCase()).replace(/[\-_\s]+(.)?/g,function(t,e){return e?e.toUpperCase():""})).substr(0,1).toLowerCase()+n.substr(1):n),e.forAll=this.isForAll(s),e.commonPresetsId=this.getParam("COMMON_PRESETS_ID"),e.apply_filter=t.apply_filter||"N",e.clear_filter=t.clear_filter||"N",e.with_preset=t.with_preset||"N",e.save=t.save||"N";var a={params:e,data:t};return delete t.apply_filter,delete t.save,delete t.clear_filter,delete t.with_preset,e.forAll&&"setFilterArray"===e.action?this.confirmSaveForAll().then(function(){return this.backend(e.action,a)}.bind(this)).then(function(){this.disableEdit(),this.disableAddPreset()}.bind(this)):this.backend(e.action,a).then(function(){BX.removeClass(this.getFindButton(),this.settings.classWaitButtonClass),BX.type.isFunction(i)&&i()}.bind(this))},backend:function(t,e){return BX.ajax.runComponentAction("bitrix:main.ui.filter",t,{mode:"ajax",data:e,analyticsLabel:{FILTER_ID:this.getParam("FILTER_ID"),GRID_ID:this.getParam("GRID_ID")}})},prepareEvent:function(t){var e,i;if(!("path"in t&&t.path.length))for(t.path=[t.target],e=0;null!==(i=t.path[e++].parentNode);)t.path.push(i);return t},restoreRemovedPreset:function(){if(this.getParam("VALUE_REQUIRED_MODE")){var t=this.getParam("CURRENT_PRESET");if(BX.type.isPlainObject(t)){var e=t.ID,i=this.getPreset().getPresetNodeById(e);this.getPreset().applyPreset(e),this.getPreset().activatePreset(i)}}},hasScrollClick:function(t){return("clientX"in t?t.clientX:"x"in t?t.x:0)>=document.documentElement.offsetWidth},isUseCommonPresets:function(){return!!this.getParam("COMMON_PRESETS_ID")},isInsideFilterEvent:function(t){return((t=this.prepareEvent(t)).path||[]).some(function(t){return BX.type.isDomNode(t)&&(BX.hasClass(t,this.settings.classFilterContainer)||BX.hasClass(t,this.settings.classSearchContainer)||BX.hasClass(t,this.settings.classDefaultPopup)||BX.hasClass(t,this.settings.classPopupOverlay))},this)},_onDocumentClick:function(t){var e=this.getPopup();this.isInsideFilterEvent(t)||this.hasScrollClick(t)||(e&&e.isShown()&&(this.closePopup(),this.getParam("VALUE_REQUIRED_MODE")&&this.restoreRemovedPreset(),this.getParam("VALUE_REQUIRED")&&(this.getSearch().getSquares().length||this.getPreset().applyPinnedPreset())),BX.onCustomEvent(window,"BX.Main.Filter:blur",[this]))},_onAddFieldClick:function(t){var e=this.getFieldsPopup();t.stopPropagation(),t.preventDefault(),e&&!e.isShown()?(this.showFieldsPopup(),this.syncFields()):this.closeFieldListPopup()},syncFields:function(t){BX.type.isPlainObject(t)&&!1===t.cache&&(this.fieldsPopupItems=null);var e,i=this.getPreset().getFields(),s=this.getFieldsPopupItems();BX.type.isArray(s)&&s.length&&s.forEach(function(t){e=BX.data(t,"name").replace("_datesel","").replace("_numsel",""),i.some(function(t){return BX.data(t,"name")===e})?BX.addClass(t,this.settings.classMenuItemChecked):BX.removeClass(t,this.settings.classMenuItemChecked)},this)},getFieldsPopupItems:function(){if(!BX.type.isArray(this.fieldsPopupItems)){var t=this.getFieldsPopup();"contentContainer"in t&&BX.type.isDomNode(t.contentContainer)&&(this.fieldsPopupItems=BX.Filter.Utils.getByClass(t.contentContainer,this.settings.classMenuItem,!0))}return this.fieldsPopupItems},getFieldListContainerClassName:function(t){var e=this.settings.classPopupFieldList1Column;return t>6&&t<12&&(e=this.settings.classPopupFieldList2Column),t>12&&(e=this.settings.classPopupFieldList3Column),e},prepareFieldsDecl:function(t){return(t||[]).map(function(t){return{block:"main-ui-filter-field-list-item",label:"LABEL"in t?t.LABEL:"",id:"ID"in t?t.ID:"",name:"NAME"in t?t.NAME:"",item:t,onClick:BX.delegate(this._clickOnFieldListItem,this)}},this)},getLazyLoadFields:function(){var t=new BX.Promise;return BX.ajax({method:"GET",url:this.getParam("LAZY_LOAD").GET_LIST,dataType:"json",onsuccess:function(e){t.fulfill(e)}}),t},getFieldsListPopupContent:function(){var t=new BX.Promise,e=this.getParam("FIELDS"),i=BX.type.isArray(e)?e.length:0;if(this.getParam("LAZY_LOAD")){var s=function(e){var i={block:this.settings.classPopupFieldList,mix:this.getFieldListContainerClassName(e.length),content:this.prepareFieldsDecl(e)};t.fulfill(BX.decl(i))}.bind(this);if(BX.type.isNotEmptyObject(this.getParam("LAZY_LOAD").CONTROLLER)){var n=this.getParam("LAZY_LOAD").CONTROLLER.componentName,a=this.getParam("LAZY_LOAD").CONTROLLER.signedParameters;BX.ajax.runAction(this.getParam("LAZY_LOAD").CONTROLLER.getList,{data:{filterId:this.getParam("FILTER_ID"),componentName:BX.type.isNotEmptyString(n)?n:"",signedParameters:BX.type.isNotEmptyString(a)?a:""}}).then(function(t){s(t.data)}.bind(this),function(t){})}else this.getLazyLoadFields().then(s);return t}var r={block:this.settings.classPopupFieldList,mix:this.getFieldListContainerClassName(i),content:this.prepareFieldsDecl(e)};return t.fulfill(BX.decl(r)),t},getFieldLoader:function(){return this.fieldLoader||(this.fieldLoader=new BX.Loader({mode:"custom",size:18,offset:{left:"5px",top:"5px"}})),this.fieldLoader},_clickOnFieldListItem:function(t){var e,i=t.target;if(BX.hasClass(i,this.settings.classFieldListItem)||(i=BX.findParent(i,{className:this.settings.classFieldListItem},!0,!1)),BX.type.isDomNode(i)){try{e=JSON.parse(BX.data(i,"item"))}catch(t){}var s=new BX.Promise;if(this.getParam("LAZY_LOAD")){this.getFieldLoader().show(i);var n=i.querySelector(".main-ui-select-inner-label");n&&n.classList.add("main-ui-no-before");var a=function(t){s.fulfill(t),this.getFieldLoader().hide(),n&&n.classList.remove("main-ui-no-before")}.bind(this);if(BX.type.isNotEmptyObject(this.getParam("LAZY_LOAD").CONTROLLER)){var r=this.getParam("LAZY_LOAD").CONTROLLER.componentName,l=this.getParam("LAZY_LOAD").CONTROLLER.signedParameters;BX.ajax.runAction(this.getParam("LAZY_LOAD").CONTROLLER.getField,{data:{filterId:this.getParam("FILTER_ID"),id:e.NAME,componentName:BX.type.isNotEmptyString(r)?r:"",signedParameters:BX.type.isNotEmptyString(l)?l:""}}).then(function(t){a(t.data)}.bind(this),function(t){})}else this.getLazyLoadField(e.NAME).then(a)}else s.fulfill(e);s.then(function(t){if(this.params.FIELDS.push(t),BX.hasClass(i,this.settings.classMenuItemChecked))BX.removeClass(i,this.settings.classMenuItemChecked),this.getPreset().removeField(t);else if(BX.type.isPlainObject(t)&&(this.getPreset().addField(t),BX.addClass(i,this.settings.classMenuItemChecked),BX.type.isString(t.HTML))){var e=BX.create("div");this.getHiddenElement().appendChild(e),BX.html(e,t.HTML)}this.syncFields()}.bind(this))}},getHiddenElement:function(){return this.hiddenElement||(this.hiddenElement=BX.create("div"),document.body.appendChild(this.hiddenElement)),this.hiddenElement},getLazyLoadField:function(t){var e=new BX.Promise;return BX.ajax({method:"get",url:BX.util.add_url_param(this.getParam("LAZY_LOAD").GET_FIELD,{id:t}),dataType:"json",onsuccess:function(t){e.fulfill(t)}}),e},showFieldsPopup:function(){var t=this.getFieldsPopup();this.adjustFieldListPopupPosition(),t.show()},closeFieldListPopup:function(){this.getFieldsPopup().close()},adjustFieldListPopupPosition:function(){var t=this.getFieldsPopup(),e=BX.pos(this.getAddField());e.forceBindPosition=!0,t.adjustPosition(e)},getFieldsPopup:function(){var t=this.getAddField();return this.fieldsPopup||(this.fieldsPopup=new BX.PopupWindow(this.getParam("FILTER_ID")+"_fields_popup",t,{autoHide:!0,offsetTop:4,offsetLeft:0,lightShadow:!0,closeIcon:!1,closeByEsc:!1,noAllPaddings:!0,zIndex:13}),this.fieldsPopupLoader=new BX.Loader({target:this.fieldsPopup.contentContainer}),this.fieldsPopupLoader.show(),this.fieldsPopup.contentContainer.style.width="630px",this.fieldsPopup.contentContainer.style.height="330px",this.getFieldsListPopupContent().then(function(t){this.fieldsPopup.contentContainer.removeAttribute("style"),this.fieldsPopupLoader.hide(),this.fieldsPopup.setContent(t),this.syncFields({cache:!1})}.bind(this))),this.fieldsPopup},_onAddPresetClick:function(){this.enableAddPreset()},enableWaitSate:function(t){t&&BX.addClass(t,this.settings.classWaitButtonClass)},disableWaitState:function(t){t&&BX.removeClass(t,this.settings.classWaitButtonClass)},_onSaveButtonClick:function(){var t=!!this.getSaveForAllCheckbox()&&this.getSaveForAllCheckbox().checked,e=this.getPreset().getAddPresetFieldInput(),i=e.parentNode.querySelector(".main-ui-filter-edit-mask");function s(t){"fieldError"===t.animationName&&(t.currentTarget.removeEventListener("animationend",s),t.currentTarget.removeEventListener("oAnimationEnd",s),t.currentTarget.removeEventListener("webkitAnimationEnd",s),t.currentTarget.classList.remove("main-ui-filter-error"))}function n(t){t.addEventListener("animationend",s),t.addEventListener("oAnimationEnd",s),t.addEventListener("webkitAnimationEnd",s),t.classList.add("main-ui-filter-error");var e=new BX.Promise;return e.fulfill(!0),e}if(this.enableWaitSate(this.getFindButton()),this.isAddPresetEnabled()&&!t&&(e.value.length?(this.savePreset(),this.disableAddPreset()):n(i).then(function(){e.focus()})),this.isEditEnabled()){var a=this.getPreset(),r=a.getPresetNodeById(a.getCurrentPresetId()),l=a.getPresetInput(r);if(l.value.length)a.updateEditablePreset(a.getCurrentPresetId()),this.saveUserSettings(t),!t&&this.disableEdit();else n(r.querySelector(".main-ui-filter-edit-mask")).then(function(){l.focus()})}},_onCancelButtonClick:function(){this.disableAddPreset(),this.getPreset().clearAddPresetFieldInput(),this.disableEdit(),this.getSaveForAllCheckbox()&&(this.getSaveForAllCheckbox().checked=null)},_onGridReady:function(t){this.grid||t.getContainerId()!==this.getParam("GRID_ID")||(this.grid=t)},_onFilterMousedown:function(t){var e=t.target;this.getFields().isDragButton(e)&&((BX.Filter.Utils.getByTag(e.parentNode,"input",!0)||[]).forEach(function(t){BX.fireEvent(t,"blur")}),BX.fireEvent(this.getFilter(),"click"))},_onFilterClick:function(t){var e,i=this.getFields(),s=this.getPreset();i.isFieldDelete(t.target)&&(e=i.getField(t.target),s.removeField(e)),i.isFieldValueDelete(t.target)&&(e=i.getField(t.target),i.clearFieldValue(e))},getButtonsContainer:function(){return BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classButtonsContainer)},getSaveButton:function(){return BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classSaveButton)},getCancelButton:function(){return BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classCancelButton)},getFindButton:function(){return BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classFindButton)},getResetButton:function(){return BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classResetButton)},getAddPresetButton:function(){return BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classAddPresetButton)},isAddPresetEnabled:function(){return this.isAddPresetModeState},enableAddPreset:function(){var t=this.getPreset(),e=t.getAddPresetField(),i=t.getAddPresetFieldInput(),s=this.getButtonsContainer();BX.show(e),BX.show(s),BX.hide(this.getPresetButtonsContainer()),this.hideForAllCheckbox(),BX.type.isDomNode(i)&&i.focus(),BX.addClass(this.getSidebarControlsContainer(),this.settings.classDisabled),this.isAddPresetModeState=!0},disableAddPreset:function(){var t=this.getPreset(),e=t.getAddPresetField(),i=this.getButtonsContainer();BX.hide(e),BX.hide(i),BX.show(this.getPresetButtonsContainer()),this.showForAllCheckbox(),t.getAddPresetFieldInput().value="",BX.removeClass(this.getSidebarControlsContainer(),this.settings.classDisabled),this.isAddPresetModeState=!1},getControls:function(){var t=this.getFieldListContainer(),e=null;return BX.type.isDomNode(t)&&(e=BX.Filter.Utils.getByClass(t,this.settings.classControl,!0)),e},getFilterFields:function(){var t=this.getFieldListContainer(),e=[],i=[];return BX.type.isDomNode(t)&&(e=BX.Filter.Utils.getByClass(t,this.settings.classField,!0),i=BX.Filter.Utils.getByClass(t,this.settings.classFieldGroup,!0),BX.type.isArray(e)||(e=[]),BX.type.isArray(i)&&i.forEach(function(t){e.push(t)})),e},getFilterFieldsValues:function(){var t,e,i=this.getPreset().getFields(),s=this.getSearch(),n={};return n.FIND=s.getInput().value,BX.type.isArray(i)&&i.length&&i.forEach(function(i){switch(t=BX.data(i,"type"),e=BX.data(i,"name"),t){case this.types.STRING:this.prepareControlStringValue(n,i);break;case this.types.TEXTAREA:this.prepareControlTextareaValue(n,i);break;case this.types.NUMBER:this.prepareControlNumberValue(n,e,i);break;case this.types.DATE:this.prepareControlDateValue(n,e,i);break;case this.types.CUSTOM_DATE:this.prepareControlCustomDateValue(n,e,i);break;case this.types.SELECT:this.prepareControlSelectValue(n,e,i);break;case this.types.MULTI_SELECT:this.prepareControlMultiselectValue(n,e,i);break;case this.types.DEST_SELECTOR:this.prepareControlCustomEntityValue(n,e,i);break;case this.types.CUSTOM:this.prepareControlCustomValue(n,e,i);break;case this.types.CUSTOM_ENTITY:this.prepareControlCustomEntityValue(n,e,i)}},this),n},prepareControlCustomEntityValue:function(t,e,i){var s=this.fetchSquares(i),n=this.fetchSquaresData(s),a=BX.Main.ui.CustomEntity.isMultiple(i);t[e]="",t[e+"_label"]="",a?(t[e]=[],t[e+"_label"]=[],n&&n.forEach(function(i){t[e].push(i._value.toString()),t[e+"_label"].push(i._label.toString())})):n.length&&(t[e]=n[0]._value.toString(),t[e+"_label"]=n[0]._label.toString())},fetchSquares:function(t){return t?BX.Filter.Utils.getByClass(t,this.settings.classSquare,!0):[]},fetchSquaresData:function(t){return t.map(function(t){return JSON.parse(BX.data(t,"item"))},this)},prepareControlCustomValue:function(t,e,i){var s=BX.Filter.Utils.getByTag(i,"input",!0);t[e]="",BX.type.isArray(s)&&s.forEach(function(e){BX.type.isNotEmptyString(e.name)&&(t[e.name]=e.value)})},prepareControlMultiselectValue:function(t,e,i){var s=BX.Filter.Utils.getByClass(i,this.settings.classMultiSelect),n=JSON.parse(BX.data(s,"value"));t[e]="",BX.type.isArray(n)&&n.length&&(t[e]={},n.forEach(function(i,s){t[e][s]=i.VALUE}))},prepareControlSelectValue:function(t,e,i){var s=BX.Filter.Utils.getByClass(i,this.settings.classSelect),n=JSON.parse(BX.data(s,"value"));t[e]=n.VALUE},prepareControlCustomDateValue:function(t,e,i){var s=i.querySelector('[data-name="'+e+'_days"]');if(s){var n=JSON.parse(s.dataset.value);t[e+"_days"]=n.map(function(t){return t.VALUE})}var a=i.querySelector('[data-name="'+e+'_months"]');if(a){var r=JSON.parse(a.dataset.value);t[e+"_months"]=r.map(function(t){return t.VALUE})}var l=i.querySelector('[data-name="'+e+'_years"]');if(l){var o=JSON.parse(l.dataset.value);t[e+"_years"]=o.map(function(t){return t.VALUE})}},prepareControlDateValue:function(t,e,i,s){var n=i.querySelector(".main-ui-filter-additional-fields-container");n&&!s&&BX.remove(n);var a,r,l,o,u,c=BX.Filter.Utils.getByClass(i,this.settings.classSelect),h=i.querySelector('.main-ui-select[data-name*="_allow_year"]'),d=e+this.settings.datePostfix,p=e+this.settings.fromPostfix,m=e+this.settings.toPostfix,E=e+this.settings.daysPostfix,g=e+this.settings.monthPostfix,f=e+this.settings.quarterPostfix,B=e+this.settings.yearPostfix,y=e+"_allow_year";t[d]="",t[p]="",t[m]="",t[E]="",t[g]="",t[f]="",t[B]="";var A=i.querySelector(".main-ui-date-input");if(!A||"false"!==A.dataset.isValid){switch(a=JSON.parse(BX.data(c,"value")),t[d]=a.VALUE,h&&(u=JSON.parse(BX.data(h,"value")),t[y]=u.VALUE),a.VALUE){case this.dateTypes.EXACT:r=BX.Filter.Utils.getByClass(i,this.settings.classDateInput),t[p]=r.value,t[m]=r.value;break;case this.dateTypes.QUARTER:l=BX.Filter.Utils.getByClass(i,this.settings.classControl,!0),BX.type.isArray(l)&&l.forEach(function(e){(o=BX.data(e,"name"))&&-1!==o.indexOf("_quarter")&&(t[f]=JSON.parse(BX.data(e,"value")).VALUE),o&&o.endsWith("_year")&&!o.endsWith("_allow_year")&&(t[B]=JSON.parse(BX.data(e,"value")).VALUE)},this);break;case this.dateTypes.YEAR:l=BX.Filter.Utils.getByClass(i,this.settings.classControl,!0),BX.type.isArray(l)&&l.forEach(function(e){(o=BX.data(e,"name"))&&o.endsWith("_year")&&!o.endsWith("_allow_year")&&(t[B]=JSON.parse(BX.data(e,"value")).VALUE)},this);break;case this.dateTypes.MONTH:l=BX.Filter.Utils.getByClass(i,this.settings.classControl,!0),BX.type.isArray(l)&&l.forEach(function(e){(o=BX.data(e,"name"))&&-1!==o.indexOf("_month")&&(t[g]=JSON.parse(BX.data(e,"value")).VALUE),o&&o.endsWith("_year")&&!o.endsWith("_allow_year")&&(t[B]=JSON.parse(BX.data(e,"value")).VALUE)},this);break;case this.additionalDateTypes.PREV_DAY:case this.additionalDateTypes.NEXT_DAY:case this.additionalDateTypes.MORE_THAN_DAYS_AGO:case this.additionalDateTypes.AFTER_DAYS:case this.dateTypes.NEXT_DAYS:case this.dateTypes.PREV_DAYS:var P=BX.Filter.Utils.getByClass(i,this.settings.classNumberInput);P&&P.name===E&&(t[E]=P.value);break;case this.dateTypes.RANGE:(r=BX.Filter.Utils.getByClass(i,this.settings.classDateInput,!0)).forEach(function(e){e.name===p?t[p]=e.value:e.name===m&&(t[m]=e.value)},this);break;case"CUSTOM_DATE":var _={};this.prepareControlCustomDateValue(_,e,i),t[e+"_days"]=_[e+"_days"],t[g]=_[e+"_months"],t[B]=_[e+"_years"]}n&&!s&&BX.append(n,i);var S=Array.from(i.querySelectorAll('.main-ui-filter-additional-fields-container > [data-type="DATE"]'));S&&S.forEach(function(e){var i=e.dataset.name;this.prepareControlDateValue(t,i,e,!0)},this)}},prepareControlNumberValue:function(t,e,i){var s,n=BX.Filter.Utils.getByClass(i,this.settings.classNumberInput,!0),a=BX.Filter.Utils.getByClass(i,this.settings.classSelect),r=e+this.settings.numberPostfix,l=e+this.settings.fromPostfix,o=e+this.settings.toPostfix;t[l]="",t[o]="",s=JSON.parse(BX.data(a,"value")),t[r]=s.VALUE,n.forEach(function(e){-1!==e.name.indexOf(this.settings.fromPostfix)?(t[l]=e.value||"","exact"===t[r]&&(t[o]=e.value||"")):-1!==e.name.indexOf(this.settings.toPostfix)&&(t[o]=e.value||"")},this)},prepareControlStringValue:function(t,e){var i=BX.Filter.Utils.getByClass(e,this.settings.classStringInput);BX.type.isDomNode(i)&&(t[i.name]=i.value)},prepareControlTextareaValue:function(t,e){var i=BX.Filter.Utils.getByClass(e,this.settings.classStringInput);BX.type.isDomNode(i)&&(t[i.name]=i.value)},showGridAnimation:function(){this.grid&&this.grid.tableFade()},hideGridAnimation:function(){this.grid&&this.grid.tableUnfade()},getPresetId:function(t,e){var i=this.getPreset().getCurrentPresetId();return(this.isEditEnabled()||this.isAddPresetEnabled()||e)&&("default_filter"!==i||t)||(i="tmp_filter"),i},applyFilter:function(t,e){var i=this.getPresetId(t,e),s=this.getParam("FILTER_ID"),n=new BX.Promise(null,this),a=this.getPreset(),r=this.getSearch(),l={autoResolve:!this.grid},o=this;this.clearGet(),this.showGridAnimation();var u=t?"clear":"apply";return BX.onCustomEvent(window,"BX.Main.Filter:beforeApply",[s,{action:u},this,n]),this.updatePreset(i,null,t,null).then(function(){r.updatePreset(a.getPreset(i)),o.getParam("VALUE_REQUIRED")&&(r.getSquares().length||(o.lastPromise=a.applyPinnedPreset()))}).then(function(){var t=BX.delegate(n.fulfill,n),e=BX.delegate(n.reject,n);o.grid&&o.grid.reloadTable("POST",{apply_filter:"Y",clear_nav:"Y"},t,e),BX.onCustomEvent(window,"BX.Main.Filter:apply",[s,{action:u},o,n,l]),l.autoResolve&&n.fulfill()}),n},getAddField:function(){return BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classAddField)},getFieldListContainer:function(){return BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classFileldControlList)},getFields:function(){return this.fields instanceof BX.Filter.Fields||(this.fields=new BX.Filter.Fields(this)),this.fields},getPreset:function(){return this.presets instanceof BX.Filter.Presets||(this.presets=new BX.Filter.Presets(this)),this.presets},resetControlData:function(t){if(BX.type.isPlainObject(t))switch(t.TYPE){case this.types.MULTI_SELECT:t.VALUE=[];break;case this.types.SELECT:t.VALUE=t.ITEMS[0];break;case this.types.DATE:t.SUB_TYPE=t.SUB_TYPES[0],t.VALUES={_from:"",_to:"",_days:"",_quarter:"",_year:""};break;case this.types.CUSTOM_DATE:t.VALUES={days:[],months:[],years:[]};break;case this.types.NUMBER:t.SUB_TYPE=t.SUB_TYPES[0],t.VALUES={_from:"",_to:""};break;case this.types.DEST_SELECTOR:case this.types.CUSTOM_ENTITY:t.VALUES={_label:"",_value:""};break;case this.types.CUSTOM:t._VALUE="";break;default:t.VALUE=""}return t},clearControl:function(t){var e,i,s=this.getPreset().getField({NAME:t});BX.type.isDomNode(s)&&(e=this.getFieldByName(t),e=this.resetControlData(e),i=this.getPreset().createControl(e),BX.insertAfter(i,s),BX.remove(s))},clearControls:function(t){BX.type.isArray(t)?t.forEach(function(t){"name"in t&&this.clearControl(t.name)},this):BX.type.isPlainObject(t)&&"name"in t&&this.clearControl(t.name)},getTemplate:function(){return BX.html(BX(this.settings.generalTemplateId))},isIe:function(){return BX.type.isBoolean(this.ie)||(this.ie=BX.hasClass(document.documentElement,"bx-ie")),this.ie},closePopup:function(){var t,e=this.getPopup(),i=e.popupContainer,s=this.settings.get("FILTER_CLOSE_DELAY");setTimeout(BX.delegate(function(){this.isIe()?e.close():(BX.removeClass(i,this.settings.classAnimationShow),BX.addClass(i,this.settings.classAnimationClose),t=parseFloat(BX.style(i,"animation-duration")),BX.type.isNumber(t)&&(t*=1e3),setTimeout(function(){e.close()},t))},this),s),this.getParam("LIMITS_ENABLED")&&BX.removeClass(this.getFilter(),this.settings.classLimitsAnimation),this.closeFieldListPopup(),this.adjustFocus()},showPopup:function(){var t,e=this.getPopup();if(!e.isShown()){this.isOpened=!0;var i=this.settings.get("FILTER_SHOW_DELAY");setTimeout(BX.delegate(function(){e.show(),this.isIe()||(t=e.popupContainer,BX.removeClass(t,this.settings.classAnimationClose),BX.addClass(t,this.settings.classAnimationShow),BX.onCustomEvent(window,"BX.Main.Filter:show",[this])),[].slice.call(this.getFieldListContainer().querySelectorAll("textarea")).forEach(function(t){BX.style(t,"height",t.scrollHeight+"px")})},this),i)}},getSaveForAllCheckbox:function(){return!this.saveForAllCheckbox&&this.getSaveForAllCheckboxContainer()&&(this.saveForAllCheckbox=BX.Filter.Utils.getBySelector(this.getSaveForAllCheckboxContainer(),'input[type="checkbox"]')),this.saveForAllCheckbox},getSaveForAllCheckboxContainer:function(){return this.saveForAllCheckboxContainer||(this.saveForAllCheckboxContainer=BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classForAllCheckbox)),this.saveForAllCheckboxContainer},showForAllCheckbox:function(){this.getSaveForAllCheckboxContainer()&&BX.removeClass(this.getSaveForAllCheckboxContainer(),this.settings.classHide)},hideForAllCheckbox:function(){this.getSaveForAllCheckboxContainer()&&BX.addClass(this.getSaveForAllCheckboxContainer(),this.settings.classHide)},getPopupBindElement:function(){if(!this.popupBindElement){var t=this.settings.get("POPUP_BIND_ELEMENT_SELECTOR"),e=null;BX.type.isNotEmptyString(t)&&(e=BX.Filter.Utils.getBySelector(document,t)),this.popupBindElement=e||this.getSearch().getContainer()}return this.popupBindElement},getPopup:function(){return this.popup instanceof BX.PopupWindow||(this.popup=new BX.PopupWindow(this.getParam("FILTER_ID")+this.settings.searchContainerPostfix,this.getPopupBindElement(),{autoHide:!1,offsetTop:parseInt(this.settings.get("POPUP_OFFSET_TOP")),offsetLeft:parseInt(this.settings.get("POPUP_OFFSET_LEFT")),lightShadow:!0,closeIcon:!1,closeByEsc:!1,noAllPaddings:!0,zIndex:12}),this.popup.setContent(this.getTemplate()),BX.bind(this.getFieldListContainer(),"keydown",BX.delegate(this._onFieldsContainerKeydown,this)),BX.bind(this.getFilter(),"click",BX.delegate(this._onFilterClick,this)),BX.bind(this.getAddPresetButton(),"click",BX.delegate(this._onAddPresetClick,this)),BX.bind(this.getPreset().getAddPresetFieldInput(),"keydown",BX.delegate(this._onAddPresetKeydown,this)),BX.bind(this.getPreset().getContainer(),"keydown",BX.delegate(this._onPresetInputKeydown,this)),BX.bind(this.getSaveButton(),"click",BX.delegate(this._onSaveButtonClick,this)),BX.bind(this.getCancelButton(),"click",BX.delegate(this._onCancelButtonClick,this)),BX.bind(this.getFindButton(),"click",BX.delegate(this._onFindButtonClick,this)),BX.bind(this.getResetButton(),"click",BX.delegate(this._onResetButtonClick,this)),BX.bind(this.getAddField(),"click",BX.delegate(this._onAddFieldClick,this)),BX.bind(this.getEditButton(),"click",BX.delegate(this._onEditButtonClick,this)),BX.bind(this.getRestoreButton(),"click",BX.delegate(this._onRestoreButtonClick,this)),BX.bind(this.getRestoreFieldsButton(),"click",BX.delegate(this._onRestoreFieldsButtonClick,this)),this.getFilter().addEventListener("mousedown",BX.delegate(this._onFilterMousedown,this),!0),this.getPreset().showCurrentPresetFields(),this.getPreset().bindOnPresetClick()),this.popup},_onRestoreFieldsButtonClick:function(){this.restoreDefaultFields()},restoreDefaultFields:function(){var t=this.getPreset().getPreset("default_filter",!0),e=this.getParam("PRESETS"),i=this.getPreset().getCurrentPresetId(),s={FILTER_ID:this.getParam("FILTER_ID"),GRID_ID:this.getParam("GRID_ID"),action:"SET_FILTER"},n=t.FIELDS.map(function(t){return t.NAME}).join(",");e.forEach(function(i,s){"default_filter"===i.ID&&(e[s]=BX.clone(t))},this),BX.type.isArray(this.editablePresets)&&this.editablePresets.forEach(function(e,i){"default_filter"===e.ID&&(this.editablePresets[i]=BX.clone(t))},this),this.getPreset().applyPreset(i),this.updatePreset(i),this.saveOptions({preset_id:"default_filter",rows:n,save:"Y",apply_filter:"N"},s)},getRestoreFieldsButton:function(){return this.restoreFieldsButton||(this.restoreFieldsButton=BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classRestoreFieldsButton)),this.restoreFieldsButton},restoreFilter:function(){var t,e,i,s=this.getParam("DEFAULT_PRESETS"),n=this.getParam("PRESETS");BX.type.isArray(s)&&(s.sort(function(t,e){return t.SORT<e.SORT}),s.forEach(function(i){n.some(function(e,s){if(e.ID===i.ID)return t=s,!0})?n[t]=BX.clone(i):n.push(BX.clone(i)),"default_filter"!==i.ID&&(this.addSidebarItem(i.ID,i.TITLE,i.PINNED),i.PINNED&&(e=i.ID))},this)),this.saveRestoreFilter(),this.disableAddPreset(),this.disableEdit(),e||(e="default_filter"),(i=this.getPreset().getPresetNodeById(e))&&BX.fireEvent(i,"click")},saveRestoreFilter:function(){var t,e={FILTER_ID:this.getParam("FILTER_ID"),GRID_ID:this.getParam("GRID_ID"),action:"RESTORE_FILTER"},i=this.getParam("PRESETS"),s={};BX.type.isArray(i)&&(i.forEach(function(e){t=(t=e.FIELDS.map(function(t){return t.NAME})).join(","),s[e.ID]={name:e.TITLE||null,sort:e.SORT,preset_id:e.ID,fields:this.prepareFields(e.FIELDS),rows:t,for_all:e.FOR_ALL}},this),this.saveOptions(s,e))},prepareFields:function(t){var e={};return BX.type.isArray(t)&&t.forEach(function(t){t.TYPE===this.types.SELECT&&(e[t.NAME]="VALUE"in t.VALUE?t.VALUE.VALUE:""),t.TYPE===this.types.MULTI_SELECT&&(t.VALUE.forEach(function(i,s){e[t.NAME]=e[t.NAME]||{},e[t.NAME][s]=i.VALUE}),e[t.NAME]=e[t.NAME]||""),t.TYPE!==this.types.DATE&&t.TYPE!==this.types.NUMBER||(Object.keys(t.VALUES).forEach(function(i){e[t.NAME+i]=t.VALUES[i]}),t.TYPE===this.types.DATE&&(e[t.NAME+"_datesel"]="VALUE"in t.SUB_TYPE?t.SUB_TYPE.VALUE:t.SUB_TYPES[0].VALUE),t.TYPE===this.types.NUMBER&&(e[t.NAME+"_numsel"]="VALUE"in t.SUB_TYPE?t.SUB_TYPE.VALUE:t.SUB_TYPES[0].VALUE)),t.TYPE===this.types.DEST_SELECTOR&&(e[t.NAME+"_label"]=t.VALUES._label,e[t.NAME+"_value"]=t.VALUES._value),t.TYPE===this.types.CUSTOM_ENTITY&&(e[t.NAME+"_label"]=t.VALUES._label,e[t.NAME+"_value"]=t.VALUES._value)},this),e},getRestoreButton:function(){return BX.type.isDomNode(this.restoreButton)||(this.restoreButton=BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classRestoreButton)),this.restoreButton},_onPresetInputKeydown:function(t){BX.Filter.Utils.isKey(t,"enter")&&"INPUT"===t.target.tagName&&BX.fireEvent(this.getSaveButton(),"click")},_onFieldsContainerKeydown:function(t){BX.Filter.Utils.isKey(t,"enter")&&"INPUT"===t.target.tagName&&BX.fireEvent(this.getFindButton(),"click")},_onFindButtonClick:function(){var t,e=this.getPreset(),i=e.getCurrentPresetId();if("tmp_filter"===i||"default_filter"===i||e.isPresetValuesModified(i))e.deactivateAllPresets(),t=this.applyFilter(),this.closePopup();else{var s=e.getPreset(i),n=e.getAdditionalValues(i),a=e.getFields().map(function(t){return BX.data(t,"name")});s.ADDITIONAL=this.preparePresetFields(n,a),s.ADDITIONAL=s.ADDITIONAL.filter(function(t){return!this.getPreset().isEmptyField(t)},this),t=this.applyFilter(!1,i),this.closePopup()}return t},_onResetButtonClick:function(){this.getParam("VALUE_REQUIRED")?(this.getPreset().getCurrentPresetData().ADDITIONAL.length&&this.closePopup(),BX.fireEvent(this.getSearch().getClearButton(),"click")):(this.getParam("RESET_TO_DEFAULT_MODE")?(this.getSearch().clearInput(),this.getPreset().applyPinnedPreset()):this.resetFilter(),this.closePopup())},resetFilter:function(t){var e=this.getSearch(),i=this.getPreset();return t||e.clearInput(),e.removePreset(),i.deactivateAllPresets(),i.resetPreset(!0),e.hideClearButton(),e.adjustPlaceholder(),this.applyFilter(!0,!0)},_onEditButtonClick:function(){this.isEditEnabled()?this.disableEdit():this.enableEdit()},enableFieldsDragAndDrop:function(){var t=this.getPreset().getFields();this.fieldsList=[],BX.type.isArray(t)&&(this.fieldsList=t.map(this.registerDragItem,this))},registerDragItem:function(t){var e=this.getDragButton(t);return e&&(e.onbxdragstart=BX.delegate(this._onFieldDragStart,this),e.onbxdragstop=BX.delegate(this._onFieldDragStop,this),e.onbxdrag=BX.delegate(this._onFieldDrag,this),jsDD.registerObject(e),jsDD.registerDest(e)),t},unregisterDragItem:function(t){var e=this.getDragButton(t);e&&(jsDD.unregisterObject(e),jsDD.unregisterDest(e))},_onFieldDragStart:function(){this.dragItem=this.getFields().getField(jsDD.current_node),this.dragIndex=BX.Filter.Utils.getIndex(this.fieldsList,this.dragItem),this.dragRect=this.dragItem.getBoundingClientRect(),this.offset=this.dragRect.height,this.dragStartOffset=jsDD.start_y-(this.dragRect.top+BX.scrollTop(window)),BX.Filter.Utils.styleForEach(this.fieldsList,{transition:"100ms"}),BX.addClass(this.dragItem,this.settings.classPresetOndrag),BX.bind(document,"mousemove",BX.delegate(this._onMouseMove,this))},_onFieldDragStop:function(){BX.unbind(document,"mousemove",BX.delegate(this._onMouseMove,this)),BX.removeClass(this.dragItem,this.settings.classPresetOndrag),BX.Filter.Utils.styleForEach(this.fieldsList,{transition:"",transform:""}),BX.Filter.Utils.collectionSort(this.dragItem,this.targetItem),this.fieldsList=this.getPreset().getFields(),this.saveFieldsSort()},_onFieldDrag:function(){var t,e,i=this;this.dragOffset=this.realY-this.dragRect.top-this.dragStartOffset,this.sortOffset=i.realY+BX.scrollTop(window),BX.Filter.Utils.styleForEach([this.dragItem],{transition:"0ms",transform:"translate3d(0px, "+this.dragOffset+"px, 0px)"}),this.fieldsList.forEach(function(s,n){s&&(t=s.getBoundingClientRect(),e=t.top+BX.scrollTop(window)+t.height/2,n>i.dragIndex&&i.sortOffset>e&&s.style.transform!=="translate3d(0px, "+-i.offset+"px, 0px)"&&""!==s.style.transform&&(i.targetItem=s,BX.style(s,"transform","translate3d(0px, "+-i.offset+"px, 0px)"),BX.style(s,"transition","300ms")),n<i.dragIndex&&i.sortOffset<e&&s.style.transform!=="translate3d(0px, "+i.offset+"px, 0px)"&&""!==s.style.transform&&(i.targetItem=s,BX.style(s,"transform","translate3d(0px, "+i.offset+"px, 0px)"),BX.style(s,"transition","300ms")),(n<i.dragIndex&&i.sortOffset>e||n>i.dragIndex&&i.sortOffset<e)&&"translate3d(0px, 0px, 0px)"!==s.style.transform&&(""!==s.style.transform&&(i.targetItem=s),BX.style(s,"transform","translate3d(0px, 0px, 0px)"),BX.style(s,"transition","300ms")))})},disableFieldsDragAndDrop:function(){BX.type.isArray(this.fieldsList)&&this.fieldsList.length&&this.fieldsList.map(this.unregisterDragItem,this)},enablePresetsDragAndDrop:function(){var t,e,i,s;e=(t=this.getPreset()).getPresets(),this.presetsList=[],BX.type.isArray(e)&&e.length&&e.forEach(function(e){s=t.getPresetId(e),BX.hasClass(e,this.settings.classAddPresetField)||"default_filter"===s||BX.hasClass(e,this.settings.classDefaultFilter)||((i=this.getDragButton(e)).onbxdragstart=BX.delegate(this._onDragStart,this),i.onbxdragstop=BX.delegate(this._onDragStop,this),i.onbxdrag=BX.delegate(this._onDrag,this),jsDD.registerObject(i),jsDD.registerDest(i),this.presetsList.push(e))},this)},getDragButton:function(t){return BX.Filter.Utils.getByClass(t,this.settings.classPresetDragButton)},disablePresetsDragAndDrop:function(){BX.type.isArray(this.presetsList)&&this.presetsList.length&&this.presetsList.forEach(function(t){BX.hasClass(t,this.settings.classAddPresetField)||(jsDD.unregisterObject(t),jsDD.unregisterDest(t))},this)},_onDragStart:function(){this.dragItem=this.getPreset().normalizePreset(jsDD.current_node),this.dragIndex=BX.Filter.Utils.getIndex(this.presetsList,this.dragItem),this.dragRect=this.dragItem.getBoundingClientRect(),this.offset=this.dragRect.height,this.dragStartOffset=jsDD.start_y-(this.dragRect.top+BX.scrollTop(window)),BX.Filter.Utils.styleForEach(this.list,{transition:"100ms"}),BX.addClass(this.dragItem,this.settings.classPresetOndrag),BX.bind(document,"mousemove",BX.delegate(this._onMouseMove,this))},_onMouseMove:function(t){this.realX=t.clientX,this.realY=t.clientY},getDragOffset:function(){return jsDD.x-this.startDragOffset-this.dragRect.left},_onDragStop:function(){var t;BX.unbind(document,"mousemove",BX.delegate(this._onMouseMove,this)),BX.removeClass(this.dragItem,this.settings.classPresetOndrag),BX.Filter.Utils.styleForEach(this.presetsList,{transition:"",transform:""}),BX.Filter.Utils.collectionSort(this.dragItem,this.targetItem),t=this.getPreset().getPresets(),this.presetsList=[],BX.type.isArray(t)&&t.length&&t.forEach(function(t){BX.hasClass(t,this.settings.classAddPresetField)||BX.hasClass(t,this.settings.classDefaultFilter)||this.presetsList.push(t)},this)},_onDrag:function(){var t,e,i=this;this.dragOffset=this.realY-this.dragRect.top-this.dragStartOffset,this.sortOffset=i.realY+BX.scrollTop(window),BX.Filter.Utils.styleForEach([this.dragItem],{transition:"0ms",transform:"translate3d(0px, "+this.dragOffset+"px, 0px)"}),this.presetsList.forEach(function(s,n){s&&(t=s.getBoundingClientRect(),e=t.top+BX.scrollTop(window)+t.height/2,n>i.dragIndex&&i.sortOffset>e&&s.style.transform!=="translate3d(0px, "+-i.offset+"px, 0px)"&&""!==s.style.transform&&(i.targetItem=s,BX.style(s,"transform","translate3d(0px, "+-i.offset+"px, 0px)"),BX.style(s,"transition","300ms")),n<i.dragIndex&&i.sortOffset<e&&s.style.transform!=="translate3d(0px, "+i.offset+"px, 0px)"&&""!==s.style.transform&&(i.targetItem=s,BX.style(s,"transform","translate3d(0px, "+i.offset+"px, 0px)"),BX.style(s,"transition","300ms")),(n<i.dragIndex&&i.sortOffset>e||n>i.dragIndex&&i.sortOffset<e)&&"translate3d(0px, 0px, 0px)"!==s.style.transform&&(""!==s.style.transform&&(i.targetItem=s),BX.style(s,"transform","translate3d(0px, 0px, 0px)"),BX.style(s,"transition","300ms")))})},getSidebarControlsContainer:function(){return BX.type.isDomNode(this.sidebarControlsContainer)||(this.sidebarControlsContainer=BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classSidebarControlsContainer)),this.sidebarControlsContainer},enableEdit:function(){var t,e=this.getPreset(),i=e.getPresets();BX.type.isArray(i)&&i.length&&i.forEach(function(i){t=e.getPresetId(i),BX.hasClass(i,this.settings.classAddPresetField)||"default_filter"===t||BX.addClass(i,this.settings.classPresetEdit)},this),this.enablePresetsDragAndDrop(),BX.show(this.getButtonsContainer()),BX.hide(this.getPresetButtonsContainer()),BX.addClass(this.getSidebarControlsContainer(),this.settings.classDisabled),this.editablePresets=BX.clone(this.getParam("PRESETS")),this.isEditEnabledState=!0},disableEdit:function(){var t=this.getPreset().getPresets();BX.type.isArray(t)&&t.length&&t.forEach(function(t){BX.hasClass(t,this.settings.classAddPresetField)||(BX.removeClass(t,this.settings.classPresetEdit),this.getPreset().disableEditPresetName(t))},this),this.disablePresetsDragAndDrop(),this.isAddPresetEnabled()||BX.style(this.getButtonsContainer(),"display",""),BX.show(this.getPresetButtonsContainer()),BX.removeClass(this.getSidebarControlsContainer(),this.settings.classDisabled),this.editablePresets=null,this.isEditEnabledState=!1,this.applyFilter(null,!0)},getPresetButtonsContainer:function(){return BX.type.isDomNode(this.presetButtonsContainer)||(this.presetButtonsContainer=BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classPresetButtonsContainer)),this.presetButtonsContainer},isEditEnabled:function(){return this.isEditEnabledState},getEditButton:function(){return BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classEditButton)},getParam:function(t,e){return t in this.params?this.params[t]:e},getFilter:function(){return BX.Filter.Utils.getByClass(this.getPopup().contentContainer,this.settings.classFilterContainer)},getSearch:function(){return this.search instanceof BX.Filter.Search||(this.search=new BX.Filter.Search(this)),this.search},_onRestoreButtonClick:function(){var t={CONFIRM:!0,CONFIRM_MESSAGE:this.getParam("CONFIRM_MESSAGE"),CONFIRM_APPLY_BUTTON:this.getParam("CONFIRM_APPLY"),CONFIRM_CANCEL_BUTTON:this.getParam("CONFIRM_CANCEL")};this.confirmDialog(t,BX.delegate(this.restoreFilter,this))},confirmDialog:function(t,e,i){if("CONFIRM"in t&&t.CONFIRM){var s=this.getParam("FILTER_ID")+"-confirm-dialog",n='<div class="main-ui-filter-confirm-content">'+t.CONFIRM_MESSAGE+"</div>",a="CONFIRM_TITLE"in t?t.CONFIRM_TITLE:"",r=new BX.PopupWindowButton({text:t.CONFIRM_APPLY_BUTTON,events:{click:function(){BX.type.isFunction(e)&&e(),this.popupWindow.close(),this.popupWindow.destroy()}}}),l=new BX.PopupWindowButtonLink({text:t.CONFIRM_CANCEL_BUTTON,events:{click:function(){BX.type.isFunction(i)&&i(),this.popupWindow.close(),this.popupWindow.destroy()}}}),o=new BX.PopupWindow(s,null,{content:n,titleBar:a,autoHide:!1,zIndex:9999,overlay:.4,offsetTop:-100,closeIcon:!0,closeByEsc:!0,buttons:[r,l]});if(BX.addCustomEvent(o,"onPopupClose",BX.delegate(function(){this.getSaveForAllCheckbox()&&(this.getSaveForAllCheckbox().checked=null)},this)),!o.isShown()){o.show();var u=o.popupContainer;BX.removeClass(u,this.settings.classAnimationShow),BX.addClass(u,this.settings.classAnimationShow)}}else BX.type.isFunction(e)&&e()},getInitialValue:function(t){if(BX.type.isString(t)){var e=this.params.INITIAL_FILTER;if(BX.type.isPlainObject(e)){var i=Object.entries(e).reduce(function(e,i){return i[0].startsWith(t)&&e.push(i),e},[]);if(1===i.length)return i[0][1];if(i.length>1)return i.reduce(function(e,i){return e[i[0].replace(t,"")]=i[1],e},{})}}return""},getField:function(t){var e=this.getFieldListContainer().querySelector('[data-name="'+t+'"]');return BX.Filter.Field.instances.get(e)}}}(),BX.Main.filterManager={data:{},push:function(t,e){BX.type.isNotEmptyString(t)&&e&&(this.data[t]=e)},getById:function(t){var e=null;return t in this.data&&(e=this.data[t]),e}};var s=Symbol("onValueChange"),n=function(t){function n(t){var i;babelHelpers.classCallCheck(this,n),(i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(n).call(this,t))).setEventNamespace("BX.Filter.Field"),i.id=t.options.NAME,i.parent=t.parent,i.node=t.node,i.options=babelHelpers.objectSpread({},t.options),i.cache=new e.Cache.MemoryCache,i[s]=i[s].bind(babelHelpers.assertThisInitialized(i)),e.Event.bind(i.node,"input",i[s]),e.Event.bind(i.node,"change",i[s]),babelHelpers.toConsumableArray(i.node.querySelectorAll(".main-ui-control-value-delete")).forEach(function(t){t.addEventListener("click",function(){setTimeout(function(){i[s]()})})});var a=new MutationObserver(function(){i[s]()});return babelHelpers.toConsumableArray(i.node.querySelectorAll(".main-ui-select")).forEach(function(t){a.observe(t,{attributes:!0,attributeFilter:["data-value"]})}),n.instances.set(i.node,babelHelpers.assertThisInitialized(i)),i}return babelHelpers.inherits(n,t),babelHelpers.createClass(n,[{key:"subscribe",value:function(t,i){e.Event.EventEmitter.subscribe(this,t.replace("BX.Filter.Field:",""),i)}},{key:s,value:function(){this.emit("change",{field:this,value:this.getValue()})}},{key:"getAdditionalFieldContainer",value:function(){return this.cache.remember("additionalFieldsContainer",function(){return e.Tag.render(i())})}},{key:"hasAdditional",value:function(){return e.Dom.hasClass(this.node,"main-ui-filter-field-with-additional-fields")}},{key:"addAdditionalField",value:function(t){this.hasAdditional()||(e.Dom.addClass(this.node,"main-ui-filter-field-with-additional-fields"),e.Dom.append(this.getAdditionalFieldContainer(),this.node));var i=this.parent.getPreset(),s=this.prepareFieldOptions(t),a=i.createControl(s);return this.appendRenderedField(a),n.instances.get(a)}},{key:"prepareListItems",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return e.Type.isPlainObject(t)?Object.entries(t).map(function(t){var e=babelHelpers.slicedToArray(t,2),i=e[0];return{NAME:e[1],VALUE:i}}):{}}},{key:"prepareFieldOptions",value:function(t){var i=this;if(e.Type.isPlainObject(t)){var s=this.parent.params.FIELDS_STUBS,n=t.type,a=void 0===n?"string":n,r=s.find(function(t){return t.NAME===a});if(e.Type.isPlainObject(r)){var l=babelHelpers.objectSpread({},r,{NAME:t.id,LABEL:t.name,TYPE:"checkbox"===a?"SELECT":r.TYPE,VALUE_REQUIRED:!0===t.valueRequired});if("list"===a)return babelHelpers.objectSpread({},l,{ITEMS:[].concat(babelHelpers.toConsumableArray(l.ITEMS),[this.prepareListItems(t.items)]),params:{isMulti:!!e.Type.isPlainObject(t.params)&&!0===t.params}});if("date"===a){var o=e.Type.isPlainObject(t.value)&&Reflect.has(t.value,"_datesel")?t.value._datesel:i.parent.dateTypes.NONE;return babelHelpers.objectSpread({},l,{SUB_TYPES:e.Type.isArray(t.exclude)?l.SUB_TYPES.filter(function(e){return!t.exclude.includes(e.VALUE)}):l.SUB_TYPES,SUB_TYPE:l.SUB_TYPES.find(function(t){return t.VALUE===o}),VALUES:e.Type.isPlainObject(t.value)?babelHelpers.objectSpread({},t.value):l.VALUES})}if("string"===a||"custom_date"===a||"number"===a||"checkbox"===a||"custom_entity"===a)return l}}return t}},{key:"appendRenderedField",value:function(t){if(e.Type.isDomNode(t)){var i=this.getAdditionalFieldContainer();e.Dom.append(t,i)}}},{key:"getValue",value:function(){var t=this.parent.getFilterFieldsValues(),e=this.options,i=e.TYPE,s=e.NAME;return"DATE"===i||"NUMBER"===i?Object.entries(t).reduce(function(t,e){var i=babelHelpers.slicedToArray(e,2),n=i[0],a=i[1];return n.startsWith(s)&&(t[n.replace(s,"")]=a),t},{}):s in t?t[s]:""}},{key:"setValue",value:function(t){var i=this,s=this.options.TYPE;if(("DATE"===s||"NUMBER"===s)&&e.Type.isPlainObject(t)){var n=this.parent.getFieldListContainer();Object.entries(t).forEach(function(t){var s=babelHelpers.slicedToArray(t,2),a=s[0],r=s[1],l=n.querySelector('[data-name="'.concat(i.id,'"] [data-name="').concat(i.id).concat(a,'"], [data-name="').concat(i.id,'"] [name="').concat(i.id).concat(a,'"]'));if(l)if(e.Dom.hasClass(l,"main-ui-select")){var o=e.Dom.attr(l,"data-items");if(e.Type.isArray(o)){var u=o.find(function(t){return t.VALUE===r});if(e.Type.isPlainObject(u)){e.Dom.attr(l,"data-value",u);var c=l.querySelector(".main-ui-select-name");c&&(c.innerText=u.NAME);var h=BX.Main.ui.Factory.get(l);h||(h={node:l,instance:new BX.Main.ui.select(l)},BX.Main.ui.Factory.data.push(h)),e.Type.isPlainObject(h)&&BX.onCustomEvent(window,"UI::Select::Change",[h.instance,u])}}}else"INPUT"===l.tagName&&(l.value=r)})}}}]),n}(e.Event.EventEmitter);babelHelpers.defineProperty(n,"instances",new WeakMap);var a=function(){function t(e){babelHelpers.classCallCheck(this,t),this.parent=e}return babelHelpers.createClass(t,[{key:"setFields",value:function(t){if(e.Type.isPlainObject(t)){this.parent.getPopup();var i=this.parent.getPreset();i.deactivateAllPresets();var s={preset_id:"tmp_filter",fields:t};this.parent.updateParams(s),i.applyPreset("tmp_filter")}}},{key:"setFilter",value:function(t){if(e.Type.isObject(t))if(this.parent.updateParams(t),this.parent.getPreset().deactivateAllPresets(),this.parent.getPreset().activatePreset(t.preset_id),this.parent.getPreset().applyPreset(t.preset_id),t.checkFields&&this.parent.getPreset().isPresetValuesModified(t.preset_id)){var i={};e.Type.isPlainObject(t.fields)&&(i=Object.assign({},t.fields)),e.Type.isPlainObject(t.additional)&&(i=Object.assign({},t.additional)),this.parent.getPreset().deactivateAllPresets(),this.setFields(i),this.apply()}else this.parent.applyFilter(!1,t.preset_id)}},{key:"extendFilter",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(e.Type.isObject(t)){Object.keys(t).forEach(function(i){e.Type.isNumber(t[i])&&(t[i]=String(t[i]))});var s=this.parent.getPreset().getCurrentPresetId();if(i||"tmp_filter"===s||"default_filter"===s){var n=Object.assign({},this.parent.getFilterFieldsValues(),t);return this.setFields(n),void this.apply()}var a=this.parent.getPreset().getAdditionalValues(s);e.Type.isPlainObject(a)&&Object.keys(a).length&&(t=Object.assign({},a,t)),this.setFilter({preset_id:s,additional:t,checkFields:!0})}}},{key:"apply",value:function(){this.parent.isEditEnabled()||(this.parent.isEditEnabled()||this.parent.applyFilter(),this.parent.closePopup(),this.parent.isAddPresetEnabled()&&this.parent.disableAddPreset())}},{key:"getEmitter",value:function(){return this.parent.emitter}}]),t}();function r(t){return{block:"main-ui-control-field",type:t.type,dragButton:!1,content:{block:"main-ui-date",mix:["filter-type-single"],calendarButton:!0,valueDelete:!0,placeholder:t.placeholder,name:t.name,tabindex:t.tabindex,value:t.value,enableTime:t.enableTime}}}function l(t){return{block:"main-ui-control-field",dragButton:!1,content:{block:"main-ui-select",tabindex:t.tabindex,value:t.value,items:t.items,name:t.name,valueDelete:!1}}}function o(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div \n\t\t\t\tclass="main-ui-filter-error-message" \n\t\t\t\ttitle="','">\n\t\t\t\t',"\n\t\t\t</div>\n\t\t"]);return o=function(){return t},t}var u=new WeakMap,c=new WeakMap,h=new WeakMap,d=function(){function t(e){babelHelpers.classCallCheck(this,t),this.parent=null,this.init(e)}return babelHelpers.createClass(t,[{key:"init",value:function(t){this.parent=t,BX.addCustomEvent(window,"UI::Select::change",this._onDateTypeChange.bind(this))}},{key:"deleteField",value:function(t){e.Dom.remove(t)}},{key:"isFieldDelete",value:function(t){return e.Dom.hasClass(t,this.parent.settings.classFieldDelete)}},{key:"isFieldValueDelete",value:function(t){return e.Dom.hasClass(t,this.parent.settings.classValueDelete)||e.Dom.hasClass(t.parentNode,this.parent.settings.classValueDelete)}},{key:"isDragButton",value:function(t){return t&&e.Dom.hasClass(t,this.parent.settings.classPresetDragButton)}},{key:"clearFieldValue",value:function(t){if(t){var i=babelHelpers.toConsumableArray(t.querySelectorAll(".main-ui-control"));babelHelpers.toConsumableArray(t.querySelectorAll(".main-ui-square")).forEach(function(t){return e.Dom.remove(t)}),i.forEach(function(t){Reflect.has(t,"value")&&(t.value="")})}}},{key:"getField",value:function(t){return e.Type.isDomNode(t)?t.closest(".main-ui-control-field, .main-ui-control-field-group"):null}},{key:"render",value:function(t,i){if(e.Type.isString(t)&&e.Type.isPlainObject(i)){var s=Object.entries(i).reduce(function(t,e){var i=babelHelpers.slicedToArray(e,2),s=i[0],n=i[1];return t.replace(new RegExp("{{".concat(s,"}}"),"g"),n)},t),n=e.Dom.create("div",{html:s}),a=n.querySelector(".main-ui-control-field-group");if(a)return a;var r=n.querySelector(".main-ui-control-field");if(r)return r;var l=n.querySelector(".main-ui-filter-field-line");if(l)return l}return null}},{key:"createInputText",value:function(t){var i={block:"main-ui-control-field",mix:this.parent.getParam("ENABLE_LABEL")?[this.parent.settings.classFieldWithLabel]:null,deleteButton:!0,valueDelete:!0,name:t.NAME,type:t.TYPE,label:this.parent.getParam("ENABLE_LABEL")?t.LABEL:"",dragTitle:this.parent.getParam("MAIN_UI_FILTER__DRAG_FIELD_TITLE"),deleteTitle:this.parent.getParam("MAIN_UI_FILTER__REMOVE_FIELD"),content:[{block:"main-ui-control-string",name:t.NAME,placeholder:t.PLACEHOLDER||"",value:e.Type.isString(t.VALUE)||e.Type.isNumber(t.VALUE)?t.VALUE:"",tabindex:t.TABINDEX}]},s=BX.decl(i);return this.parent.getEmitter().emit("init",{field:new n({parent:this.parent,options:babelHelpers.objectSpread({},t),node:s})}),s}},{key:"createTextarea",value:function(t){var i=BX.decl({block:"main-ui-control-field",mix:this.parent.getParam("ENABLE_LABEL")?[this.parent.settings.classFieldWithLabel]:null,deleteButton:!0,valueDelete:!0,name:t.NAME,type:t.TYPE,label:this.parent.getParam("ENABLE_LABEL")?t.LABEL:"",dragTitle:this.parent.getParam("MAIN_UI_FILTER__DRAG_FIELD_TITLE"),deleteTitle:this.parent.getParam("MAIN_UI_FILTER__REMOVE_FIELD"),content:[{block:"main-ui-control-textarea",name:t.NAME,placeholder:t.PLACEHOLDER||"",value:e.Type.isString(t.VALUE)||e.Type.isNumber(t.VALUE)?t.VALUE:"",tabindex:t.TABINDEX}]}),s=i.querySelector("textarea"),a=function(){e.Dom.style(s,"height","1px"),e.Dom.style(s,"height","".concat(s.scrollHeight,"px"))};return e.Event.bind(s,"input",a),e.Event.bind(s,"change",a),e.Event.bind(s,"keyup",a),e.Event.bind(s,"cut",a),e.Event.bind(s,"paste",a),this.parent.getEmitter().emit("init",{field:new n({parent:this.parent,options:babelHelpers.objectSpread({},t),node:i})}),i}},{key:"createDestSelector",value:function(t){var i={block:"main-ui-control-field",mix:this.parent.getParam("ENABLE_LABEL")?[this.parent.settings.classFieldWithLabel]:null,deleteButton:!0,valueDelete:!0,name:t.NAME,type:t.TYPE,label:this.parent.getParam("ENABLE_LABEL")?t.LABEL:"",dragTitle:this.parent.getParam("MAIN_UI_FILTER__DRAG_FIELD_TITLE"),deleteTitle:this.parent.getParam("MAIN_UI_FILTER__REMOVE_FIELD"),content:{block:"main-ui-control-entity",mix:"main-ui-control",attrs:{"data-multiple":JSON.stringify(t.MULTIPLE)},content:[]}};if("_label"in t.VALUES&&t.VALUES._label)if(t.MULTIPLE){var s=t.VALUES._label?t.VALUES._label:[];e.Type.isPlainObject(s)&&(s=Object.keys(s).map(function(t){return s[t]})),e.Type.isArray(s)||(s=[s]);var a=t.VALUES._value?t.VALUES._value:[];e.Type.isPlainObject(a)&&(a=Object.keys(a).map(function(t){return a[t]})),e.Type.isArray(a)||(a=[a]),s.forEach(function(t,e){i.content.content.push({block:"main-ui-square",tag:"span",name:t,item:{_label:t,_value:a[e]}})})}else i.content.content.push({block:"main-ui-square",tag:"span",name:"_label"in t.VALUES?t.VALUES._label:"",item:t.VALUES});i.content.content.push({block:"main-ui-square-search",tag:"span",content:{block:"main-ui-control-string",name:"".concat(t.NAME,"_label"),tabindex:t.TABINDEX,type:"text",placeholder:t.PLACEHOLDER||""}},{block:"main-ui-control-string",name:t.NAME,type:"hidden",placeholder:t.PLACEHOLDER||"",value:"_value"in t.VALUES?t.VALUES._value:"",tabindex:t.TABINDEX}),i=BX.decl(i);var r=BX.Filter.Utils.getBySelector(i,'.main-ui-control-string[type="text"]');return BX.addClass(r,"main-ui-square-search-item"),e.Event.bind(r,"focus",function(t){BX.fireEvent(t.currentTarget,"click")}),e.Event.bind(r,"click",BX.proxy(this._onCustomEntityInputClick,this)),this.bindDocument||(e.Event.bind(document,"click",BX.proxy(this._onCustomEntityBlur,this)),document.addEventListener("focus",BX.proxy(this._onDocumentFocus,this),!0),this.bindDocument=!0),e.Event.bind(r,"keydown",BX.proxy(this._onCustomEntityKeydown,this)),e.Event.bind(i,"click",BX.proxy(this._onCustomEntityFieldClick,this)),BX.ready(BX.proxy(function(){BX.Filter.DestinationSelector.create(t.NAME,{filterId:this.parent.getParam("FILTER_ID"),fieldId:t.NAME})},this)),this.parent.getEmitter().emit("init",{field:new n({parent:this.parent,options:babelHelpers.objectSpread({},t),node:i})}),i}},{key:"createCustomEntity",value:function(t){var i={block:"main-ui-control-field",mix:this.parent.getParam("ENABLE_LABEL")?[this.parent.settings.classFieldWithLabel]:null,deleteButton:!0,valueDelete:!0,name:t.NAME,type:t.TYPE,label:this.parent.getParam("ENABLE_LABEL")?t.LABEL:"",dragTitle:this.parent.getParam("MAIN_UI_FILTER__DRAG_FIELD_TITLE"),deleteTitle:this.parent.getParam("MAIN_UI_FILTER__REMOVE_FIELD"),content:{block:"main-ui-control-entity",mix:"main-ui-control",attrs:{"data-multiple":JSON.stringify(t.MULTIPLE)},content:[]}};if("_label"in t.VALUES&&t.VALUES._label)if(t.MULTIPLE){var s=t.VALUES._label?t.VALUES._label:[];e.Type.isPlainObject(s)&&(s=Object.keys(s).map(function(t){return s[t]})),e.Type.isArray(s)||(s=[s]);var a=t.VALUES._value?t.VALUES._value:[];e.Type.isPlainObject(a)&&(a=Object.keys(a).map(function(t){return a[t]})),e.Type.isArray(a)||(a=[a]),s.forEach(function(t,e){i.content.content.push({block:"main-ui-square",tag:"span",name:t,item:{_label:t,_value:a[e]}})})}else i.content.content.push({block:"main-ui-square",tag:"span",name:"_label"in t.VALUES?t.VALUES._label:"",item:t.VALUES});i.content.content.push({block:"main-ui-square-search",tag:"span",content:{block:"main-ui-control-string",name:"".concat(t.NAME,"_label"),tabindex:t.TABINDEX,type:"text",placeholder:t.PLACEHOLDER||""}},{block:"main-ui-control-string",name:t.NAME,type:"hidden",placeholder:t.PLACEHOLDER||"",value:"_value"in t.VALUES?t.VALUES._value:"",tabindex:t.TABINDEX}),i=BX.decl(i);var r=BX.Filter.Utils.getBySelector(i,'.main-ui-control-string[type="text"]');return BX.addClass(r,"main-ui-square-search-item"),e.Event.bind(r,"focus",BX.proxy(this._onCustomEntityInputFocus,this)),e.Event.bind(r,"click",BX.proxy(this._onCustomEntityInputClick,this)),this.bindDocument||(e.Event.bind(document,"click",BX.proxy(this._onCustomEntityBlur,this)),document.addEventListener("focus",BX.proxy(this._onDocumentFocus,this),!0),this.bindDocument=!0),e.Event.bind(r,"keydown",BX.proxy(this._onCustomEntityKeydown,this)),e.Event.bind(i,"click",BX.proxy(this._onCustomEntityFieldClick,this)),this.parent.getEmitter().emit("init",{field:new n({parent:this.parent,options:babelHelpers.objectSpread({},t),node:i})}),i}},{key:"_onCustomEntityInputFocus",value:function(t){BX.fireEvent(t.currentTarget,"click")}},{key:"_onCustomEntityInputClick",value:function(t){t.preventDefault(),t.stopPropagation(),t.isTrusted?(this.trustTimestamp=t.timeStamp,this.notTrustTimestamp=this.notTrustTimestamp||t.timeStamp):this.notTrustTimestamp=t.timeStamp;var e=new Date(this.trustTimestamp),i=new Date(this.notTrustTimestamp);"".concat(e.getMinutes(),":").concat(e.getSeconds())!=="".concat(i.getMinutes(),":").concat(i.getSeconds())&&this._onCustomEntityFocus(t)}},{key:"_onDocumentFocus",value:function(t){var e=this.getCustomEntityInstance(),i=e.getPopupContainer(),s=e.getLabelNode()===t.target,n=!!i&&i.contains(t.target);s||n||this._onCustomEntityBlur(t)}},{key:"_onCustomEntityKeydown",value:function(t){var i=t.target,s=t.currentTarget,n=i.parentNode.parentNode,a=n.querySelectorAll(".main-ui-square"),r=a[a.length-1];if(e.Type.isDomNode(r))if(BX.Filter.Utils.isKey(t,"backspace")&&0===s.selectionStart){if(e.Dom.hasClass(r,"main-ui-square-selected")){var l=n.querySelector('input[type="hidden"]');return e.Type.isDomNode(l)&&(l.value="",BX.fireEvent(l,"input")),void e.Dom.remove(r)}e.Dom.addClass(r,"main-ui-square-selected")}else e.Dom.removeClass(r,"main-ui-square-selected")}},{key:"_onCustomEntityFieldClick",value:function(t){var i=t.target;if(e.Dom.hasClass(i,"main-ui-square-delete")){var s=i.closest(".main-ui-square");if(e.Type.isDomNode(s)){var n=this.getCustomEntityInstance();BX.onCustomEvent(window,"BX.Main.Filter:customEntityRemove",[n]),e.Dom.remove(s)}}else{var a=i.querySelector('input[type="text"]');e.Type.isDomNode(a)&&BX.fireEvent(a,"focus")}}},{key:"_onCustomEntityBlur",value:function(t){var i={stopBlur:!1};if(BX.onCustomEvent(window,"BX.Main.Filter:onGetStopBlur",[t,i]),void 0===i.stopBlur||!i.stopBlur){var s=this.getCustomEntityInstance();BX.onCustomEvent(window,"BX.Main.Filter:customEntityBlur",[s]),e.Event.unbind(s.getPopupContainer(),"click",this._stopPropagation),e.Dom.removeClass(s.getField(),"main-ui-focus")}}},{key:"_stopPropagation",value:function(t){t.stopPropagation()}},{key:"getCustomEntityInstance",value:function(){return this.customEntityInstance instanceof BX.Main.ui.CustomEntity||(this.customEntityInstance=new BX.Main.ui.CustomEntity),this.customEntityInstance}},{key:"_onCustomEntityFocus",value:function(t){t.stopPropagation();var i=t.currentTarget.closest(".main-ui-control-entity"),s=this.getCustomEntityInstance();s.setField(i),BX.onCustomEvent("BX.Main.Filter:customEntityFocus",[s]);var n=s.getPopupContainer();e.Type.isElementNode(n)&&e.Event.bind(n,"click",this._stopPropagation),e.Dom.addClass(i,"main-ui-focus")}},{key:"createCustom",value:function(t){var i=BX.decl({block:"main-ui-control-field",mix:this.parent.getParam("ENABLE_LABEL")?[this.parent.settings.classFieldWithLabel]:null,name:t.NAME,type:t.TYPE,deleteButton:!0,label:this.parent.getParam("ENABLE_LABEL")?t.LABEL:"",dragTitle:this.parent.getParam("MAIN_UI_FILTER__DRAG_FIELD_TITLE"),deleteTitle:this.parent.getParam("MAIN_UI_FILTER__REMOVE_FIELD"),content:{block:"main-ui-custom",mix:["main-ui-control","main-ui-custom-style"],attrs:{"data-name":t.NAME},content:""}});if(e.Type.isString(t.VALUE)){var s=Reflect.has(t,"_VALUE")?t._VALUE:"",a=e.Text.decode(t.VALUE).replace('name="'.concat(t.NAME,'"'),'name="'.concat(t.NAME,'" value="').concat(s,'"')),r=i.querySelector(".main-ui-custom");e.Runtime.html(r,a)}return this.parent.getEmitter().emit("init",{field:new n({parent:this.parent,options:babelHelpers.objectSpread({},t),node:i})}),i}},{key:"createSelect",value:function(t){var e=BX.decl({block:"main-ui-control-field",mix:this.parent.getParam("ENABLE_LABEL")?[this.parent.settings.classFieldWithLabel]:null,name:t.NAME,type:t.TYPE,deleteButton:!0,label:this.parent.getParam("ENABLE_LABEL")?t.LABEL:"",dragTitle:this.parent.getParam("MAIN_UI_FILTER__DRAG_FIELD_TITLE"),deleteTitle:this.parent.getParam("MAIN_UI_FILTER__REMOVE_FIELD"),content:{block:this.parent.settings.classSelect,name:t.NAME,items:t.ITEMS,value:"VALUE"in t?t.VALUE:t.ITEMS[0],params:t.PARAMS,tabindex:t.TABINDEX,valueDelete:!1}});return this.parent.getEmitter().emit("init",{field:new n({parent:this.parent,options:babelHelpers.objectSpread({},t),node:e})}),e}},{key:"createMultiSelect",value:function(t){var e=BX.decl({block:"main-ui-control-field",mix:this.parent.getParam("ENABLE_LABEL")?[this.parent.settings.classFieldWithLabel]:null,name:t.NAME,type:t.TYPE,deleteButton:!0,label:this.parent.getParam("ENABLE_LABEL")?t.LABEL:"",dragTitle:this.parent.getParam("MAIN_UI_FILTER__DRAG_FIELD_TITLE"),deleteTitle:this.parent.getParam("MAIN_UI_FILTER__REMOVE_FIELD"),content:{block:"main-ui-multi-select",name:t.NAME,tabindex:"TABINDEX"in t?t.TABINDEX:"",placeholder:!this.parent.getParam("ENABLE_LABEL")&&"PLACEHOLDER"in t?t.PLACEHOLDER:"",items:"ITEMS"in t?t.ITEMS:[],value:"VALUE"in t?t.VALUE:[],params:"PARAMS"in t?t.PARAMS:{isMulti:!0},valueDelete:!0}});return this.parent.getEmitter().emit("init",{field:new n({parent:this.parent,options:babelHelpers.objectSpread({},t),node:e})}),e}},{key:"createCustomDate",value:function(t){var i={block:"main-ui-control-field-group",type:t.TYPE,mix:this.parent.getParam("ENABLE_LABEL")?[this.parent.settings.classFieldWithLabel,"main-ui-filter-date-group"]:["main-ui-filter-date-group"],label:this.parent.getParam("ENABLE_LABEL")?t.LABEL:"",dragTitle:this.parent.getParam("MAIN_UI_FILTER__DRAG_FIELD_TITLE"),deleteTitle:this.parent.getParam("MAIN_UI_FILTER__REMOVE_FIELD"),tabindex:"TABINDEX"in t?t.TABINDEX:"",name:"NAME"in t?t.NAME:"",deleteButton:!0,content:[]};e.Type.isPlainObject(t.VALUE.days)&&(t.VALUE.days=Object.keys(t.VALUE.days).map(function(e){return t.VALUE.days[e]}));var s=t.DAYS.filter(function(e){return t.VALUE.days.some(function(t){return t===e.VALUE})}),a={block:"main-ui-control-field",mix:["main-ui-control-custom-date"],placeholder:t.DAYS_PLACEHOLDER,dragButton:!1,content:{block:"main-ui-multi-select",name:"".concat(t.NAME,"_days"),tabindex:"TABINDEX"in t?t.TABINDEX:"",items:t.DAYS,value:s,params:"PARAMS"in t?t.PARAMS:{isMulti:!0},valueDelete:!0,attrs:{"data-placeholder":t.DAYS_PLACEHOLDER}}};e.Type.isPlainObject(t.VALUE.months)&&(t.VALUE.months=Object.keys(t.VALUE.months).map(function(e){return t.VALUE.months[e]}));var r=t.MONTHS.filter(function(e){return t.VALUE.months.some(function(t){return t===e.VALUE})}),l={block:"main-ui-control-field",mix:["main-ui-control-custom-date"],dragButton:!1,content:{block:"main-ui-multi-select",name:"".concat(t.NAME,"_months"),tabindex:"TABINDEX"in t?t.TABINDEX:"",items:t.MONTHS,value:r,params:"PARAMS"in t?t.PARAMS:{isMulti:!0},valueDelete:!0,attrs:{"data-placeholder":t.MONTHS_PLACEHOLDER}}};e.Type.isPlainObject(t.VALUE.years)&&(t.VALUE.years=Object.keys(t.VALUE.years).map(function(e){return t.VALUE.years[e]}));var o=t.YEARS.filter(function(e){return t.VALUE.years.some(function(t){return t===e.VALUE})}),u={block:"main-ui-control-field",mix:["main-ui-control-custom-date"],dragButton:!1,content:{block:"main-ui-multi-select",name:"".concat(t.NAME,"_years"),tabindex:"TABINDEX"in t?t.TABINDEX:"",items:t.YEARS,value:o,params:"PARAMS"in t?t.PARAMS:{isMulti:!0},valueDelete:!0,attrs:{"data-placeholder":t.YEARS_PLACEHOLDER}}};i.content.push(a),i.content.push(l),i.content.push(u);var c=BX.decl(i);return this.parent.getEmitter().emit("init",{field:new n({parent:this.parent,options:babelHelpers.objectSpread({},t),node:c})}),c}},{key:"_onDateTypeChange",value:function(t,i){var s=this;if(this.parent.getPopup().contentContainer.contains(t.node)){var n,a,r,l={},o=null;if(e.Type.isPlainObject(i)&&Reflect.has(i,"VALUE")){var u=t.getNode(),c=t.getParams(),h=u.dataset.name;if(!e.Type.isPlainObject(c)&&(h.endsWith("_datesel")||h.endsWith("_numsel"))){var d=u.parentNode.parentNode;l.TABINDEX=t.getInput().getAttribute("tabindex"),l.SUB_TYPES=t.getItems(),l.SUB_TYPE=i,l.NAME=d.dataset.name,l.TYPE=d.dataset.type,l.VALUE_REQUIRED="true"===d.dataset.valueRequired;var p=this.parent.getPreset().getCurrentPresetData();if(e.Type.isArray(p.FIELDS)){var m=p.FIELDS.find(function(t){return t.NAME===l.NAME});e.Type.isNil(m)&&(m=this.parent.params.FIELDS_STUBS.find(function(t){return t.TYPE===l.TYPE})),e.Type.isNil(m)||(h.endsWith("_datesel")&&(l.MONTHS=m.MONTHS,l.MONTH=m.MONTH,l.YEARS=m.YEARS,l.YEAR=m.YEAR,l.QUARTERS=m.QUARTERS,l.QUARTER=m.QUARTER,l.ENABLE_TIME=m.ENABLE_TIME,l.YEARS_SWITCHER=m.YEARS_SWITCHER),l.VALUES=m.VALUES,l.REQUIRED=m.REQUIRED)}this.parent.getParam("ENABLE_LABEL")&&(n=d.querySelector(".main-ui-control-field-label"),l.LABEL=n.innerText),o=h.endsWith("_datesel")?this.createDate(l):this.createNumber(l),e.Type.isArray(this.parent.fieldsList)&&-1!==(r=this.parent.fieldsList.indexOf(d))&&(this.parent.fieldsList[r]=o,this.parent.registerDragItem(o)),this.parent.unregisterDragItem(d),a=babelHelpers.toConsumableArray(o.querySelectorAll(".main-ui-control-field")),e.Type.isArray(a)&&a.length&&a.forEach(function(t){t.FieldController=new BX.Filter.FieldController(t,s.parent)}),e.Dom.insertAfter(o,d),e.Dom.remove(d)}}}}},{key:"createNumber",value:function(t){var e=this.parent.numberTypes,i=this.parent.params.ENABLE_LABEL,s=t.SUB_TYPE,a=void 0===s?{}:s,r=t.SUB_TYPES,l=void 0===r?[]:r,o=t.TABINDEX,u=void 0===o?"":o,c=t.VALUES,h=void 0===c?{_from:"",_to:""}:c,d=t.LABEL,p=void 0===d?"":d,m=t.TYPE,E=a.VALUE||e.SINGLE,g=a.PLACEHOLDER||"",f=t.NAME.replace("_numsel",""),B={block:"number-group",type:m,mix:i?["main-ui-filter-wield-with-label","main-ui-filter-number-group"]:["main-ui-filter-number-group"],label:i?p:"",dragTitle:this.parent.getParam("MAIN_UI_FILTER__DRAG_FIELD_TITLE"),deleteTitle:this.parent.getParam("MAIN_UI_FILTER__REMOVE_FIELD"),tabindex:u,value:a,items:l,name:f,deleteButton:!0,content:[]};if(E!==e.LESS){var y={block:"main-ui-control-field",type:m,dragButton:!1,content:{block:"main-ui-number",mix:["filter-type-single"],calendarButton:!0,valueDelete:!0,placeholder:g,name:"".concat(f,"_from"),tabindex:u,value:h._from||""}};B.content.push(y)}if(E===e.RANGE){B.content.push({block:"main-ui-filter-field-line",content:{block:"main-ui-filter-field-line-item",tag:"span"}})}if(E===e.RANGE||E===e.LESS){var A={block:"main-ui-control-field",type:m,dragButton:!1,content:{block:"main-ui-number",calendarButton:!0,valueDelete:!0,name:"".concat(f,"_to"),tabindex:u,value:h._to||""}};B.content.push(A)}var P=BX.decl(B);return this.parent.getEmitter().emit("init",{field:new n({parent:this.parent,options:babelHelpers.objectSpread({},t),node:P})}),P}},{key:"createDate",value:function(t){var i=this,s=this.parent,a=s.dateTypes,o=s.additionalDateTypes,u=t.SUB_TYPE,c=void 0===u?{}:u,h=t.SUB_TYPES,d=void 0===h?[]:h,p=t.PLACEHOLDER,m=void 0===p?"":p,E=t.VALUES,g=void 0===E?{_from:"",_to:"",_quarter:"",_days:"",_month:"",_year:"",_allow_year:""}:E,f=t.TABINDEX,B=void 0===f?"":f,y=t.ENABLE_TIME,A=void 0!==y&&y,P=t.LABEL,_=void 0===P?"":P,S=t.TYPE,L=t.VALUE_REQUIRED,v=void 0!==L&&L,b=t.REQUIRED,T=void 0!==b&&b,X=this.parent.params.ENABLE_LABEL,I=c.VALUE||a.NONE,F=t.NAME.replace("_datesel",""),D={block:"date-group",type:S,mix:X?["main-ui-filter-wield-with-label","main-ui-filter-date-group"]:["main-ui-filter-date-group"],label:X?_:"",dragTitle:this.parent.getParam("MAIN_UI_FILTER__DRAG_FIELD_TITLE"),deleteTitle:this.parent.getParam("MAIN_UI_FILTER__REMOVE_FIELD"),tabindex:B,value:c,items:d,name:F,enableTime:A,deleteButton:!0,content:[]};if(I===a.EXACT){var C=r({type:S,name:"".concat(F.NAME,"_from"),placeholder:m,tabindex:B,value:g._from||"",enableTime:A});D.content.push(C)}if(I===a.NEXT_DAYS||I===a.PREV_DAYS||I===o.PREV_DAY||I===o.NEXT_DAY||I===o.MORE_THAN_DAYS_AGO||I===o.AFTER_DAYS){var U=function(t){return{block:"main-ui-control-field",type:t.type,dragButton:!1,content:{block:"main-ui-number",mix:["filter-type-single"],valueDelete:!0,placeholder:t.placeholder,name:t.name,tabindex:t.tabindex,value:t.value}}}({type:S,name:"".concat(F,"_days"),tabindex:B,value:g._days||"",placeholder:m});D.content.push(U)}if(I===a.RANGE){var N={block:"main-ui-filter-range-group",content:[r({type:S,name:"".concat(F,"_from"),placeholder:m,tabindex:B,value:g._from||"",enableTime:A}),{block:"main-ui-filter-field-line",content:{block:"main-ui-filter-field-line-item",tag:"span"}},r({type:S,name:"".concat(F,"_to"),placeholder:m,tabindex:B,value:g._to||"",enableTime:A})]};D.content.push(N)}if(I===a.MONTH){var R=t.MONTHS,k=t.MONTH,O=t.YEARS,M=t.YEAR,V=R.find(function(t){return t.VALUE===g._month})||k||R[0],x=O.find(function(t){return t.VALUE===g._year})||M||O[0];D.content.push(l({name:"".concat(F,"_month"),value:V,items:R,tabindex:B}),l({name:"".concat(F,"_year"),value:x,items:O,tabindex:B}))}if(I===a.QUARTER){var w=t.YEARS,q=t.YEAR,j=t.QUARTERS,Y=t.QUARTER,H=t.PARAMS,G=w.find(function(t){return t.VALUE===g._year})||q||w[0],W=j.find(function(t){return t.VALUE===g._quarter})||Y||j[0];D.content.push(l({name:"".concat(F,"_year"),value:G,items:w,tabindex:B}),l({name:"".concat(F,"_quarter"),value:W,items:j,tabindex:B,params:H}))}if(I===a.YEAR){var Q=t.YEARS,K=t.YEAR,J=Q.find(function(t){return t.VALUE===g._year})||K||Q[0];D.content.push(l({name:"".concat(F,"_year"),value:J,items:Q,tabindex:B}))}if("CUSTOM_DATE"===I){var z=d.find(function(t){return"CUSTOM_DATE"===t.VALUE});if(z){var Z=e.Runtime.clone(z.DECL);e.Type.isArray(g._days)&&(Z.VALUE.days=g._days),e.Type.isArray(g._month)&&(Z.VALUE.months=g._month),e.Type.isArray(g._year)&&(Z.VALUE.years=g._year),Z.mix=Z.filter(function(t){return"main-ui-filter-wield-with-label"!==t});var $=this.createCustomDate(Z);babelHelpers.toConsumableArray($.querySelectorAll(".main-ui-item-icon-container, .main-ui-filter-icon-grab")).forEach(function(t){return e.Dom.remove(t)}),D.content.push($),D.push("main-ui-filter-custom-date-group")}}if(I!==a.NONE&&I!==o.CUSTOM_DATE&&t.YEARS_SWITCHER){var tt=e.Runtime.clone(t.YEARS_SWITCHER),et=tt.ITEMS;tt.VALUE=et.reduce(function(t,e){return e.VALUE===g._allow_year?e:t});var it=this.createSelect(tt);e.Dom.addClass(it,["main-ui-filter-year-switcher","main-ui-filter-with-padding"]),e.Dom.removeClass(it,"main-ui-filter-wield-with-label"),babelHelpers.toConsumableArray(it.querySelectorAll(".main-ui-item-icon-container, .main-ui-filter-icon-grab")).forEach(function(t){return e.Dom.remove(t)});var st=D.content.length-1,nt=D.content[st];e.Type.isPlainObject(nt)&&(e.Type.isArray(nt.mix)||(nt.mix=[]),nt.mix.push("main-ui-filter-remove-margin-right")),e.Type.isDomNode(nt)&&e.Dom.addClass(nt,"main-ui-filter-remove-margin-right"),requestAnimationFrame(function(){e.Dom.addClass(it.previousElementSibling,"main-ui-filter-remove-margin-right")}),D.content.push(it),D.mix.push("main-ui-filter-date-with-years-switcher")}var at=BX.decl(D),rt=e.Runtime.debounce(this.onDateChange,500,this),lt=babelHelpers.toConsumableArray(at.querySelectorAll(".main-ui-date-input"));(lt.forEach(function(t){t.addEventListener("change",rt),t.addEventListener("input",rt);var e=t.parentNode.querySelector(".main-ui-control-value-delete");e&&e.addEventListener("click",function(){setTimeout(function(){i.onDateChange({target:t})})})}),v)&&(at.dataset.valueRequired=!0,[].concat(babelHelpers.toConsumableArray(lt),babelHelpers.toConsumableArray(at.querySelectorAll(".main-ui-number-input"))).forEach(function(t){t.addEventListener("change",i.checkRequiredDateValue.bind(i)),t.addEventListener("input",i.checkRequiredDateValue.bind(i));var s=t.parentNode.querySelector(".main-ui-control-value-delete");s&&s.addEventListener("click",function(){setTimeout(function(){i.checkRequiredDateValue({target:t})})}),e.Event.bindOnce(t,"mouseout",function(){i.checkRequiredDateValue({target:t})})}));if(T){var ot=at.querySelector(".main-ui-filter-field-delete");ot&&BX.remove(ot)}var ut={};return this.parent.prepareControlDateValue(ut,F,at),Object.entries(ut).forEach(function(t){var e=babelHelpers.slicedToArray(t,2),i=e[0],s=e[1];ut[i.replace(F,"")]=s,delete ut[i]}),this.parent.getEmitter().emit("init",{field:new n({parent:this.parent,options:babelHelpers.objectSpread({},t,{VALUES:ut}),node:at})}),at}},{key:"checkRequiredDateValue",value:function(t){""!==t.target.value?this.hideError({id:"valueError",target:t.target}):this.showError({id:"valueError",target:t.target,text:this.parent.params.MAIN_UI_FILTER__VALUE_REQUIRED})}},{key:"onDateChange",value:function(t){var e=this;h.get(t.target)!==t.target.value&&(h.set(t.target,t.target.value),""!==t.target.value?BX.ajax.runComponentAction("bitrix:main.ui.filter","checkDateFormat",{mode:"ajax",data:{value:t.target.value,format:BX.message("FORMAT_DATETIME")}}).then(function(i){i.data.result?e.hideError({id:"formatError",target:t.target}):e.showError({id:"formatError",target:t.target})}):this.hideError({id:"formatError",target:t.target}))}},{key:"showError",value:function(t){var i=t.id,s=t.target,n=t.text,a=void 0===n?null:n;e.Dom.style(s,"border-color","#FF5752"),u.has(s)&&c.get(s)===i&&e.Dom.remove(u.get(s));var r=this.parent.params,l=r.MAIN_UI_FILTER__DATE_ERROR_TITLE,h=r.MAIN_UI_FILTER__DATE_ERROR_LABEL,d=a||"".concat(h," ").concat(e.Loc.getMessage("FORMAT_DATE")),p=e.Tag.render(o(),l,d);u.set(s,p),c.set(s,i),e.Dom.insertAfter(p,s),e.Dom.attr(s,"is-valid","false")}},{key:"hideError",value:function(t){var i=t.id,s=t.target;e.Dom.style(s,"border-color",null),u.has(s)&&c.get(s)===i&&e.Dom.remove(u.get(s)),e.Dom.attr(s,"is-valid","true")}}]),t}(),p=function(){function t(e){babelHelpers.classCallCheck(this,t),this.parent=null,this.presets=null,this.container=null,this.init(e)}return babelHelpers.createClass(t,[{key:"init",value:function(t){this.parent=t}},{key:"bindOnPresetClick",value:function(){var t=this;(this.getPresets()||[]).forEach(function(i){e.Event.bind(i,"click",BX.delegate(t._onPresetClick,t))})}},{key:"getAddPresetField",value:function(){return this.getContainer().querySelector(".main-ui-filter-new-filter")}},{key:"getAddPresetFieldInput",value:function(){return this.getAddPresetField().querySelector(".main-ui-filter-sidebar-edit-control")}},{key:"clearAddPresetFieldInput",value:function(){var t=this.getAddPresetFieldInput();e.Type.isDomNode(t)&&(t.value="")}},{key:"normalizePreset",value:function(t){return t.closest(".main-ui-filter-sidebar-item")}},{key:"deactivateAllPresets",value:function(){this.getPresets().forEach(function(t){e.Dom.removeClass(t,"main-ui-filter-current-item")})}},{key:"createSidebarItem",value:function(t,i,s){return BX.decl({block:"sidebar-item",text:e.Text.decode(i),id:t,pinned:s,noEditPinTitle:this.parent.getParam("MAIN_UI_FILTER__IS_SET_AS_DEFAULT_PRESET"),editNameTitle:this.parent.getParam("MAIN_UI_FILTER__EDIT_PRESET_TITLE"),removeTitle:this.parent.getParam("MAIN_UI_FILTER__REMOVE_PRESET"),editPinTitle:this.parent.getParam("MAIN_UI_FILTER__SET_AS_DEFAULT_PRESET"),dragTitle:this.parent.getParam("MAIN_UI_FILTER__DRAG_TITLE")})}},{key:"activatePreset",value:function(t){var i=this;this.deactivateAllPresets();var s=e.Type.isString(t)?i.getPresetNodeById(t):t;e.Type.isDomNode(s)&&e.Dom.addClass(s,"main-ui-filter-current-item")}},{key:"getPresetNodeById",value:function(t){return this.getPresets().find(function(i){return e.Dom.attr(i,"data-id")===t})}},{key:"getPresetId",value:function(t){return e.Dom.attr(t,"data-id")}},{key:"updatePresetName",value:function(t,i){if(e.Type.isDomNode(t)&&e.Type.isString(i)&&""!==i){var s=this.getPresetNameNode(t);e.Type.isDomNode(s)&&e.Runtime.html(s,i)}}},{key:"removePreset",value:function(t,e,i){var s=this.getCurrentPresetId(),n=[],a={preset_id:e,is_default:i},r={FILTER_ID:this.parent.getParam("FILTER_ID"),action:"REMOVE_FILTER"};this.parent.saveOptions(a,r),BX.remove(t),BX.type.isArray(this.parent.params.PRESETS)&&(n=this.parent.params.PRESETS.filter(function(t){return t.ID!==e},this),this.parent.params.PRESETS=n),BX.type.isArray(this.parent.editablePresets)&&(n=this.parent.editablePresets.filter(function(t){return t.ID!==e},this),this.parent.editablePresets=n),e===s&&(this.parent.getSearch().removePreset(),this.resetPreset())}},{key:"pinPreset",value:function(t){BX.type.isNotEmptyString(t)||(t="default_filter");var i=this.getPresetNodeById(t);if(!this.parent.getParam("VALUE_REQUIRED_MODE")||"default_filter"!==t){var s={FILTER_ID:this.parent.getParam("FILTER_ID"),GRID_ID:this.parent.getParam("GRID_ID"),action:"PIN_PRESET"},n={preset_id:t};this.getPresets().forEach(function(t){e.Dom.removeClass(t,this.parent.settings.classPinnedPreset)},this),BX.addClass(i,this.parent.settings.classPinnedPreset),this.parent.saveOptions(n,s)}}},{key:"_onPresetClick",value:function(t){var i,s,n,a,r,l,o;if(t.preventDefault(),l=(o=this.parent).settings,r=t.target,i=t.currentTarget,s=this.getPresetId(i),n=this.getPreset(s),e.Dom.hasClass(r,l.classPinButton)&&this.parent.isEditEnabled()&&(e.Dom.hasClass(i,l.classPinnedPreset)?this.pinPreset("default_filter"):this.pinPreset(s)),e.Dom.hasClass(r,l.classPresetEditButton)&&this.enableEditPresetName(i),e.Dom.hasClass(r,l.classPresetDeleteButton))return a="IS_DEFAULT"in n&&n.IS_DEFAULT,this.removePreset(i,s,a),!1;if(!e.Dom.hasClass(r,l.classPresetDragButton)&&!e.Dom.hasClass(r,l.classAddPresetFieldInput)){this.parent.isEditEnabled()&&this.updateEditablePreset(this.getCurrentPresetId());var u=this.getPreset(this.getCurrentPresetId()),c=this.getPreset(s);u.ADDITIONAL=[],c.ADDITIONAL=[],this.activatePreset(i),this.applyPreset(s),this.parent.isEditEnabled()||(o.applyFilter(null,!0),t.isTrusted&&o.closePopup(),o.isAddPresetEnabled()&&o.disableAddPreset())}}},{key:"applyPinnedPreset",value:function(){var t,e=this.parent,i=this.isPinned(this.getCurrentPresetId());if(this.parent.getParam("VALUE_REQUIRED")&&"default_filter"===this.getPinnedPresetId())this.applyPreset("default_filter"),this.deactivateAllPresets(),t=this.parent.applyFilter();else if(i)t=e.resetFilter();else{var s=this.getPinnedPresetId(),n=this.getPinnedPresetNode();this.deactivateAllPresets(),this.activatePreset(n),this.applyPreset(s),t=e.applyFilter(!1,!0),e.closePopup()}return t}},{key:"updateEditablePreset",value:function(t){var e=this.parent.getFilterFieldsValues(),i=this.getFields().map(function(t){return BX.data(t,"name")}),s=this.parent.preparePresetFields(e,i),n=this.getPreset(t);n.FIELDS=s,n.TITLE=this.getPresetInput(this.getPresetNodeById(t)).value,n.ROWS=i}},{key:"getPresetInput",value:function(t){return BX.Filter.Utils.getByClass(t,this.parent.settings.classPresetEditInput)}},{key:"enableEditPresetName",value:function(t){var i=this.getPresetInput(t);BX.addClass(t,this.parent.settings.classPresetNameEdit),i.focus(),i.value=BX.util.htmlspecialcharsback(i.value),e.Event.bind(i,"input",BX.delegate(this._onPresetNameInput,this))}},{key:"_onPresetNameInput",value:function(t){var e=this.parent.getSearch(),i=t.currentTarget.value,s=BX.findParent(t.currentTarget,{className:this.parent.settings.classPreset},!0,!1),n=this.getPresetId(s),a={ID:n,TITLE:i};n===this.getCurrentPresetId()&&e.updatePreset(a)}},{key:"getPresetNameNode",value:function(t){return BX.Filter.Utils.getByClass(t,this.parent.settings.classPresetName)}},{key:"disableEditPresetName",value:function(t){var i=this.getPresetInput(t);e.Dom.removeClass(t,this.parent.settings.classPresetNameEdit),BX.type.isDomNode(i)&&(i.blur(),BX.unbind(i,"input",BX.delegate(this._onPresetNameInput,this)))}},{key:"getPreset",value:function(t,e){var i=this.parent.getParam(e?"DEFAULT_PRESETS":"PRESETS",[]);this.parent.isEditEnabled()&&!e&&(i=this.parent.editablePresets);var s=i.filter(function(e){return e.ID===t});if("tmp_filter"===t&&!s.length){var n=BX.clone(this.getPreset("default_filter"));n.ID="tmp_filter",i.push(n),s.push(n)}return 0!==s.length?s[0]:null}},{key:"getPresetField",value:function(t,e){var i=this.getPreset(t),s=null;return BX.type.isPlainObject(i)&&"FIELDS"in i&&BX.type.isArray(i.FIELDS)&&(s=(s=i.FIELDS.filter(function(t){return t.NAME===e})).length?s[0]:null),s}},{key:"applyPreset",value:function(t,e){t=e?"default_filter":t||"default_filter";var i=this.getPreset(t);"default_preset"!==t&&(i=this.extendPreset(i)),this.parent.getSearch().updatePreset(i),this.updatePresetFields(i,e)}},{key:"extendPreset",value:function(t){var e=BX.clone(this.getPreset("default_filter"));return BX.type.isPlainObject(t)&&((t=BX.clone(t)).FIELDS.forEach(function(t){var i,s=e.FIELDS.some(function(e,s){var n=!1;return e.NAME===t.NAME&&(i=s,n=!0),n},this);s&&i||s&&0===i?e.FIELDS[i]=t:this.isEmptyField(t)||e.FIELDS.push(t)},this),t.FIELDS=e.FIELDS),t}},{key:"isEmptyField",value:function(t){var e=!0;if(t.TYPE===this.parent.types.STRING&&t.VALUE&&t.VALUE.length&&(e=!1),t.TYPE===this.parent.types.SELECT&&BX.type.isPlainObject(t.VALUE)&&"VALUE"in t.VALUE&&t.VALUE.VALUE&&(e=!1),t.TYPE===this.parent.types.MULTI_SELECT&&BX.type.isArray(t.VALUE)&&t.VALUE.length&&(e=!1),t.TYPE===this.parent.types.CUSTOM_DATE&&(BX.type.isArray(t.VALUE.days)&&t.VALUE.days.length||BX.type.isArray(t.VALUE.months)&&t.VALUE.months.length||BX.type.isArray(t.VALUE.years)&&t.VALUE.years.length)&&(e=!1),t.TYPE!==this.parent.types.CUSTOM_ENTITY&&t.TYPE!==this.parent.types.DEST_SELECTOR||BX.type.isPlainObject(t.VALUES)&&(BX.type.isNotEmptyString(t.VALUES._label)&&BX.type.isNotEmptyString(t.VALUES._value)&&(e=!1),BX.type.isPlainObject(t.VALUES._label)&&BX.type.isPlainObject(t.VALUES._value)&&Object.keys(t.VALUES._label).length&&Object.keys(t.VALUES._value).length&&(e=!1),BX.type.isArray(t.VALUES._label)&&BX.type.isArray(t.VALUES._value)&&t.VALUES._label.length&&t.VALUES._value.length&&(e=!1),(BX.type.isArray(t.VALUES._label)&&t.VALUES._label.length||BX.type.isPlainObject(t.VALUES._label)&&Object.keys(t.VALUES._label).length)&&(BX.type.isArray(t.VALUES._value)&&t.VALUES._value.length||BX.type.isPlainObject(t.VALUES._value)&&Object.keys(t.VALUES._value).length)&&(e=!1)),t.TYPE===this.parent.types.DATE){var i="_datesel"in t.VALUES?t.VALUES._datesel:t.SUB_TYPE.VALUE;(BX.type.isPlainObject(t.VALUES)&&(t.VALUES._from||t.VALUES._to||t.VALUES._quarter||t.VALUES._month&&!BX.type.isArray(t.VALUES._month)||t.VALUES._year&&!BX.type.isArray(t.VALUES._year)||t.VALUES._days&&!BX.type.isArray(t.VALUES._days))||BX.type.isArray(t.VALUES._days)&&t.VALUES._days.length||BX.type.isArray(t.VALUES._month)&&t.VALUES._month.length||BX.type.isArray(t.VALUES._year)&&t.VALUES._year.length||i===this.parent.dateTypes.CURRENT_DAY||i===this.parent.dateTypes.CURRENT_WEEK||i===this.parent.dateTypes.CURRENT_MONTH||i===this.parent.dateTypes.CURRENT_QUARTER||i===this.parent.dateTypes.LAST_7_DAYS||i===this.parent.dateTypes.LAST_30_DAYS||i===this.parent.dateTypes.LAST_60_DAYS||i===this.parent.dateTypes.LAST_90_DAYS||i===this.parent.dateTypes.LAST_WEEK||i===this.parent.dateTypes.LAST_MONTH||i===this.parent.dateTypes.TOMORROW||i===this.parent.dateTypes.YESTERDAY||i===this.parent.dateTypes.NEXT_WEEK||i===this.parent.dateTypes.NEXT_MONTH)&&(e=!1)}return t.TYPE===this.parent.types.NUMBER&&BX.type.isPlainObject(t.VALUES)&&(t.VALUES._from||t.VALUES._to)&&(e=!1),t.TYPE===this.parent.types.CHECKBOX&&BX.type.isPlainObject(t.VALUE)&&t.VALUE.VALUE&&(e=!1),e}},{key:"resetPreset",value:function(t){this.applyPreset("",t)}},{key:"getFields",value:function(){var t=this.parent.getFieldListContainer(),e=null;return BX.type.isDomNode(t)&&(e=BX.Filter.Utils.getBySelector(t.parentNode,".".concat(this.parent.settings.classFileldControlList," > div"),!0)),e}},{key:"getField",value:function(t){var e,i,s=this.getFields(),n=null;return BX.type.isArray(s)&&s.length&&(n=(i=s.filter(function(i){return BX.type.isDomNode(i)&&(e=BX.data(i,"name")),e===t.NAME},this)).length>0?i[0]:null),n}},{key:"removeField",value:function(t,e){var i,s;if(e=e||!1,BX.type.isPlainObject(t)&&(s=t.NAME,t=this.getField(t),BX.type.isArray(this.parent.fieldsList)&&-1!==(i=this.parent.fieldsList.indexOf(t))&&delete this.parent.fieldsList[i],this.parent.unregisterDragItem(t)),BX.type.isDomNode(t)&&(s=BX.data(t,"name"),this.parent.getFields().deleteField(t)),!this.parent.isEditEnabled()&&!this.parent.isAddPresetEnabled()){var n=this.getCurrentPresetId(),a=this.getPresetField(n,s);a&&!this.isEmptyField(a)&&(this.deactivateAllPresets(),this.parent.applyFilter())}e||this.parent.saveFieldsSort()}},{key:"removeFields",value:function(t){t.forEach(function(t){this.removeField(t,!0)},this),this.parent.saveFieldsSort()}},{key:"addField",value:function(t){var e,i,s;if(BX.type.isPlainObject(t)&&(e=this.parent.getFieldListContainer(),s=this.parent.getControls(),i=BX.type.isArray(s)?s[s.length-1]:null,BX.type.isDomNode(i)?("INPUT"!==i.nodeName&&(i=BX.Filter.Utils.getByTag(i,"input")),BX.type.isDomNode(i)&&(t.TABINDEX=parseInt(i.getAttribute("tabindex"))+1)):t.TABINDEX=2,BX.type.isDomNode(e)&&(i=this.createControl(t),BX.type.isDomNode(i)&&(BX.append(i,e),BX.type.isArray(this.parent.fieldsList)&&this.parent.fieldsList.push(i),this.parent.registerDragItem(i)))),!this.parent.isEditEnabled()&&!this.parent.isAddPresetEnabled()){var n=this.getCurrentPresetId(),a=this.getPresetField(n,t.NAME);a&&!this.isEmptyField(a)&&(this.parent.updatePreset("tmp_filter"),this.deactivateAllPresets(),this.parent.getSearch().updatePreset(this.getPreset("tmp_filter")))}this.parent.saveFieldsSort()}},{key:"createControl",value:function(t){var e;switch(t.TYPE){case this.parent.types.STRING:e=this.parent.getFields().createInputText(t);break;case this.parent.types.TEXTAREA:e=this.parent.getFields().createTextarea(t);break;case this.parent.types.SELECT:e=this.parent.getFields().createSelect(t);break;case this.parent.types.MULTI_SELECT:e=this.parent.getFields().createMultiSelect(t);break;case this.parent.types.NUMBER:e=this.parent.getFields().createNumber(t);break;case this.parent.types.DATE:e=this.parent.getFields().createDate(t);break;case this.parent.types.CUSTOM_DATE:e=this.parent.getFields().createCustomDate(t);break;case this.parent.types.DEST_SELECTOR:e=this.parent.getFields().createDestSelector(t);break;case this.parent.types.CUSTOM:e=this.parent.getFields().createCustom(t);break;case this.parent.types.CUSTOM_ENTITY:e=this.parent.getFields().createCustomEntity(t)}if(BX.type.isDomNode(e)&&(e.dataset.name=t.NAME,e.FieldController=new BX.Filter.FieldController(e,this.parent),t.REQUIRED)){var i=e.querySelector(".main-ui-filter-field-delete");i&&BX.remove(i)}return e}},{key:"removeNotCompareVariables",value:function(t,e){if(BX.type.isPlainObject(t)){var i=this.parent.dateTypes,s=this.parent.additionalDateTypes;"FIND"in t&&delete t.FIND,e||Object.keys(t).forEach(function(e){if(-1!==e.indexOf("_numsel")&&delete t[e],-1!==e.indexOf("_datesel")){var n=t[e];n!==i.EXACT&&n!==i.RANGE&&n!==s.PREV_DAY&&n!==s.NEXT_DAY&&n!==s.MORE_THAN_DAYS_AGO&&n!==s.AFTER_DAYS&&n!==i.PREV_DAYS&&n!==i.NEXT_DAYS&&n!==i.YEAR&&n!==i.MONTH&&n!==i.QUARTER&&n!==i.NONE&&n!==i.CUSTOM_DATE||delete t[e]}var a=this.parent.getFieldByName(e);""!==t[e]||a&&a.STRICT||delete t[e]},this)}}},{key:"isPresetValuesModified",value:function(t){var e=this.getPreset(t),i=this.parent.preparePresetSettingsFields(e.FIELDS),s=this.parent.getFilterFieldsValues();this.removeNotCompareVariables(i),this.removeNotCompareVariables(s);var n=BX.Filter.Utils.sortObject(i),a=BX.Filter.Utils.sortObject(s);return!Object.keys(n).every(function(t){return n[t]===a[t]||(BX.type.isPlainObject(n[t])||BX.type.isArray(n[t]))&&BX.Filter.Utils.objectsIsEquals(n[t],a[t])})}},{key:"getAdditionalValues",value:function(t){var e=this.getPreset(t).FIELDS.filter(function(t){return!this.isEmptyField(t)},this),i=this.parent.preparePresetSettingsFields(e),s=this.parent.getFilterFieldsValues();return this.removeNotCompareVariables(i,!0),this.removeNotCompareVariables(s,!0),this.removeSameProperties(s,i),s}},{key:"removeSameProperties",value:function(t,e){BX.type.isPlainObject(t)&&BX.type.isPlainObject(e)&&Object.keys(e).forEach(function(e){e in t&&delete t[e]})}},{key:"removeAdditionalField",value:function(t){var e=this.getPreset(this.getCurrentPresetId());BX.type.isArray(e.ADDITIONAL)&&(e.ADDITIONAL=e.ADDITIONAL.filter(function(e){return e.NAME!==t}))}},{key:"updatePresetFields",value:function(t,e){var i,s,n=this,a=[];BX.type.isPlainObject(t)&&"FIELDS"in t&&(i=t.FIELDS,BX.type.isArray(t.ADDITIONAL)&&t.ADDITIONAL.filter(function(t){return n.parent.params.FIELDS.some(function(e){return t.NAME===e.NAME})}).forEach(function(t){var e=!1;t.IS_PRESET_FIELD=!0,i.forEach(function(s,n){t.NAME===s.NAME&&(i[n]=t,e=!0)}),e||i.push(t)}),(i||[]).filter(function(t){return n.parent.params.FIELDS.some(function(e){return t.NAME===e.NAME})}).forEach(function(t,i){if(t.TABINDEX=i+1,e)switch(t.TYPE){case this.parent.types.SELECT:t.VALUE=t.ITEMS[0];break;case this.parent.types.MULTI_SELECT:t.VALUE=[];break;case this.parent.types.DATE:t.SUB_TYPE=t.SUB_TYPES[0],t.VALUES={_from:"",_to:"",_days:""};break;case this.parent.types.CUSTOM_DATE:t.VALUE={days:[],months:[],years:[]};break;case this.parent.types.NUMBER:t.SUB_TYPE=t.SUB_TYPES[0],t.VALUES={_from:"",_to:""};break;case this.parent.types.CUSTOM_ENTITY:t.VALUES={_label:"",_value:""};break;case this.parent.types.CUSTOM:t._VALUE="";break;default:"VALUE"in t&&(BX.type.isArray(t.VALUE)?t.VALUE=[]:t.VALUE="")}a.push(this.createControl(t))},this),this.parent.disableFieldsDragAndDrop(),s=this.parent.getFieldListContainer(),BX.cleanNode(s),a.length&&(a.forEach(function(e,n){if(BX.type.isDomNode(e)&&("tmp_filter"===t.ID||"default_filter"===t.ID||"IS_PRESET_FIELD"in i[n]||this.isEmptyField(i[n])||BX.addClass(e,this.parent.settings.classPresetField),BX.append(e,s),BX.type.isString(i[n].HTML))){var a=BX.create("div");this.parent.getHiddenElement().appendChild(a),BX.html(a,i[n].HTML)}},this),this.parent.enableFieldsDragAndDrop()))}},{key:"showCurrentPresetFields",value:function(){var t=this.getCurrentPresetData();this.updatePresetFields(t)}},{key:"getCurrentPreset",value:function(){return BX.Filter.Utils.getByClass(this.getContainer(),this.parent.settings.classPresetCurrent)}},{key:"getCurrentPresetId",value:function(){var t=this.getCurrentPreset();return BX.type.isDomNode(t)?this.getPresetId(t):"tmp_filter"}},{key:"getCurrentPresetData",value:function(){var t=this.getCurrentPresetId(),e=null;return BX.type.isNotEmptyString(t)&&(e=this.getPreset(t),e=this.extendPreset(e)),e}},{key:"getContainer",value:function(){return BX.Filter.Utils.getByClass(this.parent.getFilter(),this.parent.settings.classPresetsContainer)}},{key:"getPresets",value:function(){return BX.Filter.Utils.getByClass(this.getContainer(),this.parent.settings.classPreset,!0)}},{key:"getDefaultPresets",value:function(){return BX.Filter.Utils.getByClass(this.getContainer(),this.parent.settings.classDefaultFilter,!0)}},{key:"getPinnedPresetNode",value:function(){return BX.Filter.Utils.getByClass(this.getContainer(),this.parent.settings.classPinnedPreset)}},{key:"isPinned",value:function(t){return this.getPinnedPresetId()===t}},{key:"getPinnedPresetId",value:function(){var t=this.getPinnedPresetNode(),e="default_filter";t&&(e=BX.data(t,"id")||e);return e}}]),t}();t.Field=n,t.Api=a,t.Fields=d,t.Presets=p}(this.BX.Filter=this.BX.Filter||{},BX);