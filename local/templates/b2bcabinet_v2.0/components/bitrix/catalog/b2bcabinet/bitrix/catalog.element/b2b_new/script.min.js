!function(t){"use strict";t.JCBlankZakazaDetail||(t.JCBlankZakazaDetail=function(t,e,i){this.DEBOUNCE_TIME=500,this.itemIds=i,this.arResult=t,this.arParams=e,this.itemId=t.ID,this.node=document.getElementById(this.itemId),this.productType=t.CATALOG_TYPE,this.nodesQuantity={wrapper:document.getElementById(i.QUANTITY),increment:document.getElementById(i.QUANTITY_INCREMENT),value:document.getElementById(i.QUANTITY_VALUE),decrement:document.getElementById(i.QUANTITY_DECREMENT)},this.quantityTrace="Y"===t.CATALOG_QUANTITY_TRACE,this.canBuyZero="Y"===t.CATALOG_CAN_BUY_ZERO,this.currentQuantity=parseFloat(t.ACTUAL_QUANTITY)||0,this.tmpQuantity=this.currentQuantity,this.maxQuantity=this.quantityTrace&&!this.canBuyZero?parseFloat(t.CATALOG_QUANTITY):Number.POSITIVE_INFINITY,this.minQuantity=0,this.measureRatio=parseFloat(t.CATALOG_MEASURE_RATIO?t.CATALOG_MEASURE_RATIO:t.ITEM_MEASURE_RATIOS.length>0?t.ITEM_MEASURE_RATIOS[t.ITEM_MEASURE_RATIO_SELECTED].RATIO:0),this.measureName=t.CATALOG_MEASURE_NAME?t.CATALOG_MEASURE_NAME:t.ITEM_MEASURE.TITLE,this.ranges=[],this.prices=t.PRINT_PRICES,this.delayAddToBasket=0,this.isOffersHidden=!0,BX.ready(BX.delegate(this.init,this))},t.JCBlankZakazaDetail.prototype={init:function(){if(this.initRanges(),this.initOffers(),"Y"!==this.arParams.CATALOG_NOT_AVAILABLE)if(3===parseInt(this.productType))for(let t in this.offers)this.initQuantity(this.getOfferQuantityPropsById(t));else this.initQuantity(this.getItemQuantityProps());BX.addCustomEvent("SidePanel.Slider:onMessage",(function(t){"BZI: ItemQuantityChanged"===t.eventId&&BX.onCustomEvent("BZD_ItemQuantityChanged",{id:t.data.itemId,quantity:t.data.quantity})}))},initRanges:function(){for(let t in this.prices)return void(this.ranges=Object.keys(this.prices[t]))},initOffers:function(){if(!Array.isArray(this.arResult.OFFERS)&&3!==parseInt(this.productType))return;this.offers={};this.arResult.OFFERS.forEach(function(t){const e=this.itemIds.OFFERS[t.ID];this.offers[t.ID]={id:t.ID,name:t.NAME,nodesQuantity:{wrapper:document.getElementById(e.QUANTITY),increment:document.getElementById(e.QUANTITY_INCREMENT),value:document.getElementById(e.QUANTITY_VALUE),decrement:document.getElementById(e.QUANTITY_DECREMENT)},currentQuantity:parseFloat(t.ACTUAL_QUANTITY),tmpQuantity:parseFloat(t.ACTUAL_QUANTITY),maxQuantity:"Y"===t.CATALOG_QUANTITY_TRACE&&"Y"!==t.CATALOG_CAN_BUY_ZERO?parseFloat(t.CATALOG_QUANTITY):Number.POSITIVE_INFINITY,minQuantity:0,measureRatio:parseFloat(t.CATALOG_MEASURE_RATIO?t.CATALOG_MEASURE_RATIO:t.ITEM_MEASURE_RATIOS?t.ITEM_MEASURE_RATIOS[t.ITEM_MEASURE_RATIO_SELECTED].RATIO:0),measureName:t.CATALOG_MEASURE_NAME,quantityTrace:"Y"===t.CATALOG_QUANTITY_TRACE,canBuyZero:"Y"===t.CATALOG_CAN_BUY_ZERO}}.bind(this))},initQuantity:function(e){if(null===e.nodes.wrapper)return;const i=e.nodes;t.addEventListener("message",(function(t){const n=JSON.parse(t.data);n.itemId&&n.quantity&&n.itemId===e.itemId&&(e.currentQuantity=parseFloat(n.quantity),e.tmpQuantity=e.currentQuantity,i.value.value=e.currentQuantity)})),i.increment.addEventListener("click",function(n){e.currentQuantity=e.tmpQuantity,e.tmpQuantity=parseFloat((e.tmpQuantity+e.measureRatio).toFixed(3)),e.tmpQuantity<=e.maxQuantity&&e.tmpQuantity>=e.minQuantity&&!isNaN(e.tmpQuantity)?(i.value.value=e.tmpQuantity,this.redrawPrices({id:e.itemId,count:e.tmpQuantity}),clearTimeout(e.delayAddToBasket),e.delayAddToBasket=setTimeout(function(){i.increment.setAttribute("disabled","disabled"),i.increment.firstElementChild.classList.add("spinner-grow"),this.addToBasket(e.itemId,e.tmpQuantity,e.measureRatio).then(function(n){BX.SidePanel?BX.SidePanel.Instance.postMessageTop(t,"addProductToBasketFromDetail",{id:e.itemId,quantity:e.tmpQuantity}):BX.onCustomEvent("OnBasketChange"),e.currentQuantity=parseFloat(n.data),e.tmpQuantity=e.currentQuantity,i.increment.removeAttribute("disabled"),i.increment.firstElementChild.classList.remove("spinner-grow"),i.value.value=e.currentQuantity;Array.prototype.slice.call(t.frames).forEach((function(t){t.postMessage(JSON.stringify({itemId:e.itemId,quantity:e.currentQuantity}),"*")})),0===e.currentQuantity?BX.onCustomEvent("B2BNotification",[BX.message("BZI_PRODUCT_NAME")+": "+e.name+"<br>"+BX.message("BZD_PRODUCT_REMOVE_FORM_BASKET"),"success"]):BX.onCustomEvent("B2BNotification",[BX.message("BZI_PRODUCT_NAME")+": "+e.name+"<br>"+BX.message("BZI_PRODUCT_ADD_TO_BASKET")+" "+e.currentQuantity+" "+e.measureName,"success"]),this.deleteRepaetNotification()}.bind(this),(function(t){let n=[];for(var a=0;a<t.errors.length;a++)n.push(t.errors[a].message);BX.onCustomEvent("B2BNotification",[n.join("<br>"),"alert"]),i.value.value=e.currentQuantity,i.increment.removeAttribute("disabled"),i.increment.firstElementChild.classList.remove("spinner-grow")}))}.bind(this),this.DEBOUNCE_TIME)):(n.target.value=e.currentQuantity,e.tmpQuantity=e.currentQuantity)}.bind(this)),i.decrement.addEventListener("click",function(n){e.currentQuantity=e.tmpQuantity,e.tmpQuantity=parseFloat((e.tmpQuantity-e.measureRatio).toFixed(3)),e.tmpQuantity<=e.maxQuantity&&e.tmpQuantity>=e.minQuantity&&!isNaN(e.tmpQuantity)?(i.value.value=e.tmpQuantity,this.redrawPrices({id:e.itemId,count:e.tmpQuantity}),clearTimeout(e.delayAddToBasket),e.delayAddToBasket=setTimeout(function(){i.decrement.setAttribute("disabled","disabled"),i.decrement.firstElementChild.classList.add("spinner-grow"),this.addToBasket(e.itemId,e.tmpQuantity,e.measureRatio).then(function(n){BX.SidePanel?BX.SidePanel.Instance.postMessageTop(t,"addProductToBasketFromDetail",{id:e.itemId,quantity:e.tmpQuantity}):BX.onCustomEvent("OnBasketChange"),e.currentQuantity=parseFloat(n.data),e.tmpQuantity=e.currentQuantity,i.decrement.removeAttribute("disabled"),i.decrement.firstElementChild.classList.remove("spinner-grow"),i.value.value=e.currentQuantity;Array.prototype.slice.call(t.frames).forEach((function(t){t.postMessage(JSON.stringify({itemId:e.itemId,quantity:e.currentQuantity}),"*")})),0===e.currentQuantity?BX.onCustomEvent("B2BNotification",[BX.message("BZI_PRODUCT_NAME")+": "+e.name+"<br>"+BX.message("BZD_PRODUCT_REMOVE_FORM_BASKET"),"success"]):BX.onCustomEvent("B2BNotification",[BX.message("BZI_PRODUCT_NAME")+": "+e.name+"<br>"+BX.message("BZI_PRODUCT_ADD_TO_BASKET")+" "+e.currentQuantity+" "+e.measureName,"success"]),this.deleteRepaetNotification()}.bind(this),(function(t){BX.onCustomEvent("B2BNotification",[t.error.map((function(t){return t.message})).join("<br>"),"alert"]),i.value.value=e.currentQuantity,i.decrement.removeAttribute("disabled"),i.decrement.firstElementChild.classList.remove("spinner-grow")}))}.bind(this),this.DEBOUNCE_TIME)):(n.target.value=e.currentQuantity,e.tmpQuantity=e.currentQuantity)}.bind(this)),i.value.addEventListener("input",function(n){e.tmpQuantity=""===n.target.value?0:n.target.value,e.tmpQuantity>e.maxQuantity&&(e.tmpQuantity=e.maxQuantity),e.tmpQuantity<=e.maxQuantity&&e.tmpQuantity>=e.minQuantity&&!isNaN(parseFloat(e.tmpQuantity))?(i.value.value=e.tmpQuantity,this.redrawPrices({id:e.itemId,count:e.tmpQuantity}),clearTimeout(e.delayAddToBasket),e.delayAddToBasket=setTimeout(function(){this.addToBasket(e.itemId,e.tmpQuantity,e.measureRatio).then(function(n){BX.SidePanel?BX.SidePanel.Instance.postMessageTop(t,"addProductToBasketFromDetail",{id:e.itemId,quantity:e.tmpQuantity}):BX.onCustomEvent("OnBasketChange"),e.currentQuantity=parseFloat(n.data),e.tmpQuantity=e.currentQuantity,i.value.value=e.currentQuantity,t.self!==t.top&&t.top.postMessage(JSON.stringify({itemId:e.itemId,quantity:e.currentQuantity}),"*"),0===e.currentQuantity?BX.onCustomEvent("B2BNotification",[BX.message("BZD_PRODUCT_NAME")+": "+e.name+"<br>"+BX.message("BZD_PRODUCT_REMOVE_FORM_BASKET"),"success"]):BX.onCustomEvent("B2BNotification",[BX.message("BZD_PRODUCT_NAME")+": "+e.name+"<br>"+BX.message("BZD_PRODUCT_ADD_TO_BASKET")+" "+e.currentQuantity+" "+e.measureName,"success"]),this.deleteRepaetNotification()}.bind(this),(function(t){}))}.bind(this),this.DEBOUNCE_TIME)):(n.target.value=e.currentQuantity,e.tmpQuantity=e.currentQuantity)}.bind(this))},addToBasket:function(t,e,i,n){const a=Math.round(1e6*e);return e=(a-a%Math.round(1e6*i))/1e6,BX.ajax.runAction("sotbit:b2bcabinet.basket.addProductToBasket",{data:{arFields:{PRODUCT_ID:t,QUANTITY:e,PROPS:n}}})},getItemQuantityProps:function(){return{itemId:this.itemId,name:this.arResult.NAME,nodes:this.nodesQuantity,currentQuantity:this.currentQuantity,tmpQuantity:this.tmpQuantity,maxQuantity:this.maxQuantity,minQuantity:this.minQuantity,measureRatio:this.measureRatio,measureName:this.measureName}},getOfferQuantityPropsById:function(t){const e=this.arResult.OFFERS;if(!Array.isArray(e))return{offerId:t,nodes:null,currentQuantity:null,tmpQuantity:null,maxQuantity:null,minQuantity:null};const i=this.offers[t],n=this.itemIds.OFFERS[t],a={wrapper:document.getElementById(n.QUANTITY),increment:document.getElementById(n.QUANTITY_INCREMENT),value:document.getElementById(n.QUANTITY_VALUE),decrement:document.getElementById(n.QUANTITY_DECREMENT)};return{itemId:t,name:i.name,nodes:a,currentQuantity:i.currentQuantity,tmpQuantity:i.tmpQuantity,maxQuantity:i.maxQuantity,minQuantity:i.minQuantity,measureRatio:i.measureRatio,measureName:i.measureName}},redrawPrices:function(t){if(t.id&&t.count)if(t.id===this.itemId){if(this.arResult.ITEM_QUANTITY_RANGES.hasOwnProperty("ZERO-INF"))return;const e=this.arResult.ITEM_QUANTITY_RANGES;let i=this.arResult.ITEM_QUANTITY_RANGE_SELECTED;for(let n in e)t.count>=(""===e[n].QUANTITY_FROM?Number.NEGATIVE_INFINITY:e[n].QUANTITY_FROM)&&t.count<=(""===e[n].QUANTITY_TO?Number.POSITIVE_INFINITY:e[n].QUANTITY_TO)&&(i=n);for(let t in this.itemIds.PRICES){let e=document.getElementById(this.itemIds.PRICES[t]);if(e&&"PRIVATE_PRICE"!==t){let n=this.arResult.PRINT_PRICES[t];n.hasOwnProperty(i)?e.innerHTML=n[i].PRINT:e.innerHTML=""}}}else{if(!this.itemIds.OFFERS.hasOwnProperty(t.id))return;let e=0;const i=this.arResult.OFFERS.filter(function(i,n){return i.ID==t.id&&(e=n,!0)}.bind(this))[0],n=i.ITEM_QUANTITY_RANGES;let a=i.ITEM_QUANTITY_RANGE_SELECTED;for(let e in n)t.count>=(""===n[e].QUANTITY_FROM?Number.NEGATIVE_INFINITY:n[e].QUANTITY_FROM)&&t.count<=(""===n[e].QUANTITY_TO?Number.POSITIVE_INFINITY:n[e].QUANTITY_TO)&&(a=e);for(let t in this.itemIds.OFFERS[i.ID].PRICES){let n=document.querySelector(`#${this.itemIds.OFFERS[i.ID].PRICES[t]} .bzd-prices__item-value`);if(n&&"PRIVATE_PRICE"!==t){let i=this.arResult.OFFERS[e].PRINT_PRICES[t];i.hasOwnProperty(a)?n.innerHTML=i[a].PRINT:n.innerHTML=""}}}},deleteRepaetNotification:function(){document.querySelectorAll(".b2b-notifications__item").length>1&&document.querySelector(".b2b-notifications__item").remove()}})}(window);