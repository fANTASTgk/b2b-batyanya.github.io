!function(){var e=window.BX;if(!e.MFInput){var t,i={},a=((t=function(t){try{this.params=t,this.controller=e("mfi-"+t.controlId),this.button=e("mfi-"+t.controlId+"-button"),this.editor=null,e("mfi-"+t.controlId+"-editor")&&(this.editor=new e.AvatarEditor({enableCamera:t.enableCamera}),e.addCustomEvent(this.editor,"onApply",e.delegate(this.addFile,this)),e.bind(e("mfi-"+t.controlId+"-editor"),"click",e.delegate(this.editor.click,this.editor))),this.init(t),i[t.controlId]=this,this.template=e.message("MFI_THUMB2").replace("#input_name#",this.params.inputName),window["FILE_INPUT_"+t.controlId]=this,this.INPUT=e("file_input_"+t.controlId)}catch(t){e.debug(t)}}).prototype={init:function(t){this.agent=e.Uploader.getInstance({id:t.controlId,CID:t.controlUid,streams:1,uploadFormData:"N",uploadMethod:"immediate",uploadFileUrl:t.urlUpload,allowUpload:t.allowUpload,allowUploadExt:t.allowUploadExt,uploadMaxFilesize:t.uploadMaxFilesize,showImage:!1,sortItems:!1,input:e("file_input_"+t.controlId),dropZone:this.controller.parentNode,placeHolder:this.controller,fields:{thumb:{tagName:"",template:e.message("MFI_THUMB")}}}),this.fileEvents={onFileIsAppended:this.onFileIsAppended.bind(this),onFileIsBound:this.onFileIsBound.bind(this),onUploadStart:this.onUploadStart.bind(this),onUploadProgress:this.onUploadProgress.bind(this),onUploadDone:this.onUploadDone.bind(this),onUploadError:this.onUploadError.bind(this)},e.addCustomEvent(this.agent,"onAttachFiles",e.delegate(this.onAttachFiles,this)),e.addCustomEvent(this.agent,"onQueueIsChanged",e.delegate(this.onQueueIsChanged,this)),e.addCustomEvent(this.agent,"onFileIsInited",e.delegate(this.onFileIsInited,this)),e.addCustomEvent(this.agent,"onPackageIsInitialized",e.delegate((function(e){var t,i={mfi_mode:"upload",cid:this.agent.CID,moduleId:this.params.moduleId,forceMd5:this.params.forceMd5,allowUpload:this.agent.limits.allowUpload,allowUploadExt:this.agent.limits.allowUploadExt,uploadMaxFilesize:this.agent.limits.uploadMaxFilesize,mfi_sign:this.params.controlSign};for(t in i)i.hasOwnProperty(t)&&i[t]&&(e.post.data[t]=i[t],e.post.size+=(t+"").length+(i[t]+"").length)}),this));for(var i,a,n=[],s=[],o=e.findChildren(this.controller,{tagName:"LI"}),r=0;r<o.length;r++)i=e.findChild(o[r],{attribute:{"data-bx-role":"file-name"}},!0),a=e.findChild(o[r],{attribute:{"data-bx-role":"file-id"}},!0),i&&a&&(n.push({name:i.innerHTML,file_id:a.value}),s.push(o[r]));this.agent.onAttach(n,s),this.inited=!0,this.checkUploadControl()},checkUploadControl:function(){e(this.button)&&(this.params.maxCount>0&&this.params.maxCount<=this.agent.getItems().length?1==this.params.maxCount||this.button.setAttribute("disable","Y"):this.button.removeAttribute("disable"))},onQueueIsChanged:function(){this.params.maxCount>0&&this.checkUploadControl()},onAttachFiles:function(t){var i=!1;if(t&&!0===this.inited&&this.params.maxCount>0){if(1==this.params.maxCount&&t.length>0){for(;this.agent.getItems().length>0;)this.deleteFile(this.agent.getItems().getFirst(),!1);for(;t.length>1;)t.pop()}var a=this.params.maxCount-this.agent.getItems().length;for(a=a>0?a:0;t.length>a;)t.pop(),i=!0}return i&&this.onError("Too much files."),e.onCustomEvent(this,"onFileUploaderChange",[t,this]),t},onFileIsInited:function(t,i){for(var a in this.fileEvents)this.fileEvents.hasOwnProperty(a)&&e.addCustomEvent(i,a,this.fileEvents[a])},onFileIsAppended:function(e,t){var i=this.agent.getItem(e);this.bindEventsHandlers(i.node,t)},onFileIsBound:function(e,t){var i=this.agent.getItem(e);this.bindEventsHandlers(i.node,t)},bindEventsHandlers:function(t,i){var a,n=e.findChild(t,{attribute:{"data-bx-role":"file-delete"}},!0);if(n&&e.bind(n,"click",e.proxy((function(){this.deleteFile(i)}),this)),(n=e.findChild(t,{attribute:{"data-bx-role":"file-preview"}},!0))&&(n.removeAttribute("data-bx-role"),i.file.parentCanvas)){var s=e.UploaderUtils.scaleImage(i.file.parentCanvas,{width:100,height:100},"exact"),o=e.create("CANVAS",{props:{width:100,height:100}});n.appendChild(o),o.getContext("2d").drawImage(i.file.parentCanvas,s.source.x,s.source.y,s.source.width,s.source.height,0,0,s.destin.width,s.destin.height),i.canvas=o}i.file.parentCanvas=null,(n=e.findChild(t,{tagName:"A",attribute:{"data-bx-role":"file-name"}},!0))&&(this.editor&&((a=e.findChild(t,{tagName:"CANVAS"},!0))&&a||(a=e.findChild(t,{tagName:"IMG"},!0))&&a)?e.bind(n,"click",e.proxy((function(t){return e.PreventDefault(t),this.editor.showFile({name:n.innerHTML,tmp_url:n.href}),!1}),this)):"#"===n.getAttribute("href")&&e.bind(n,"click",e.proxy((function(t){return e.PreventDefault(t),!1}),this)))},addFile:function(e,t){e.name=e.name||"image.png",e.parentCanvas=t,this.agent.onAttach([e])},deleteFile:function(t){var i=!!t&&this.agent.getItem(t.id);if(i){t=i.item;var a,n=i.node;if(!0===t.file.justUploaded&&t.file.file_id>0){var s={fileID:t.file.file_id,sessid:e.bitrix_sessid(),cid:this.agent.CID,mfi_mode:"delete"};e.ajax.post(this.agent.uploadFileUrl,s)}else{var o=n.parentNode.parentNode,r=e.findChild(n,{tagName:"INPUT",attribute:{"data-bx-role":"file-id"}},!0);if(r){var l=r.name,d=r.value,h=l+"_del",p=this.agent.id+"_deleted[]";l.indexOf("[")>0&&(h=l.substr(0,l.indexOf("["))+"_del"+l.substr(l.indexOf("["))),a=e.create("INPUT",{props:{name:l,type:"hidden",value:d}}),o.appendChild(a);var u=e.create("INPUT",{props:{name:h,type:"hidden",value:d}});o.appendChild(u),u=e.create("INPUT",{props:{name:p,type:"hidden",value:d}}),o.appendChild(u)}}for(var g in this.fileEvents)this.fileEvents.hasOwnProperty(g)&&e.removeAllCustomEvents(t,g);e.unbindAll(n);var m=t.file?t.file.file_id:null;delete t.hash,t.deleteFile("deleteFile"),m&&(e.onCustomEvent(this,"onDeleteFile",[m,t,this]),e.onCustomEvent(this,"onFileUploaderChange",[[m],this]),a&&e.fireEvent(a,"change"))}},_deleteFile:function(){},clear:function(){for(;this.agent.getItems().length>0;)this.deleteFile(this.agent.getItems().getFirst(),!1)},onUploadStart:function(t){var i=this.agent.getItem(t.id).node;i&&e.addClass(i,"uploading")},onUploadProgress:function(t,i){i=Math.min(i,98);var a=t.id;t.__progressBarWidth||(t.__progressBarWidth=5),i>t.__progressBarWidth&&(t.__progressBarWidth=Math.ceil(i),t.__progressBarWidth=t.__progressBarWidth>100?100:t.__progressBarWidth,e("wdu"+a+"Progressbar")&&e.adjust(e("wdu"+a+"Progressbar"),{style:{width:t.__progressBarWidth+"%"}}),e("wdu"+a+"ProgressbarText")&&e.adjust(e("wdu"+a+"ProgressbarText"),{text:t.__progressBarWidth+"%"}))},onUploadDone:function(t,i){var a=this.agent.getItem(t.id).node,n=i.file;if(e(a)){e.removeClass(a,"uploading"),e.addClass(a,"saved");var s,o=this.template;for(var r in n.ext=t.ext.toLowerCase(),n.preview_url=t.canvas?t.canvas.toDataURL("image/png"):n.thumb_src??"",n.preview_url&&e.addClass(a,"image"),t.canvas=null,delete t.canvas,n)n.hasOwnProperty(r)&&(s=n[r],"size"===r.toLowerCase()?s=e.UploaderUtils.getFormattedSize(s,0):"name"===r.toLowerCase()&&(s=n.originalName),o=o.replace(new RegExp("#"+r.toLowerCase()+"#","gi"),e.util.htmlspecialchars(s)).replace(new RegExp("#"+r.toUpperCase()+"#","gi"),e.util.htmlspecialchars(s)));t.file.file_id=n.file_id,t.file.justUploaded=!0,t.name=n.originalName,a.innerHTML=o,this.bindEventsHandlers(a,t),this.params.inputName.indexOf("[")<0&&(e.remove(e.findChild(a.parentNode.parentNode,{tagName:"INPUT",attr:{name:this.params.inputName}},!1)),e.remove(e.findChild(a.parentNode.parentNode,{tagName:"INPUT",attr:{name:this.params.inputName+"_del"}},!1))),e.onCustomEvent(this,"onAddFile",[n.file_id,this,n,a]),e.onCustomEvent(this,"onUploadDone",[i.file,t,this]),e.fireEvent(e("file-"+n.file_id),"change")}else this.onUploadError(t,i,this.agent)},onUploadError:function(t,i,a){var n=this.agent.getItem(t.id).node,s=e.message("MFI_UPLOADING_ERROR");i&&i.error&&(s=i.error),e.removeClass(n,"uploading"),e.addClass(n,"error"),n.appendChild(e.create("DIV",{attrs:{className:"upload-file-error"},html:s})),e.onCustomEvent(this,"onErrorFile",[t.file,this])},onError:function(t,i,a){var n,s,o="Uploading error.",r=o;if(a)if(a.error&&"string"==typeof a.error)r=a.error;else if(a.message&&"string"==typeof a.message)r=a.message;else if(e.type.isArray(a.errors)&&a.errors.length>0){r=[];for(var l=0;l<a.errors.length;l++)"object"==typeof a.errors[l]&&a.errors[l].message&&r.push(a.errors[l].message);r.length<=0&&r.push("Uploading error."),r=r.join(" ")}for(s in t.files=t.files||{},t.files)t.files.hasOwnProperty(s)&&(n=this.agent.queue.items.getItem(s),this.onUploadError(n,{error:r},r!=o))}},t);e.MFInput={init:function(e){return new a(e)},get:function(e){return i[e]||null}}}}();