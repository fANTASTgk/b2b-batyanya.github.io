window.JCB2BExcelImport||(window.JCB2BExcelImport=function(t){this.siteId=t.siteId||"",this.componentPath=t.componentPath||"",this.parameters=t.parameters||"",this.templateSignsString=t.templateSignsString||"",this.filesInputName=t.inputName,this.modal=document.querySelector(t.modalSelector),this.form=document.querySelector(t.formSelector),this.btnSend=document.querySelector(t.btnSendSelector),this.formData={},this.resultBlock=document.querySelector(t.resultBlockSelector),this.errorBlock=document.querySelector(t.errorBlockSelector),this.modalSuccessFooter=document.querySelector(t.modalSuccessFooter),this.modalFooter=document.querySelector(t.modalFooter),this.subscribeChangeUploadedFiles(this);const e=new MutationObserver(function(t){for(let e of t)e.target.classList.contains("show")||this.closePopup()}.bind(this));this.modal&&document.body.appendChild(this.modal),e.observe(this.modal,{childList:!1,subtree:!1,characterDataOldValue:!0,attributeFilter:["class"]}),this.btnSend&&(BX.unbindAll(this.btnSend),BX.bind(this.btnSend,"click",BX.delegate(this.importFilesAction,this))),this.uploudFilesCounter=0},window.JCB2BExcelImport.prototype={importFilesAction:function(){if(this.showWait(),!this.checkFiles())return this.showError(BX.message("error_no_file")),void this.closeWait();BX.ajax.runComponentAction("sotbit:b2bcabinet.excel.import","importExcel",{signedParameters:this.parameters,mode:"class",data:{formData:this.formData,sotbit_set_site_template:this.templateSignsString}}).then(function(t){BX.onCustomEvent("UpdateQuantityOnRequest"),this.hideError(),this.resetForm(),this.form.style.display="none",this.resultBlock.innerHTML=t.data.html,this.modalFooter.style.display="none",this.modalSuccessFooter.style.display="flex",this.closeWait(),BX.onCustomEvent("OnBasketChange"),BX.Sale&&BX.Sale.BasketComponent&&BX.Sale.BasketComponent.sendRequest("recalculateAjax",{fullRecalculation:"Y"})}.bind(this),function(t){var e="";t.errors.forEach((function(t,o,s){e+=t.message+"\n"})),this.showError(e),this.closeWait()}.bind(this))},closePopup:function(){this.form.style.display="block",this.resetForm(),this.hideError(),this.resultBlock&&(this.resultBlock.innerHTML=""),this.modalSuccessFooter.style.display="none",this.modalFooter.style.display="flex"},resetForm:function(){var t=this.form.querySelectorAll(".del-but");if(t)for(var e=0;e<t.length;e++)t[e].click()},showWait:function(){this.btnSend.disabled=!0,this.btnSend.querySelector("i").setAttribute("class","spinner-grow me-2")},closeWait:function(){this.btnSend.disabled=!1,this.btnSend.querySelector("i").setAttribute("class","")},hideError:function(){this.errorBlock.textContent="",this.errorBlock.style.display="none"},showError:function(t){this.errorBlock.textContent=t,this.errorBlock.style.display="block"},checkFiles:function(){return this.formData=BX.ajax.prepareForm(this.form),this.formData.data[this.filesInputName]},subscribeChangeUploadedFiles:function(t){const e=document.querySelector(".file-placeholder-tbody");new MutationObserver((function(e){for(let o of e){let e=Array.prototype.slice.call(o.target.style).indexOf("display");o.target.classList.contains("files-storage")?t.uploudFilesCounter+=1:e>-1&&(t.uploudFilesCounter-=1)}t.uploudFilesCounter>0?t.btnSend.disabled=!1:t.btnSend.disabled=!0})).observe(e,{attributes:!0,subtree:!0})}});